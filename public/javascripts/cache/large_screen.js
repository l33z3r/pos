
(function($){function CSRFProtection(xhr){var token=$('meta[name="csrf-token"]').attr('content');if(token)xhr.setRequestHeader('X-CSRF-Token',token);}
if('ajaxPrefilter'in $)$.ajaxPrefilter(function(options,originalOptions,xhr){CSRFProtection(xhr)});else $(document).ajaxSend(function(e,xhr){CSRFProtection(xhr)});function fire(obj,name,data){var event=$.Event(name);obj.trigger(event,data);return event.result!==false;}
function handleRemote(element){var method,url,data,dataType=element.data('type')||($.ajaxSettings&&$.ajaxSettings.dataType);if(fire(element,'ajax:before')){if(element.is('form')){method=element.attr('method');url=element.attr('action');data=element.serializeArray();var button=element.data('ujs:submit-button');if(button){data.push(button);element.data('ujs:submit-button',null);}}else{method=element.data('method');url=element.attr('href');data=null;}
$.ajax({url:url,type:method||'GET',data:data,dataType:dataType,beforeSend:function(xhr,settings){if(settings.dataType===undefined){xhr.setRequestHeader('accept','*/*;q=0.5, '+settings.accepts.script);}
return fire(element,'ajax:beforeSend',[xhr,settings]);},success:function(data,status,xhr){element.trigger('ajax:success',[data,status,xhr]);},complete:function(xhr,status){element.trigger('ajax:complete',[xhr,status]);},error:function(xhr,status,error){element.trigger('ajax:error',[xhr,status,error]);}});}}
function handleMethod(link){var href=link.attr('href'),method=link.data('method'),csrf_token=$('meta[name=csrf-token]').attr('content'),csrf_param=$('meta[name=csrf-param]').attr('content'),form=$('<form method="post" action="'+href+'"></form>'),metadata_input='<input name="_method" value="'+method+'" type="hidden" />';if(csrf_param!==undefined&&csrf_token!==undefined){metadata_input+='<input name="'+csrf_param+'" value="'+csrf_token+'" type="hidden" />';}
form.hide().append(metadata_input).appendTo('body');form.submit();}
function disableFormElements(form){form.find('input[data-disable-with], button[data-disable-with]').each(function(){var element=$(this),method=element.is('button')?'html':'val';element.data('ujs:enable-with',element[method]());element[method](element.data('disable-with'));element.attr('disabled','disabled');});}
function enableFormElements(form){form.find('input[data-disable-with]:disabled, button[data-disable-with]:disabled').each(function(){var element=$(this),method=element.is('button')?'html':'val';if(element.data('ujs:enable-with'))element[method](element.data('ujs:enable-with'));element.removeAttr('disabled');});}
function allowAction(element){var message=element.data('confirm');return!message||(fire(element,'confirm')&&confirm(message));}
function requiredValuesMissing(form){var missing=false;form.find('input[name][required]').each(function(){if(!$(this).val())missing=true;});return missing;}
$('a[data-confirm], a[data-method], a[data-remote]').live('click.rails',function(e){var link=$(this);if(!allowAction(link))return false;if(link.data('remote')!=undefined){handleRemote(link);return false;}else if(link.data('method')){handleMethod(link);return false;}});$('form').live('submit.rails',function(e){var form=$(this),remote=form.data('remote')!=undefined;if(!allowAction(form))return false;if(requiredValuesMissing(form))return!remote;if(remote){handleRemote(form);return false;}else{setTimeout(function(){disableFormElements(form)},13);}});$('form input[type=submit], form input[type=image], form button[type=submit], form button:not([type])').live('click.rails',function(){var button=$(this);if(!allowAction(button))return false;var name=button.attr('name'),data=name?{name:name,value:button.val()}:null;button.closest('form').data('ujs:submit-button',data);});$('form').live('ajax:beforeSend.rails',function(event){if(this==event.target)disableFormElements($(this));});$('form').live('ajax:complete.rails',function(event){if(this==event.target)enableFormElements($(this));});})(jQuery);var showingDisplayButtonPasscodePromptPopup;var all_display_button_permissions;var display_button_passcode_permissions;var loyaltyCardCode="";var generatedBrowserSessionId=null;var browserSessionIdStorageKey="browser_session_id";$(function(){doGlobalInit();});function doGlobalInit(){if(!inMobileContext()){if(checkForFirefox()){if(checkForClueyPlugin()){if(checkForJSPrintSetupPlugin()){checkForUninstalledPrinters();}}}}
initUsers();$('a:not(.no_loading_div)').live("click",function(){var href=$(this).attr("href");if(href!=""&&href!='#'&&href.endsWith(".csv")&&href.endsWith(".txt")){showLoadingDiv();}});$('input[type=submit]').click(function(){showLoadingDiv()});if(inKioskMode()){registerDisallowRightClick();}else{if(showPrintFrame){$('#wrapper').height(1770);$('#body').height(1770);$('#printFrame').width(600).height(1800);$('#printFrame').css("overflow","scroll");}
$('body').css("overflow","scroll");}
initUIElements();initAdminTables();setFingerPrintCookie();if(isTouchDevice()){if(!inMobileContext()){initTouch();}
initTouchRecpts();$('div.item, div.page, div.button, div.small_button, div.employee_box, div.key, div.go_key, div.cancel_key, div.util_keypadkey, div.tab, div.grid_item, div.room_object').live('click',function(){eval($(this).data('onpress'));});}else{$('div.item, div.page, div.button, div.small_button, div.employee_box, div.key, div.go_key, div.cancel_key, div.util_keypadkey, div.tab, div.grid_item, div.room_object').live('mousedown',function(){eval($(this).data('onpress'));});}
initPressedCSS();renderMenuItemButtonDimensions();renderActiveTables();if(inMenuContext()){initMenu();initDallasKeyListeners();$(window).keySequenceDetector(loyaltyCardPrefix,function(){loyaltyCardCode="";$(window).bind('keypress',loyaltyCardListenerHandler);});initPreviousOrder();initSplitBillOrder();$('#menu_buttons_popup_anchor').CreateBubblePopup();$('#menu_buttons_popup_anchor').FreezeBubblePopup();lastSaleInfo=getLastSaleInfo();if(lastSaleInfo){setLoginReceipt(lastSaleInfo.title,lastSaleInfo.contentHTML)}
showInitialScreen();showScreenFromHashParams();}else if(inKitchenContext()){initKitchen();}
$("div#clock").clock({"calendar":"false","format":clockFormat,"timestamp":clueyTimestamp()});$("input,textarea").live("focus",function(event){if(typeof lastActiveElement!="undefined"){lastActiveElement.removeClass("focus");}
lastActiveElement=$(this);lastActiveElement.addClass("focus");var allowFocusElements=["num","scan_upc","description_input","price_change_new_price_input","stock_take_new_amount_input","room_number_input","customer_search_input"];var focusedElementId=lastActiveElement.attr("id");if($.inArray(focusedElementId,allowFocusElements)==-1){event=event||window.event
if(event.preventDefault){event.preventDefault()}else{event.returnValue=false}}});if(doBeep){initBeep();}
callHomePoll();generateBrowserSessionId();clueyScheduler();initTrainingModeFromCookie();}
function showTerminalSelectDialog(){if(typeof(outletTerminals)=="undefined"){return;}
if(showingTerminalSelectDialog){return;}
if(availableOutletTerminals.length==0){hideNiceAlert();showingTerminalSelectDialog=true;var title="Subscription Reached!";var message="You have only paid for "+outletTerminals.length+" terminal(s), which have all been assigned. You can create more terminals in the accounts section. Click OK to be redirected.";ModalPopups.Alert('niceAlertContainer',title,"<div id='nice_alert' class='nice_alert'>"+message+"</div>",{width:360,height:310,okButtonText:'Ok',onOk:"goTo(outletTerminalsURL);"});return;}
var dropdownMarkup="<select id='terminal_select_dropdown'>";for(i=0;i<availableOutletTerminals.length;i++){dropdownMarkup+="<option value='"+availableOutletTerminals[i].name+"'>"+availableOutletTerminals[i].name+"</option>";}
dropdownMarkup+="</select>";title="Please select a terminal:";var terminalSelectMarkup="<div id='nice_alert' class='nice_alert'>"+dropdownMarkup+"</div>";hideNiceAlert();ModalPopups.Alert('niceAlertContainer',title,terminalSelectMarkup,{width:360,height:200,okButtonText:'Ok',onOk:"terminalSelected()"});}
function terminalSelected(){var selectedTerminal=$('select#terminal_select_dropdown option:selected').val();linkTerminal(selectedTerminal);}
function showInitialScreen(){if(current_user_id==null){showLoginScreen();$('#menu_screen_shortcut_dropdown_container').hide();$('#clockincode_show').html("");$('#num').val("");}else{showMenuScreen();$('#nav_save_button').show();if(current_user_nickname!=null){$('#e_name').html(current_user_nickname);$('#e_name').show();}}}
var displayButtonForwardFunction;function doDisplayButtonPasscodePrompt(button_id,forwardFunction){closePreviousModifierDialog();if(display_button_passcode_permissions[button_id]){displayButtonForwardFunction=forwardFunction;if(!inMenuContext()){forwardFunction.call();return;}else if(inAdminContext()){showAdminDisplayButtonPasscodePromptPopup(button_id,forwardFunction);}else{checkMenuScreenForFunction();showDisplayButtonPasscodePromptPopup();}}else{forwardFunction.call();}}
function showAdminDisplayButtonPasscodePromptPopup(button_id,forwardFunction){$('#display_button_passcode').val('');toggleUtilKeyboard();showingDisplayButtonPasscodePromptPopup=true;$('#menu_buttons_popup_anchor').ShowBubblePopup({align:'center',innerHtml:"<div id='display_button_passcode_popup'><div id='header'>Enter Pass Code:</div>"+"<input type='text' id='display_button_passcode'/>"+clearHTML+"<div id='display_button_submit_passcode' class='button' onclick='displayButtonPasscodeEntered()'>Submit</div>"+"<div id='cancel_display_button_passcode_prompt' class='button' onclick='cancelDisplayButtonPasscodePromptPopup();return false;'>Cancel</div></div>",innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme'},false);$('#menu_buttons_popup_anchor').FreezeBubblePopup();popupId=$('#menu_buttons_popup_anchor').GetBubblePopupID();$('#'+popupId).find('#display_button_passcode').focus();}
function displayButtonPasscodeEntered(){enteredCode=$('#display_button_passcode').val();if(enteredCode==current_user_passcode){showingDisplayButtonPasscodePromptPopup=false;$('#display_button_passcode').val('');$('#display_button_passcode_show').html('');hideBubblePopup($('#menu_buttons_popup_anchor'));displayButtonForwardFunction.call();displayButtonForwardFunction=null;}else{setStatusMessage("Passcode Incorrect, try again!");$('#display_button_passcode').val('');$('#display_button_passcode_show').html('');}}
function showDisplayButtonPasscodePromptPopup(){$('#display_button_passcode').val('');$('#display_button_passcode_show').html('');showingDisplayButtonPasscodePromptPopup=true;$('#menu_buttons_popup_anchor').ShowBubblePopup({align:'center',innerHtml:"<div id='display_button_passcode_popup'><div id='header'>Enter Pass Code:</div>"+"<div id='display_button_passcode_show'></div>"+"<div id='display_button_submit_passcode' class='button' onclick='displayButtonPasscodeEntered()'>Submit</div>"+"<div id='cancel_display_button_passcode_prompt' class='button' onclick='cancelDisplayButtonPasscodePromptPopup();return false;'>Cancel</div></div>",innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme'},false);$('#menu_buttons_popup_anchor').FreezeBubblePopup();popupId=$('#menu_buttons_popup_anchor').GetBubblePopupID();registerPopupClickHandler($('#'+popupId).add('#till_keypad'),cancelDisplayButtonPasscodePromptPopup);}
function cancelDisplayButtonPasscodePromptPopup(){showingDisplayButtonPasscodePromptPopup=false;hideBubblePopup($('#menu_buttons_popup_anchor'));}
var roomScaleX;var roomScaleY;var currentSelectedRoom=-1;function initTableSelectScreen(){currentSelectedRoom=fetchLastRoomID(current_user_id);if($('#select_room_button_'+currentSelectedRoom).length==0){currentSelectedRoom=$('.room_graphic').first().data('room_id');}
doClickAButton($('#select_room_button_'+currentSelectedRoom));setSelectedTable();}
function setSelectedTable(){$('.room_graphic .label').removeClass("selected_table");$('#table_'+selectedTable).children('div.label').addClass("selected_table");}
function loadRoomGraphic(room_id){$('.room_name').removeClass("selected");$('#select_room_button_'+room_id).addClass("selected");currentSelectedRoom=room_id;$('#room_layout .room_graphic').hide();$('#room_graphic_'+room_id).show();room_grid_x_size=$('#room_graphic_'+room_id).data("grid_x_size");room_grid_y_size=$('#room_graphic_'+room_id).data("grid_y_size");room_grid_resolution=$('#room_graphic_'+room_id).data("room_grid_resolution");setScale(room_grid_resolution,room_grid_x_size,room_grid_y_size);setRoomObjectGridPositions();setSelectedTable();}
var maxGridSize=70;var minGridSize=30;function setScale(room_grid_resolution,room_grid_x_size,room_grid_y_size){scale=(maxGridSize-room_grid_resolution)+minGridSize;$('#room_layout').width(room_grid_x_size*scale);$('#room_layout').height(room_grid_y_size*scale);container_div_width=$('#room_layout').width();container_div_height=$('#room_layout').height();roomScaleX=container_div_width/room_grid_x_size;roomScaleY=container_div_height/room_grid_y_size;}
function setRoomObjectGridPositions(){$('.room_object').each(function(){ro=$(this);ro_image=ro.children('img');grid_x=ro.data("grid_x");grid_y=ro.data("grid_y");grid_x_size=ro.data("grid_x_size");grid_y_size=ro.data("grid_y_size");grid_x--;grid_y--;ro.css("margin-left",grid_x*roomScaleX);ro.css("margin-top",grid_y*roomScaleY);ro_image.width(grid_x_size*roomScaleX);ro_image.height(grid_y_size*roomScaleY);});}
function checkMenuScreenForFunction(){if(!currentScreenIsMenu()){showMenuScreen();return true;}
return false;}
function checkSalesInterfaceForFunction(button_id,forwardFunction){if(!inMenuContext()){setSalesScreenForwardFunction(button_id);goTo('/#screen=more_options');}else{forwardFunction.call();}}
function initAdminTables(){$('.admin_table thead tr th:first').addClass('first');$('.admin_table thead tr th:last').addClass('last');$('.admin_table tbody tr').each(function(){$(this).find('td:first').addClass('first')});$('.admin_table tbody tr').each(function(){$(this).find('td:last').addClass('last')});$('.admin_table tbody tr:odd').addClass('odd');}
function doScheduledTasks(){rollDate();testShowLicenceExpiredScreen();trySendOutstandingOrdersToServer();pingHome();checkForDuplicateBrowserSession();}
function cacheDownloadReset(){$('nav#main_nav').removeClass("cache_update");$('#cache_status').text("");$('#cache_status').hide();}
function cacheDownloadStarted(){$('nav#main_nav').addClass("cache_update");$('#cache_status').show();$('#cache_status').text("Cache DL: 0%");}
var currentTotalFinal=0;var currentOrderJSON;var tableSelectMenu=null;var menuScreenShortcutSelectMenu=null;var defaultShortcutDropdownText="Menu";var editItemPopupAnchor;var doAutoLoginAfterSync=false;var inSplitBillMode=false;var splitBillOrderFrom;var splitBillOrderTo;var splitBillTableNumber;var lastTableZeroOrder;var creditCardChargeCallback=null;var manualCoversPrompt=true;var inTrainingMode=false;var highlightedCover=true;var inCashOutMode=false;var cashOutKeypadString="";function initMenu(){initMenuScreenType();loadFirstMenuPage();currentMenuPage=1;currentMenuSubPageId=null;currentOrder=new Array();loadCurrentOrder();displayLastReceipt();initOptionButtons();var storedGlobalPriceLevel=retrieveStorageValue(globalPriceLevelKey);if(storedGlobalPriceLevel==null){storedGlobalPriceLevel=1;}else{storedGlobalPriceLevel=parseInt(storedGlobalPriceLevel);}
setGlobalPriceLevel(storedGlobalPriceLevel);if(!enableLoyaltyCardRedemption){$("#loyalty_payment_method_button").hide();}
setTimeout("menuRecptScroll()",1000);setTimeout(callForwardButtonFunction,500);}
function initMenuScreenNavItems(){$('#nav_save_button').show();$('#menu_screen_shortcut_dropdown_container').show();$('#e_name').show();if(current_user_id==clueyUserId){$('#nav_util_button_clear_reload').show();$('#nav_util_button_reset_timestamp').show();}else{$('#nav_util_button_clear_reload').hide();$('#nav_util_button_reset_timestamp').hide();}}
function callForwardButtonFunction(){var forwardFunctionButtonId=getRawCookie(salesInterfaceForwardFunctionCookieName);if(forwardFunctionButtonId!=null){doClickAButton($('#admin_screen_button_'+forwardFunctionButtonId));setRawCookie(salesInterfaceForwardFunctionCookieName,"",-365);}else{var codeToExecute=getRawCookie(salesInterfaceForwardJSExecuteCookieName);eval(codeToExecute);setRawCookie(salesInterfaceForwardJSExecuteCookieName,"",-365);}}
$(window).load(function(){tryDocumentLoadedLoadFirstMenuPage();});function initMenuScreenType(){if(menuScreenType==RESTAURANT_MENU_SCREEN){performScreenResolutionCSSMods();}else if(menuScreenType==RETAIL_MENU_SCREEN){$('#table_screen_button, #table_select_container').hide();$('#upc_code_lookup_container').show();$('#scan_upc').keyup(function(e){if(getEventKeyCode(e)==13){productScanned();}});setTimeout(function(){$('#scan_upc').focus();scanFocusPoll();},1000);}else if(menuScreenType==CUSTOMER_MENU_SCREEN){performCustomerScreenCSSMods();}}
function setGlobalPriceLevel(priceLevel){if(globalPriceLevel!=null){var oldSelectedPriceLeveLiEl=$('#menu_screen_shortcut_dropdown li[rel=2-'+globalPriceLevel+']');oldSelectedPriceLeveLiEl.html(oldSelectedPriceLeveLiEl.html().substring(2));}
var selectedPriceLevelLiEl=$('#menu_screen_shortcut_dropdown li[rel=2-'+priceLevel+']');selectedPriceLevelLiEl.html("* "+selectedPriceLevelLiEl.html());globalPriceLevel=parseInt(priceLevel);storeKeyValue(globalPriceLevelKey,globalPriceLevel);}
function scanFocusPoll(){if(lastActiveElement.attr("id")=="scan_upc"){$('#scan_upc').focus();setTimeout(scanFocusPoll,1000);return;}}
function sendCursorToEnd(obj){var value=obj
var message="";if(value!=""){message=value+"\n";};$(obj).focus().val(message);}
function initPreviousOrder(){if(havePreviousOrder(current_user_id)){selectedTable=previousOrderTableNum;$('#previous_order_select_item').show();tableSelectMenu.setValue(previousOrderTableNum);doSelectTable(previousOrderTableNum);getTableOrderFromStorage(current_user_id,previousOrderTableNum)
previousTableOrder=tableOrders[previousOrderTableNum];serviceCharge=parseFloat(previousTableOrder.service_charge);paymentMethod=previousTableOrder.payment_method;cashback=parseFloat(previousTableOrder.cashback);tables[previousOrderTableNum]={id:'-1',label:previousTableOrder.table_info_label};}}
function initSplitBillOrder(){if(haveSplitBillOrder(current_user_id)){$('#split_bill_select_item').show();}}
function menuScreenKeypadClick(val){if(showingDisplayButtonPasscodePromptPopup){$('#display_button_passcode').val($('#display_button_passcode').val()+val);$('#display_button_passcode_show').html($('#display_button_passcode_show').html()+"*");}else if(inStockTakeMode){$('#stock_take_new_amount_input').val($('#stock_take_new_amount_input').val()+val);}else if(inCashOutMode){cashOutKeypadString+=val;currentCashOutAmount=cashOutKeypadString;$('#cash_out_amount').html(currency(cashOutKeypadString/100.0));}else if(inPriceChangeMode){$('#price_change_new_price_input').val($('#price_change_new_price_input').val()+val);}else if(menuScreenType==RETAIL_MENU_SCREEN){$('#scan_upc').val($('#scan_upc').val()+val);}else{closePreviousModifierDialog();if(this.innerHTML=='0'){if(currentMenuItemQuantity.length>0)
currentMenuItemQuantity+=val}else{if(currentMenuItemQuantity.indexOf(".")!=-1){if(currentMenuItemQuantity.length-currentMenuItemQuantity.indexOf(".")>1){return;}}
currentMenuItemQuantity+=val;}}
$('#menu_screen_input_show').html(currentMenuItemQuantity);}
function menuScreenKeypadClickCancel(){if(inCashOutMode){cashOutAmountCancelClicked();}else if(inStockTakeMode){$('#stock_take_new_amount_input').val("");}else if(inPriceChangeMode){$('#price_change_new_price_input').val("");}else if(menuScreenType==RETAIL_MENU_SCREEN){$('#scan_upc').val("");}else{if(menuItemDoubleMode){setMenuItemDoubleMode(false);}else if(menuItemHalfMode){setMenuItemHalfMode(false);}
if(menuItemStandardPriceOverrideMode){setMenuItemStandardPriceOverrideMode(false);}
currentMenuItemQuantity="";}
$('#menu_screen_input_show').html(currentMenuItemQuantity);}
function menuScreenKeypadClickDecimal(){if(inCashOutMode){return;}else if(inStockTakeMode){$('#stock_take_new_amount_input').val($('#stock_take_new_amount_input').val()+".");}else if(inPriceChangeMode){$('#price_change_new_price_input').val($('#price_change_new_price_input').val()+".");}else{if(currentMenuItemQuantity.indexOf(".")==-1){currentMenuItemQuantity+=".";}}
$('#menu_screen_input_show').html(currentMenuItemQuantity);}
function tryDocumentLoadedLoadFirstMenuPage(){if(inMenuContext()){doMenuPageSelect(currentMenuPage,currentMenuPageId);}}
function loadFirstMenuPage(){eval($('#pages .page:first').data('onpress'));}
function doMenuPageSelect(pageNum,pageId){if(currentSelectedMenuItemElement){$(currentSelectedMenuItemElement).HideBubblePopup();$(currentSelectedMenuItemElement).FreezeBubblePopup();}
$('#pages .page').removeClass('selected');$('#menu_page_'+pageId).addClass('selected');newHTML=$('#menu_items_'+pageNum).html();$('#menu_items_container').html(newHTML);currentMenuPage=pageNum;currentMenuPageId=pageId;currentMenuSubPageId=null;eval($('.embedded_pages_'+pageNum+' div:first').data('onpress'));if(inStockTakeMode){loadStockDivs(pageNum,currentMenuSubPageId);}else if(inPriceChangeMode){loadPriceDivs(pageNum,currentMenuSubPageId);}}
function doSubMenuPageSelect(parentPageNum,pageId){if(currentSelectedMenuItemElement){$(currentSelectedMenuItemElement).HideBubblePopup();$(currentSelectedMenuItemElement).FreezeBubblePopup();}
$('#pages .subpage').removeClass('selected');$('div[id=sub_menu_page_'+pageId+"]").addClass('selected');newHTML=$('#sub_menu_items_'+pageId).html();$('div[id=sub_menu_items_'+parentPageNum+'_container]').html(newHTML);currentMenuPage=parentPageNum;currentMenuPageId=pageId;currentMenuSubPageId=pageId;if(inStockTakeMode){loadStockDivs(parentPageNum,pageId);}else if(inPriceChangeMode){loadPriceDivs(parentPageNum,pageId);}}
function productScanned(){var upc=$('#scan_upc').val();if(upc.length==0){setStatusMessage("Please enter product code, or use barcode scanner");return;}
var scannedProduct=products_by_upc[upc];if(typeof(scannedProduct)!='undefined'){doSelectMenuItem(scannedProduct.id,null,null)
$('#scan_upc').val("");}else{niceAlert("Product not found... UPC:"+upc);}}
function doSelectMenuItem(productId,menuItemId,element){if(!ensureLoggedIn()){return;}
currentOrder=getCurrentOrder();var productToCopy=products[productId];var copiedProduct={};var product=$.extend(true,copiedProduct,productToCopy);if(menuItemDoubleMode&&(product.double_price==0)){niceAlert("Price has not been set for a double of this item.");setMenuItemDoubleMode(false);return;}
if(menuItemHalfMode&&(product.half_price==0)){niceAlert("Price has not been set for a half of this item.");setMenuItemHalfMode(false);return;}
if(inStockTakeMode){loadStockTakeReceiptArea(productId,menuItemId);return;}else if(inPriceChangeMode){loadPriceChangeReceiptArea(productId,menuItemId);return;}else if(productInfoPopupMode){popupProductInfo(productId);return;}
if(currentMenuItemQuantity==""||currentMenuItemQuantity=="0")
currentMenuItemQuantity="1";if(currentMenuItemQuantity.indexOf(".")!=-1){if(currentMenuItemQuantity.length-currentMenuItemQuantity.indexOf(".")==1){currentMenuItemQuantity="1";}}
closePreviousModifierDialog();currentSelectedMenuItemElement=element;closeEditOrderItem();amount=currentMenuItemQuantity;clearMenuScreenInput();buildOrderItem(product,amount);setModifierGridIdForProduct(product);modifierCategoryId=product['modifier_category_id'];if(modifierCategoryId){showModifierDialog(modifierCategoryId);return;}
finishDoSelectMenuItem();}
function showModifierDialog(modifierCategoryId){boxEl=$(currentSelectedMenuItemElement);if(!boxEl.HasBubblePopup()){boxEl.CreateBubblePopup();}
popupHTML=$("#modifier_category_popup_"+modifierCategoryId).html();boxEl.ShowBubblePopup({align:'center',innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme'},false);boxEl.FreezeBubblePopup();popupId=boxEl.GetBubblePopupID();registerPopupClickHandler($('#'+popupId),function(){boxEl.HideBubblePopup()});}
function closePreviousModifierDialog(){if(currentSelectedMenuItemElement){hideBubblePopup($(currentSelectedMenuItemElement));}}
function noModifierSelected(){$(currentSelectedMenuItemElement).HideBubblePopup();$(currentSelectedMenuItemElement).FreezeBubblePopup();finishDoSelectMenuItem();}
function modifierSelected(modifierId,modifierName,modifierPrice){currentOrderItem['modifier']={'id':modifierId,'name':modifierName,'price':modifierPrice}
if(currentOrderItem.pre_discount_price){currentOrderItem.pre_discount_price=currentOrderItem.pre_discount_price+(currentOrderItem['amount']*modifierPrice);}else{currentOrderItem['total_price']=currentOrderItem['total_price']+(currentOrderItem['amount']*modifierPrice);}
$(currentSelectedMenuItemElement).HideBubblePopup();$(currentSelectedMenuItemElement).FreezeBubblePopup();finishDoSelectMenuItem();}
function finishDoSelectMenuItem(){var orderItem=currentOrderItem;if(selectedTable!=0){tableSelectMenuItem(orderItem);return;}
addItemToOrderAndSave(orderItem);loadReceipt(currentOrder,false);currentSelectedReceiptItemEl=$('#till_roll div[data-item_number='+currentOrderItem.itemNumber+']');currentSelectedReceiptItemEl.addClass("selected");testForPricePrompt(orderItem);setTimeout(menuRecptScroll,20);testForMandatoryModifier(orderItem.product);}
function tableSelectMenuItem(orderItem){addItemToTableOrderAndSave(orderItem);loadReceipt(currentOrder,false);currentSelectedReceiptItemEl=$('#till_roll div[data-item_number='+currentOrderItem.itemNumber+']');currentSelectedReceiptItemEl.addClass("selected");testForPricePrompt(orderItem);setTimeout(menuRecptScroll,20);testForMandatoryModifier(orderItem.product);}
function testForPricePrompt(orderItem){if(orderItem.product.prompt_price){var popupEl=doSelectReceiptItem(getSelectedOrLastReceiptItem());popupEl.find('#discount_button').hide();popupEl.find('#delete_button').hide();popupEl.find('#oia_button').hide();popupEl.find('#transfer_button').hide();popupEl.find('#quantity_editor').hide();popupEl.find('#course_button').hide();popupEl.find('#void_order_item_button').hide();popupEl.find('#header').html("Enter A Price");popupEl.find('#current_selected_receipt_item_price').focus();popupEl.find('#current_selected_receipt_item_price').val("");}}
function getAllOrderItemsReceiptHTML(order,includeNonSyncedStyling,includeOnClick,includeServerAddedText){allOrderItemsReceiptHTML="";for(var i=0;i<order.items.length;i++){item=order.items[i];allOrderItemsReceiptHTML+=getOrderItemReceiptHTML(order.items[i],includeNonSyncedStyling,includeOnClick,includeServerAddedText);}
return allOrderItemsReceiptHTML;}
function getOrderItemReceiptHTML(orderItem,includeNonSyncedStyling,includeOnClick,includeServerAddedText){if(typeof includeNonSyncedStyling=="undefined"){includeNonSyncedStyling=true;}
if(typeof includeOnClick=="undefined"){includeOnClick=true;}
if(typeof includeServerAddedText=="undefined"){includeServerAddedText=true;}
haveDiscount=orderItem.discount_percent&&orderItem.discount_percent>0;itemPriceWithoutDiscountOrModifier=orderItem.amount*orderItem.product_price;if(haveDiscount){itemPriceWithoutModifier=itemPriceWithoutDiscountOrModifier-((itemPriceWithoutDiscountOrModifier*orderItem.discount_percent)/100);}else{itemPriceWithoutModifier=itemPriceWithoutDiscountOrModifier;}
notSyncedClass=(includeNonSyncedStyling&&!orderItem.synced)?"not_synced":"";notSyncedMarker=(includeNonSyncedStyling&&!orderItem.synced)?"*":"";onclickMarkup=includeOnClick?"onclick='doSelectReceiptItem(this)'":"";var courseLineClass=orderItem.is_course?"course":"";var hideOnPrintedReceiptClass=orderItem.product.hide_on_printed_receipt?"hide_on_printed_receipt":"";var voidClass=orderItem.is_void?"void":"";orderHTML="<div class='order_line "+notSyncedClass+" "+voidClass+" "+hideOnPrintedReceiptClass+" "+courseLineClass+"' data-item_number='"+orderItem.itemNumber+"' "+onclickMarkup+">";if(includeServerAddedText&&orderItem.showServerAddedText){var nickname=serverNickname(orderItem.serving_employee_id);var timeAdded=utilFormatTime(new Date(parseInt(orderItem.time_added)));var showAddedLine=(orderItem.itemNumber!=1);orderHTML+="<div class='server "+(showAddedLine?"added_line":"")+"'>At "+timeAdded+" "+nickname+" added:</div>";}
orderHTML+="<div class='amount'>"+orderItem.amount+"</div>";orderHTML+="<div class='name' data-course_num='"+orderItem.product.course_num+"'>"+notSyncedMarker+" ";if(orderItem.is_double){orderHTML+="Double ";}else if(orderItem.is_half){orderHTML+=halfMeasureLabel+" ";}
orderHTML+=orderItem.product.name+"</div>";orderItemTotalPriceText=number_to_currency(itemPriceWithoutModifier,{precision:2});orderHTML+="<div class='total' data-per_unit_price='"+orderItem.product_price+"'>"+(orderItem.product.show_price_on_receipt?orderItemTotalPriceText:"")+"</div>";if(orderItem.show_course_label){orderHTML+="<div class='clear'>&nbsp;</div>";orderHTML+="<div class='course_label'>Serve As "+courseLabels[parseInt(orderItem.product.course_num)]+"</div>";}
if(orderItem.modifier){orderHTML+="<div class='clear'>&nbsp;</div>";orderHTML+="<div class='modifier_name'>"+orderItem.modifier.name+"</div>";modifierPriceWithoutDiscount=orderItem.modifier.price*orderItem.amount;if(haveDiscount){modifierPrice=modifierPriceWithoutDiscount-((modifierPriceWithoutDiscount*orderItem.discount_percent)/100);}else{modifierPrice=modifierPriceWithoutDiscount;}
if(orderItem.modifier.price>0){modifierPriceText=number_to_currency(modifierPrice,{precision:2});orderHTML+="<div class='modifier_price'>"+modifierPriceText+"</div>";}
orderHTML+=clearHTML;}
if(orderItem.oia_items){for(var j=0;j<orderItem.oia_items.length;j++){oia_is_add=orderItem.oia_items[j].is_add;orderHTML+=clearHTML+"<div class='oia "+(orderItem.oia_items[j].hide_on_receipt?"hide_on_receipt":"")+"'>";orderHTML+="<div class='oia_name "+(orderItem.oia_items[j].is_note?"note":"")+"'>";if(!orderItem.oia_items[j].is_note){if(orderItem.oia_items[j].is_addable){orderHTML+=oia_is_add?"Add ":"No ";}}
orderHTML+=orderItem.oia_items[j].description+"</div>";if(orderItem.oia_items[j].abs_charge!=0){oiaPriceWithoutDiscount=orderItem.oia_items[j].abs_charge*orderItem.amount;if(haveDiscount&&oia_is_add){oiaPrice=oiaPriceWithoutDiscount-((oiaPriceWithoutDiscount*orderItem.discount_percent)/100);}else{oiaPrice=oiaPriceWithoutDiscount;}
orderHTML+="<div class='oia_price'>"+(!oia_is_add?"-":"")+currency(oiaPrice,false)+"</div>";}
orderHTML+="</div>"+clearHTML;}}
var preDiscountPrice=(orderItem.product_price*orderItem.amount);if(orderItem.modifier){preDiscountPrice+=orderItem.modifier.price*orderItem.amount;}
if(orderItem.oia_items){var oiaPriceTotal=0;for(var j=0;j<orderItem.oia_items.length;j++){var nextOia=orderItem.oia_items[j];if(nextOia.is_add){oiaPriceTotal+=orderItem.oia_items[j].abs_charge;}else{oiaPriceTotal-=orderItem.oia_items[j].abs_charge;}}
preDiscountPrice+=oiaPriceTotal*orderItem.amount;}
if(haveDiscount){formattedPreDiscountedPrice=number_to_currency(preDiscountPrice,{precision:2});orderHTML+=clearHTML;if(orderItem.discount_percent==100){orderHTML+="<div class='discount_complimentary'>Complimentary (was "+formattedPreDiscountedPrice+")</div>";}else{orderHTML+="<div class='discount'>"+clearHTML;orderHTML+="<div class='header'>Discounted</div>";orderHTML+="<div class='discount_amount'>"+orderItem.discount_percent+"% from </div>";orderHTML+="<div class='new_price'>"+formattedPreDiscountedPrice+"</div>"+clearHTML;orderHTML+="</div>";}}
orderHTML+=clearHTML+"</div>"+clearHTML;return orderHTML;}
function doSelectReceiptItem(orderItemEl){if(menuScreenType==CUSTOMER_MENU_SCREEN){return null;}
orderItemEl=$(orderItemEl);closeEditOrderItem();switchToMenuItemsSubscreen();var buttons=[[discountButtonID,$('#discount_button')],[changePriceButtonID,$('#price_editor')],[removeItemButtonID,$('#delete_button')],[oiaButtonID,$('#oia_button')],[courseNumButtonID,$('#course_button')],[voidOrderItemButtonID,$('#void_order_item_button')],];hideRestrictedButtons(buttons);currentSelectedReceiptItemEl=orderItemEl;try{var selectedProduct=products[getCurrentOrder().items[parseInt(orderItemEl.data("item_number"))-1].product.id];setModifierGridIdForProduct(selectedProduct);}catch(e){console.log("Receipt Item selection problem automatically resolved");var messyOrder=getCurrentOrder();orderReceiptItems(messyOrder);if(selectedTable!=0){storeTableOrderInStorage(current_user_id,selectedTable,messyOrder);}else{storeOrderInStorage(current_user_id,messyOrder);}
loadReceipt(messyOrder);return null;}
orderItemEl.addClass("selected");editItemPopupAnchor=$('#receipt');if(editItemPopupAnchor.HasBubblePopup()){editItemPopupAnchor.RemoveBubblePopup();}
editItemPopupAnchor.CreateBubblePopup();popupHTML=$("#edit_receipt_item_popup_markup").html();editItemPopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);editItemPopupAnchor.FreezeBubblePopup();popupId=editItemPopupAnchor.GetBubblePopupID();currentPrice=orderItemEl.children('.total').data("per_unit_price");currentPrice=currency(currentPrice,false);$('#'+popupId).find('.price').val(currentPrice);currentQuantity=orderItemEl.children('.amount').html();$('#'+popupId).find('.quantity').val(currentQuantity);$('#'+popupId).find('.quantity').focus().select();keypadPosition=$('#'+popupId).find('.edit_order_item_popup_keypad_container');clickFunction=function(val){doKeyboardInput(lastActiveElement,val);};cancelFunction=function(){doKeyboardInputCancel(lastActiveElement);};setUtilKeypad(keypadPosition,clickFunction,cancelFunction);registerPopupClickHandler($('#'+popupId),closeEditOrderItem);return $('#'+popupId);}
function hideRestrictedButtons(buttons){for(var i=0;i<buttons.length;i++){var buttonId=parseInt(buttons[i][0]);var buttonEl=buttons[i][1];if(typeof(display_button_passcode_permissions[buttonId])!='undefined'){buttonEl.show();}else{buttonEl.hide();}}}
function editOrderItemIncreaseQuantity(){popupId=editItemPopupAnchor.GetBubblePopupID();targetInputEl=$('#'+popupId).find('.quantity');currentVal=parseFloat(targetInputEl.val());var newQuantity=currentVal;if(isNaN(currentVal)){newQuantity=1;}else{newQuantity=currentVal+1;}
targetInputEl.val(newQuantity);}
function editOrderItemDecreaseQuantity(){popupId=editItemPopupAnchor.GetBubblePopupID();targetInputEl=$('#'+popupId).find('.quantity');currentVal=parseFloat(targetInputEl.val());var newQuantity=currentVal;if(isNaN(currentVal)){newQuantity=1;}else if(currentVal>1){newQuantity=currentVal-1;}
targetInputEl.val(newQuantity);}
function closeEditOrderItem(){if(currentSelectedReceiptItemEl){hideBubblePopup(editItemPopupAnchor);currentSelectedReceiptItemEl.removeClass("selected");currentSelectedReceiptItemEl=null;}
$('#scan_upc').focus();}
function saveEditOrderItem(){var itemNumber=currentSelectedReceiptItemEl.data("item_number");popupId=editItemPopupAnchor.GetBubblePopupID();closeEditOrderItem();targetInputQuantityEl=$('#'+popupId).find('.quantity');newQuantity=parseFloat(targetInputQuantityEl.val());if(isNaN(newQuantity)||newQuantity<=0){newQuantity=1;}
targetInputPricePerUnitEl=$('#'+popupId).find('.price');newPricePerUnit=parseFloat(targetInputPricePerUnitEl.val());if(isNaN(newPricePerUnit)){newPricePerUnit=0;}
order=getCurrentOrder();var courseNum=order.items[itemNumber-1].product.course_num;var is_void=order.items[itemNumber-1].is_void;if(selectedTable!=0){modifyOrderItem(order,itemNumber,newQuantity,newPricePerUnit,courseNum,is_void);storeTableOrderInStorage(current_user_id,selectedTable,order);}else{modifyOrderItem(order,itemNumber,newQuantity,newPricePerUnit,courseNum,is_void);storeOrderInStorage(current_user_id,order);}
order=getCurrentOrder();loadReceipt(order,true);}
function editOrderItemOIAClicked(){hideBubblePopup(editItemPopupAnchor);showModifyOrderItemScreen();}
function writeTotalToReceipt(order,orderTotal){if(!order)return;tillRollDiscountHTML=getTillRollDiscountHTML(order);$('#till_roll_discount').html(tillRollDiscountHTML);$('#total_value').html(currency(orderTotal));}
function tableScreenSelectTable(tableId){if(inTransferOrderMode){if(tableId==0){niceAlert("Cannot move order to table 0");return;}
if(transferOrderInProgress){niceAlert("Transfer table order in progress, please wait.");return;}
doTransferTable(selectedTable,tableId);return;}else if(inTransferOrderItemMode){if(tableId==0){niceAlert("Cannot move order item to table 0");return;}
if(transferOrderItemInProgress){niceAlert("Transfer table order item in progress, please wait.");return;}
doTransferOrderItem(selectedTable,tableId);return;}
showMenuScreen();tableSelectMenu.setValue(tableId);doSelectTable(tableId);}
function transferOrderError(){hideNiceAlert();$('#tables_screen_status_message').hide();inTransferOrderMode=false;transferOrderInProgress=false;showMenuScreen();niceAlert("Error transferring order. Server might be down!");return;}
function loadReceipt(order,doScroll){clearReceipt();if(order==null){return;}
var orderTotal=order.total;orderItems=order.items;allOrderItemsRecptHTML=getAllOrderItemsReceiptHTML(order);$('#till_roll').html($('#till_roll').html()+allOrderItemsRecptHTML);if(orderTotal!=null){writeTotalToReceipt(order,orderTotal);}
if(doScroll){menuRecptScroll();}
if(currentSelectedReceiptItemEl){var selectedReceiptItemNumber=currentSelectedReceiptItemEl.data("item_number");currentSelectedReceiptItemEl=$('#till_roll div[data-item_number='+selectedReceiptItemNumber+']');}}
function storeDallasKeyVal(e){if(getEventKeyCode(e)==13){var newVal=$('#user_passcode').val().substring(3,15);$('#user_passcode').val(newVal);}
if(getEventKeyCode(e)==117){$('#user_passcode').val("u");}
if(getEventKeyCode(e)==97){$('#user_passcode').val("a");}}
function nullOnEnter(event){if(getEventKeyCode(event)==13){setEventKeyCode(event,null);return;}}
function loginRecptScroll(){recptScroll("login_");}
function loginRecptUpdate(){updateRecpt("login_");}
function menuRecptScroll(){recptScroll("");}
function totalsRecptScroll(){recptScroll("totals_");}
function deliveryRecptScroll(){recptScroll("delivery_");}
function reportsRecptScroll(){recptScroll("reports_center_");}
function reportsRecptUpdate(){updateRecpt("reports_center_");}
function reportsLeftRecptScroll(){recptScroll("reports_left_");}
function floatRecptScroll(){recptScroll("float_");}
function adminOrderListRecptScroll(){recptScroll("admin_order_list_");}
function mobileTerminalRecptScroll(){recptScroll("mobile_terminal_");}
function mobileServerRecptScroll(){recptScroll("mobile_server_");}
function mobileTableRecptScroll(){recptScroll("mobile_table_");}
function clearOrder(selectedTable){if(selectedTable==0){clearOrderInStorage(current_user_id);currentOrder=null;}else{clearTableOrderInStorage(current_user_id,selectedTable);}
clearReceipt();}
function doTotal(applyDefaultServiceCharge){if(!callHomePollInitSequenceComplete){niceAlert("Downloading data from server, please wait.");return;}
if(currentOrderEmpty()){setStatusMessage("No order present to sub-total!",true,true);return;}
if(!ensureLoggedIn()){return;}
if(applyDefaultServiceCharge){applyDefaultServiceChargePercent();}
totalOrder=getCurrentOrder();cashScreenReceiptHTML=fetchCashScreenReceiptHTML()
$('#totals_till_roll').html(cashScreenReceiptHTML);$('#totals_data_table').html(fetchCashScreenReceiptTotalsDataTable());cashTendered=0;cashTenderedKeypadString="";cashScreenReceiptDiscountHTML=getTillRollDiscountHTML(totalOrder);$('#totals_till_roll_discount').html(cashScreenReceiptDiscountHTML);var orderTotal=totalOrder.total;$('#cash_screen_sub_total_value').html(currency(orderTotal));if(!paymentMethod){paymentMethod=defaultPaymentMethod;}
splitPayments={};paymentIntegrationId=0;var paymentMethodId=getPaymentMethodId(paymentMethod);paymentMethodSelected(paymentMethodId);$('#menu_screen_shortcut_dropdown_container').hide();showNavBackLinkMenuScreen();showTotalsScreen();totalsRecptScroll();$('#totals_tendered_value').html(currency(0,false));updateTotalTendered();$('#totals_tendered_box').addClass("selected");resetLoyaltyCustomer();resetCustomerSelect();}
var cashSaleInProcess=false;function doTotalFinal(){if(cashSaleInProcess||orderInProcess){niceAlert("There is an order being processed, please wait.");return;}
var now=clueyTimestamp();if(selectedTable!=0&&lastOrderSentTime!=null&&((now-lastOrderSentTime)<(pollingAmount+2000))){showLoadingDiv("Waiting on previous sale to finish processing...");setTimeout(doTotalFinal,1000);return;}
hideLoadingDiv();if(currentOrderEmpty()){setStatusMessage("No order present to total!",true,true);return;}
if(!ensureLoggedIn()){return;}
cashSaleInProcess=true;var isSplitBill=false;numPersons=0
isTableZeroOrder=false;if(selectedTable==0){totalOrder=currentOrder;tableInfoId=null;tableInfoLabel="None";isTableOrder=false;isTableZeroOrder=true;if(isProcessingTable0Orders){showLoadingDiv("Sending Order...");}
var copiedLastTableZeroOrder={};lastTableZeroOrder=$.extend(true,copiedLastTableZeroOrder,totalOrder);}else{totalOrder=tableOrders[selectedTable];if(selectedTable==previousOrderTableNum){tableInfoLabel=tables[previousOrderTableNum].label;isTableOrder=(tableInfoLabel!='None');tableInfoId=totalOrder.tableInfoId;}else if(selectedTable==tempSplitBillTableNum){isSplitBill=true;totalOrder.tableInfoId=totalOrder.split_bill_table_num;tableInfoLabel=tables[totalOrder.tableInfoId].label+" Split";isTableOrder=true;tableInfoId=totalOrder.tableInfoId;}else{isTableOrder=true;tableInfoId=selectedTable;tableInfoLabel=tables[tableInfoId].label;}
numPersons=parseInt(totalOrder.covers);if(numPersons<0){numPersons=0;}}
if(!paymentMethod){paymentMethod=defaultPaymentMethod;}
if(typeof(totalOrder.time)=='undefined'){totalOrder.time=clueyTimestamp();}
var orderStartTime=totalOrder.time;totalOrder.payment_method=paymentMethod;totalOrder.service_charge=serviceCharge;totalOrder.cashback=cashback;discountPercent=totalOrder.discount_percent;preDiscountPrice=totalOrder.pre_discount_price;var orderTotal=totalOrder.total;if(parseFloat(cashTendered)==0.0){cashTendered=orderTotal+serviceCharge;totalOrder.cash_tendered=orderTotal+serviceCharge;}else{totalOrder.cash_tendered=cashTendered;}
totalOrder.change=$('#totals_change_value').html();totalOrder.split_payments=splitPayments;var doOpenCashDrawer=false;if($.isEmptyObject(splitPayments)){splitPayments[paymentMethod]=totalOrder.cash_tendered;doOpenCashDrawer=paymentMethods[getPaymentMethodId(paymentMethod)].open_cash_drawer;}else{for(var pm in splitPayments){if((parseFloat(splitPayments[pm])<=0)&&(sizeOfHash(splitPayments)>1)){delete splitPayments[pm];continue;}
var pmId=getPaymentMethodId(pm);if(paymentMethods[pmId].open_cash_drawer){doOpenCashDrawer=true;}}}
if(doOpenCashDrawer){openCashDrawer();}
receiptHTML=fetchFinalReceiptHTML(false,true,false);printReceiptHTML=fetchFinalReceiptHTML(true,false,printVatReceipt);setLoginReceipt("Last Sale",receiptHTML);if(taxChargable){orderSalesTaxRate=globalTaxRate;taxAmount=(totalOrder.total*globalTaxRate)/100;orderTotal=totalOrder.total+taxAmount;}else{orderSalesTaxRate=-1;orderTotal=totalOrder.total;}
orderTotal=parseFloat(orderTotal).toFixed(2);order_num=totalOrder.order_num
orderData={'order_details':totalOrder,'order_num':order_num,'time_started':orderStartTime,'employee_id':current_user_id,'total':orderTotal,'tax_chargable':taxChargable,'global_sales_tax_rate':orderSalesTaxRate,'service_charge':serviceCharge,'cashback':cashback,'payment_type':paymentMethod,'amount_tendered':cashTendered,'num_persons':numPersons,'client_name':totalOrder.client_name,'is_table_order':isTableOrder,'table_info_id':tableInfoId,'table_info_label':tableInfoLabel,'discount_percent':discountPercent,'pre_discount_price':preDiscountPrice,'terminal_id':terminalID,'void_order_id':totalOrder.void_order_id,'is_split_bill':isSplitBill,'split_payments':splitPayments,'is_training_mode_sale':inTrainingMode}
sendOrderToServer(orderData);clearOrder(selectedTable);$('#till_roll').html('');$('#till_roll_discount').html('');$('#sales_tax_total').html('');var copiedLastOrder={};lastSaleObj=$.extend(true,copiedLastOrder,totalOrder);loadAfterSaleScreen();resetTendered();$('#totals_change_value').html("");serviceCharge=0;cashback=0;paymentMethod=null;currentCardChargeAmount=0;if(selectedTable==previousOrderTableNum){$('#previous_order_select_item').hide();}
if(selectedTable==tempSplitBillTableNum){$('#split_bill_select_item').hide();}
tableSelectMenu.setValue(0);doSelectTable(0);mandatoryFooterMessageHTML="";var loyalty=totalOrder.loyalty;if(loyalty){var customerName=loyalty.customer_name;var customerNumber=loyalty.customer_number;var pointsEarned=loyalty.points_earned;mandatoryFooterMessageHTML+=clearHTML+"<div id='loyalty_receipt_info'>";mandatoryFooterMessageHTML+="<div class='header'>Loyalty Info:</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='label'>Customer Name:</div><div class='data'>"+customerName+"</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='label'>Customer Number:</div><div class='data'>"+customerNumber+"</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='label'>Points Earned:</div><div class='data'>"+pointsEarned+"</div>"+clearHTML;mandatoryFooterMessageHTML+="</div>"+clear30HTML;}
totalOrder=null;currentTotalFinal=0;if(paymentIntegrationId==zalionPaymentIntegrationId&&selectedRoomNumber!=null&&selectedFolioName!=null){mandatoryFooterMessageHTML+=clearHTML+"<div id='zalion_receipt_info'>";mandatoryFooterMessageHTML+="<div class='header'>Room Charge Info:</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='label'>Room Number:</div><div class='data'>"+selectedRoomNumber+"</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='label'>Client Name:</div><div class='data'>"+selectedFolioName+"</div>"+clearHTML;mandatoryFooterMessageHTML+=clear30HTML+"<div class='line'>Signature:</div>"+clearHTML;mandatoryFooterMessageHTML+="<div class='line'>___________________________________________</div>"+clearHTML;mandatoryFooterMessageHTML+="</div>"+clear30HTML;printReceipt(printReceiptHTML,true);}else if(autoPrintReceipt){printReceipt(printReceiptHTML,true);}
customFooterId=null;}
function orderSentToServerCallback(orderData,errorOccured){if(!errorOccured){if(paymentIntegrationId==zalionPaymentIntegrationId&&selectedRoomNumber!=null&&selectedFolioNumber!=null){orderData['charged_room']={selected_room_number:selectedRoomNumber,selected_folio_number:selectedFolioNumber,selected_folio_name:selectedFolioName,payment_integration_type_id:paymentIntegrationId}
doChargeRoom(orderData);}
if(isTableZeroOrder&&isProcessingTable0Orders){doSyncTableOrder();hideLoadingDiv();}}else{if(!isTableZeroOrder){niceAlert("There was an error cashing out the last order. It will automatically resend itself, please do not cash out on another terminal!");}}
cashSaleInProcess=false;}
function loadAfterSaleScreen(){hideAllScreens();if(defaultHomeScreen==LOGIN_SCREEN){doLogout();}else if(defaultHomeScreen==MENU_SCREEN){showMenuScreen();}else if(defaultHomeScreen==TABLES_SCREEN){showTablesScreen();}else{doLogout();}}
var send_order_xhr=null;var sendOrderToServerTimeoutSeconds=8;function sendOrderToServer(orderData){var timeoutMillis=sendOrderToServerTimeoutSeconds*1000;send_order_xhr=$.ajax({type:'POST',url:'/order',timeout:timeoutMillis,error:function(){storeOrderForLaterSend(orderData);orderSentToServerCallback(orderData,true);},success:function(){orderSentToServerCallback(orderData,false);},data:{order:orderData}});}
function storeOrderForLaterSend(orderData){ordersForLaterSend=retrieveOrdersForLaterSend();if(ordersForLaterSend==null){ordersForLaterSend=new Array();}
ordersForLaterSend.push(orderData);saveOrdersForLaterSend(ordersForLaterSend);}
var sendingOutstandingOrders=false;function trySendOutstandingOrdersToServer(){if(sendingOutstandingOrders){return;}
ordersForLaterSend=retrieveOrdersForLaterSend();if(ordersForLaterSend.length>0){sendOutstandingOrdersToServer(ordersForLaterSend);}}
function sendOutstandingOrdersToServer(outstandingOrdersData){sendingOutstandingOrders=true;$.ajax({type:'POST',url:'/outstanding_orders',success:clearOutstandingOrders,complete:function(){sendingOutstandingOrders=false;},data:{orders:outstandingOrdersData}});}
function clearOutstandingOrders(){ordersForLaterSend=retrieveOrdersForLaterSend();ordersForLaterSend=new Array();saveOrdersForLaterSend(ordersForLaterSend);}
function retrieveOrdersForLaterSend(){ordersForLaterSendOBJ=retrieveStorageJSONValue("orders_for_later_send");if(ordersForLaterSendOBJ&&ordersForLaterSendOBJ.ordersForLaterSend){return ordersForLaterSendOBJ.ordersForLaterSend;}
return new Array();}
function saveOrdersForLaterSend(ordersForLaterSend){ordersForLaterSendOBJ={'ordersForLaterSend':ordersForLaterSend};storeKeyJSONValue("orders_for_later_send",ordersForLaterSendOBJ);}
function initOptionButtons(){$('#menu_buttons_panel .buttons').hide();$('#options_screen_menu_buttons .buttons').hide();var role_id=serverRoleID(current_user_id);$('#menu_screen_buttons_html_for_role_'+role_id).show();$('#options_screen_buttons_html_for_role_'+role_id).show();display_button_passcode_permissions=all_display_button_permissions[role_id];}
var currentTargetPopupAnchor=null;var individualItemDiscount=false;function showDiscountPopup(receiptItem){currentSelectedReceiptItemEl=receiptItem;if(currentOrderEmpty()){setStatusMessage("No order present to discount!");return;}
closeDiscountPopup();if(receiptItem){$(receiptItem).addClass("selected");$("#apply_discount_to").hide();individualItemDiscount=true;}else{$("#apply_discount_to").show();$("#discounts_popup_markup_container").addClass("higher");individualItemDiscount=false;}
currentTargetPopupAnchor=$('#receipt');if(currentTargetPopupAnchor.HasBubblePopup()){currentTargetPopupAnchor.RemoveBubblePopup();}
currentTargetPopupAnchor.CreateBubblePopup();discountsPopupHTML=$("#discounts_popup_markup").html();currentTargetPopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:discountsPopupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);currentTargetPopupAnchor.FreezeBubblePopup();popupId=currentTargetPopupAnchor.GetBubblePopupID();if(receiptItem){var itemNumber=receiptItem.data("item_number");existingDiscountPercent=getExistingDiscountPercentForCurrentOrderItem(itemNumber);if(existingDiscountPercent){$('#'+popupId).find('#discount_percent_input').val(existingDiscountPercent);}else{$('#'+popupId).find('#discount_percent_input').val(defaultDiscountPercent);}}else{$('#'+popupId).find('#discount_percent_input').val(defaultDiscountPercent);}
$('#'+popupId).find('#discount_percent_input').focus();keypadPosition=$('#'+popupId).find('.discount_popup_keypad_container');clickFunction=function(val){var inputEl=$('#'+popupId).find('#discount_percent_input');doKeyboardInput(inputEl,val);};cancelFunction=function(){var inputEl=$('#'+popupId).find('#discount_percent_input');doKeyboardInputCancel(inputEl);};setUtilKeypad(keypadPosition,clickFunction,cancelFunction);registerPopupClickHandler($('#'+popupId),closeDiscountPopup);}
function showDiscountPopupFromEditDialog(){receiptItem=currentSelectedReceiptItemEl;closeEditOrderItem();showDiscountPopup(receiptItem);}
function closeDiscountPopup(){if(currentTargetPopupAnchor){hideBubblePopup(currentTargetPopupAnchor);}}
function setDiscountVal(val){popupId=currentTargetPopupAnchor.GetBubblePopupID();$('#'+popupId).find('#discount_percent_input').val(val);}
function saveDiscount(){popupId=currentTargetPopupAnchor.GetBubblePopupID();selectedValue=$('#'+popupId).find('#discount_percent_input').val();selectedValue=parseFloat(selectedValue);if(isNaN(selectedValue)){selectedValue=0;}
if(selectedValue<0||selectedValue>100){setStatusMessage("You must enter a number between 0 and 100",true,true);return;}
order=getCurrentOrder();wholeOrderDiscount=($("input[name='discount_type']:checked").val()=='whole_order');if(individualItemDiscount){var itemNumber=currentSelectedReceiptItemEl.data("item_number");applyDiscountToOrderItem(order,itemNumber,selectedValue);}else if(wholeOrderDiscount){addDiscountToOrder(order,selectedValue);}else{applyDiscountToOrderItem(order,-1,selectedValue);}
if(selectedTable!=0){storeTableOrderInStorage(current_user_id,selectedTable,order);}else{storeOrderInStorage(current_user_id,order);}
closeDiscountPopup();loadReceipt(order,true);setTimeout(menuRecptScroll,20);}
var currentCoursePopupAnchor=null;function showCoursePopupFromEditDialog(){receiptItem=currentSelectedReceiptItemEl;currentCoursePopupAnchor=$('#receipt');if(currentCoursePopupAnchor.HasBubblePopup()){currentCoursePopupAnchor.RemoveBubblePopup();}
currentCoursePopupAnchor.CreateBubblePopup();coursePopupHTML=$("#course_popup_markup").html();currentCoursePopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:coursePopupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);currentCoursePopupAnchor.FreezeBubblePopup();var coursePopupId=currentCoursePopupAnchor.GetBubblePopupID();var current_course_num=receiptItem.find(".name").data("course_num");var selectedCourseEl=$('#'+coursePopupId).find('.course_label_'+current_course_num);selectedCourseEl.html(selectedCourseEl.html()+" *");registerPopupClickHandler($('#'+coursePopupId),closeCoursePopup);}
function closeCoursePopup(){if(currentCoursePopupAnchor){hideBubblePopup(currentCoursePopupAnchor);}}
function applyCourseFromPopup(courseVal){closeCoursePopup();var itemNumber=currentSelectedReceiptItemEl.data("item_number");order=getCurrentOrder();var item=order.items[itemNumber-1];newCourseNum=courseVal
item.show_course_label=true;if(selectedTable!=0){modifyOrderItem(order,itemNumber,item.amount,item.product_price,newCourseNum,item.is_void);storeTableOrderInStorage(current_user_id,selectedTable,order);}else{modifyOrderItem(order,itemNumber,item.amount,item.product_price,newCourseNum,item.is_void);storeOrderInStorage(current_user_id,order);}
order=getCurrentOrder();loadReceipt(order,true);}
function voidOrderItemFromEditDialog(){if(selectedTable==0){niceAlert("You cannot void items that are not on a table");return;}
var itemNumber=currentSelectedReceiptItemEl.data("item_number");order=getCurrentOrder();var item=order.items[itemNumber-1];if(!item.synced){niceAlert("You can only void ordered items, you can delete this item");return;}
var makeVoid=false;if(!item.is_void){makeVoid=true;}
item.synced=false;modifyOrderItem(order,itemNumber,item.amount,item.product_price,item.product.course_num,makeVoid);storeTableOrderInStorage(current_user_id,selectedTable,order);order=getCurrentOrder();loadReceipt(order,true);closeEditOrderItem();}
function voidAllOrderItems(){if(selectedTable==0){niceAlert("You cannot void items that are not on a table");return;}
order=getCurrentOrder();for(var i=0;i<order.items.length;i++){var item=order.items[i];item.is_void=true;modifyOrderItem(order,i+1,item.amount,item.product_price,item.product.course_num,item.is_void);}
storeTableOrderInStorage(current_user_id,selectedTable,order);order=getCurrentOrder();loadReceipt(order,true);quickSale();}
function addDiscountToOrder(order,amount){order['discount_percent']=amount;calculateOrderTotal(order);}
function getExistingDiscountPercentForCurrentOrderItem(itemNumber){order=getCurrentOrder();orderItem=order.items[itemNumber-1];existingDiscount=orderItem['discount_percent'];return existingDiscount;}
function orderItemAdditionTabSelected(oiagId){if(!oiagId){oiagId=$('#oia_tabs .oia_tab').first().data("oiag_id");}
clearSelectedOIATabs();$('#add_note').hide();resetKeyboard();$('#oia_tab_'+oiagId).addClass("selected");$('.oia_container').hide();modifierGridXSize=$('#oiag_'+oiagId).data("grid_x_size");modifierGridYSize=$('#oiag_'+oiagId).data("grid_y_size");initModifierGrid();$('#oiag_'+oiagId).show();setOrderItemAdditionsGridState();}
function clearSelectedOIATabs(){$('#oia_tabs .tab').removeClass("selected");}
function doOpenOIANoteScreen(){clearSelectedOIATabs();$('.oia_container').hide();$('#oia_tab_note').addClass("selected");$('.button[id=sales_button_'+addNoteButtonID+'], .button[id=admin_screen_button_'+addNoteButtonID+']').addClass("selected");$('#oia_container').hide();$('#add_note').show();$('#note_input').focus();noteChargeIsPlus=true;clearNoteInputs();initNoteScreenKeyboard();}
function doSaveNote(){var charge=$('#charge_input').val();if(isNaN(charge)){setStatusMessage("Please enter a number for charge!");return false;}
var noteInput=$('#note_input').val();noteInput=$.trim(noteInput);if(noteInput.length==0&&charge==0){doCancelNote();return true;}
if(noteInput.length==0){setStatusMessage("Please enter some text for this note!");return false;}
currentSelectedReceiptItemEl=getSelectedOrLastReceiptItem();if(!currentSelectedReceiptItemEl){setStatusMessage("There are no receipt items!");return false;}
var order=getCurrentOrder();var itemNumber=currentSelectedReceiptItemEl.data("item_number");var orderItem=order.items[itemNumber-1];var desc=noteInput;var absCharge=charge;addOIAToOrderItem(order,orderItem,desc,absCharge,0,0,noteChargeIsPlus,true,false,false,-1,-1);toggleModifyOrderItemScreen();clearNoteInputs();return true;}
function doCancelNote(){clearNoteInputs();toggleModifyOrderItemScreen();}
function clearNoteInputs(){$('#charge_input').val("0");$('#note_input').val("");}
var noteChargeIsPlus=true;function toggelNoteChargePlusMins(){noteChargeIsPlus=!noteChargeIsPlus;$('#plus_minus_text_container').html((noteChargeIsPlus?"+":"-"));}
function renderMenuItemButtonDimensions(){var button_border=1;var button_margin=1;var original_width=88;$('#items .item').each(function(){var item=$(this);var width_factor=item.data("button_width");item.width((original_width*width_factor)
+(button_margin*2*(width_factor-1))
+(button_border*2*(width_factor-1)));});$('#items .menu_item_spacer').each(function(){var item=$(this);var width_factor=1;item.width((original_width*width_factor)
+(button_margin*2*(width_factor-1))
+(button_border*2*(width_factor-1)));});}
function renderActiveTables(){var activeTableIDS=getActiveTableIDS();$("#table_select").children('li').children('ul').children('li').each(function(id,element){if(typeof($(element).attr('rel'))!='undefined'){nextTableID=$(element).attr('rel').toString();if($.inArray(nextTableID,activeTableIDS)!=-1){$(element).addClass("active");$('#table_label_'+nextTableID).addClass("active");getTableOrderFromStorage(clueyUserId,nextTableID);var tableOrder=tableOrders[nextTableID];if(tableOrder.client_name.length>0){$('#table_label_'+nextTableID).html(tables[nextTableID].label+" ("+tableOrder.client_name+")");}}else{$(element).removeClass("active");$('#table_label_'+nextTableID).removeClass("active");}}});}
var afterSplitBillSyncCallback;function postDoSyncTableOrder(){if(isTableZeroOrder){isTableZeroOrder=false;return;}
clearLoginReceipt();doSelectTable(selectedTable);if(inTransferOrderMode){hideNiceAlert();$('#tables_screen_status_message').hide();inTransferOrderMode=false;tableScreenSelectTable(selectedTable);loadAfterSaleScreen();setStatusMessage("Order Transfered.");return;}else if(inTransferOrderItemMode){finishTransferOrderItem();return;}else if(inSplitBillMode){inSplitBillMode=false;showMenuScreen();$('#split_bill_select_item').show();tableSelectMenu.setValue(tempSplitBillTableNum);doSelectTable(tempSplitBillTableNum);if(afterSplitBillSyncCallback){afterSplitBillSyncCallback();}
return;}
if(!doAutoLoginAfterSync){loadAfterSaleScreen();}
doAutoLoginAfterSync=false;setStatusMessage("Order Sent");setLoginReceipt("Last Order","Loading Order...");finishDoSyncTableOrder();}
function finishDoSyncTableOrder(){orderReceiptHTML=fetchOrderReceiptHTML(lastSyncedOrder);setLoginReceipt("Last Order",orderReceiptHTML);loginRecptUpdate();}
function toggleModifyOrderItemScreen(){if(currentMenuSubscreenIsMenu()){$('.button[id=sales_button_'+modifyOrderItemButtonID+'], .button[id=admin_screen_button_'+modifyOrderItemButtonID+']').addClass("selected");showModifyOrderItemScreen();}else{resetKeyboard();$('.button[id=sales_button_'+addNoteButtonID+'], .button[id=admin_screen_button_'+addNoteButtonID+']').removeClass("selected");$('.button[id=sales_button_'+modifyOrderItemButtonID+'], .button[id=admin_screen_button_'+modifyOrderItemButtonID+']').removeClass("selected");switchToMenuItemsSubscreen();}}
function showModifyOrderItemScreen(){switchToModifyOrderItemSubscreen();}
function switchToMenuItemsSubscreen(){if(currentScreenIsMenu()){showMenuItemsSubscreen();}}
function showMenuItemsSubscreen(){toggleKeyboardEnable=true;hideAllMenuSubScreens();$('#menu_container').show();}
function switchToModifyOrderItemSubscreen(){if(currentScreenIsMenu()){$('#add_note').hide();resetKeyboard();hideAllMenuSubScreens();$('.button[id=sales_button_'+modifyOrderItemButtonID+'], .button[id=admin_screen_button_'+modifyOrderItemButtonID+']').addClass("selected");$('#order_item_additions').show();$('#order_item_additions #add_note').hide();orderItemAdditionTabSelected(currentModifierGridIdForProduct);}}
function postDoSelectTable(){}
function doReceiveOrderReady(employee_id,terminal_id,table_id,order_num,table_label){if(inKitchenContext()){return;}
hidePreviousOrderReadyPopup();if(terminal_id==terminalID){var orderReadyText;if(table_id.toString()=="0"){orderReadyText="Order #"+order_num;}else{orderReadyText="Order #"+order_num+" for table "+table_label;}
ModalPopups.Alert('niceAlertContainer','Order Ready!',"<div id='nice_alert'>"+orderReadyText+" is ready</div>",{okButtonText:'OK',onOk:'orderReadyOKClicked()',width:400,height:250});}}
function orderReadyOKClicked(){hideOrderReadyPopup();console.log("Order accepted!!");}
function orderReadyCancelClicked(){hideOrderReadyPopup();console.log("Order rejected!!");}
function hidePreviousOrderReadyPopup(){hideOrderReadyPopup();}
function hideOrderReadyPopup(){try{ModalPopups.Close('niceAlertContainer');}catch(e){}}
var currentSplitBillItemQuantity="";function splitBillScreenKeypadClick(val){if(val=='0'){if(currentSplitBillItemQuantity.length>0)
currentSplitBillItemQuantity+=val}else{if(currentSplitBillItemQuantity.indexOf(".")!=-1){if(currentSplitBillItemQuantity.length-currentSplitBillItemQuantity.indexOf(".")>1){return;}}
currentSplitBillItemQuantity+=val;}
$('#split_bill_input_show').html(currentSplitBillItemQuantity);}
function splitBillScreenKeypadClickDecimal(){if(currentSplitBillItemQuantity.indexOf(".")==-1){currentSplitBillItemQuantity+=".";}
$('#split_bill_input_show').html(currentSplitBillItemQuantity);}
function splitBillScreenKeypadClickCancel(){currentSplitBillItemQuantity="";$('#split_bill_input_show').html(currentSplitBillItemQuantity);}
function loadSplitBillReceipts(){var orderFromReceiptHTML=getAllOrderItemsReceiptHTML(splitBillOrderFrom,false,false,true);$('#split_bill_from_till_roll').html(orderFromReceiptHTML);$('#split_bill_from_till_roll .order_line').each(function(){var orderLine=$(this);orderLine.click(function(){doSplitOrderItem($(this),false);});});var tillRollDiscountHTML=getTillRollDiscountHTML(splitBillOrderFrom);$('#split_bill_from_till_roll_discount').html(tillRollDiscountHTML);calculateOrderTotal(splitBillOrderFrom);$('#split_bill_from_total_value').html(currency(splitBillOrderFrom.total));var orderToReceiptHTML=getAllOrderItemsReceiptHTML(splitBillOrderTo,false,false,true);$('#split_bill_to_till_roll').html(orderToReceiptHTML);$('#split_bill_to_till_roll .order_line').each(function(){var orderLine=$(this);orderLine.click(function(){doSplitOrderItem($(this),true);});});calculateOrderTotal(splitBillOrderTo);$('#split_bill_to_total_value').html(currency(splitBillOrderTo.total));}
function doSplitOrderItem(orderLine,reverse){var orderFrom=splitBillOrderFrom;var orderTo=splitBillOrderTo;if(reverse){orderFrom=splitBillOrderTo;orderTo=splitBillOrderFrom;}
var itemNumber=parseInt(orderLine.data("item_number"));var theItem=orderFrom.items[itemNumber-1];if(currentSplitBillItemQuantity==""){currentSplitBillItemQuantity="1";}
if(currentSplitBillItemQuantity.indexOf(".")!=-1){if(currentSplitBillItemQuantity.length-currentSplitBillItemQuantity.indexOf(".")==1){currentSplitBillItemQuantity="1";}}
if(theItem.amount-currentSplitBillItemQuantity>0){modifyOrderItem(orderFrom,itemNumber,theItem.amount-currentSplitBillItemQuantity,theItem.product_price,theItem.product.course_num,theItem.is_void);}else{if(!reverse&&orderFrom.items.length==1){niceAlert("You cannot remove the last item from the original order!");return;}
currentSplitBillItemQuantity=theItem.amount;doRemoveOrderItem(orderFrom,itemNumber);}
var copiedOrderItem={};var theCopiedOrderItem=$.extend(true,copiedOrderItem,theItem);theCopiedOrderItem.itemNumber=orderTo.items.length+1;orderTo.items.push(theCopiedOrderItem);modifyOrderItem(orderTo,theCopiedOrderItem.itemNumber,currentSplitBillItemQuantity,theCopiedOrderItem.product_price,theCopiedOrderItem.product.course_num,theCopiedOrderItem.is_void);loadSplitBillReceipts();currentSplitBillItemQuantity="";$('#split_bill_input_show').html("");}
function cancelSplitBillMode(){splitBillOrderTo=null;inSplitBillMode=false;showMenuScreen();}
function splitBillShortcutPrintBill(){if(!splitBillEmptyItems()){finishSplitBillMode();afterSplitBillSyncCallback=printBill;}}
function splitBillShortcutPayNow(){if(!splitBillEmptyItems()){finishSplitBillMode();afterSplitBillSyncCallback=doTotal;}}
function splitBillShortcutTransfer(){if(!splitBillEmptyItems()){finishSplitBillMode();afterSplitBillSyncCallback=startTransferOrderMode;}}
function splitBillEmptyItems(){if(splitBillOrderTo.items.length==0){niceAlert("Please transfer over some items first.");return true;}
return false;}
function finishSplitBillMode(){storeTableOrderInStorage(current_user_id,tempSplitBillTableNum,splitBillOrderTo);getTableOrderFromStorage(current_user_id,tempSplitBillTableNum);storeTableOrderInStorage(current_user_id,splitBillTableNumber,splitBillOrderFrom);doAutoLoginAfterSync=true;doSelectTable(splitBillTableNumber);doSyncTableOrder();}
var productInfoPopupEl;var productInfoPopupAnchor;var currentProductInfoPopupProductId;function popupProductInfo(productId){currentProductInfoPopupProductId=productId;var popupHTML=$("#product_info_popup_markup").html();productInfoPopupAnchor=$('#receipt');if(productInfoPopupAnchor.HasBubblePopup()){productInfoPopupAnchor.RemoveBubblePopup();}
productInfoPopupAnchor.CreateBubblePopup();productInfoPopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);productInfoPopupAnchor.FreezeBubblePopup();var popupId=productInfoPopupAnchor.GetBubblePopupID();productInfoPopupEl=$('#'+popupId);var product=products[productId];var productImageURL=product.img_url;if(!productImageURL.startsWith("/system/")){productImageURL="/images/"+productImageURL;}
productInfoPopupEl.find('#product_image').html("<img src=\""+productImageURL+"\"/>");var productName=product.name;productInfoPopupEl.find('#product_name').html(productName);var productPrice=product.price;productInfoPopupEl.find('#product_price').html(currency(productPrice));var productDescription=product.description;productInfoPopupEl.find('#description').html(productDescription);}
function closeProductInfoPopup(){if(productInfoPopupEl){hideBubblePopup(productInfoPopupAnchor);}}
function productInfoAddItemToOrder(){setProductInfoPopup(false);doSelectMenuItem(currentProductInfoPopupProductId,null,null);setProductInfoPopup(true);closeProductInfoPopup();}
function clearMenuScreenInput(){currentMenuItemQuantity="";$('#menu_screen_input_show').html("");}
function performCustomerScreenCSSMods(){$('#items .item').height(133);$('#items .item').width(176);$('#items .item').css("margin","3px");$('#items .item .item_pic').height(116);$('#items .item .item_pic img').height(90);$('#items .item .item_pic img').css("max-height","90px");$('#items .item .item_pic img').css("max-width","172px");$('#items .item .item_pic img').css("margin-top","5px");$('#items .menu_item_spacer').height(135);$('#items .menu_item_spacer').width(178);$('#items .menu_item_spacer').css("margin","3px");$('#items .item .item_name').css("width","172px");$('#items .item .item_name').css("font-size","16px");$('#items .item .item_name').css("bottom","7px");$('div#menu_screen div#menu_pages_container div#menu_container').height(631);$('div#menu_screen div#menu_items_container').height(563);$('div#menu_screen div#order_item_additions').height(631);$('div#menu_screen div#order_item_additions div.oia_container').height(558);$('div#menu_screen div#menu_buttons').height(79);$('#table_screen_button, #table_select_container').hide();$('#box_label_container').show();$('#menu_screen_shortcut_dropdown_container').hide();}
function performScreenResolutionCSSMods(){if(currentResolution==normalResolution){}else if(currentResolution==resolution1360x786){$('#wrapper').css("width","1366px");$('#menu_screen #menu_pages_container').css("width","1090px");}}
function doAutoCovers(){promptAddCovers();}
function setCashOutDescription(cashOutPresetId){var presetLabel=null;for(var i=0;i<cashOutPresets.length;i++){var nextPreset=cashOutPresets[i];if(cashOutPresetId==nextPreset.id){presetLabel=nextPreset.label;}}
$('#cash_out_description').val(presetLabel);}
function cashOutCancelClicked(){inCashOutMode=false;$('#cash_out_description').val("");$('#cash_out_amount').val("");cashOutKeypadString="";currentCashOutAmount=0;showMenuScreen();}
var currentCashOutDescription=null;var currentCashOutAmount=null;function cashOutFinish(){currentCashOutDescription=$('#cash_out_description').val();if(currentCashOutDescription.length==0){niceAlert("Please enter a description!");return;}
$.ajax({type:'POST',url:'/cash_out',complete:function(){setStatusMessage("Expense has been entered!");},data:{description:currentCashOutDescription,amount:(currentCashOutAmount/100)}});var cashOutReceiptContent=getCashOutReceiptHTML();printReceipt(cashOutReceiptContent,false);$('#cash_out_description').val("");$('#cash_out_amount').val("");inCashOutMode=false;cashOutKeypadString="";currentCashOutDescription=currentCashOutAmount=null;currentCashOutAmount=0;showMenuScreen();}
function cashOutAmountCancelClicked(){cashOutKeypadString="";currentCashOutAmount=0;$('#cash_out_amount').html(currency(0));}
function getCashOutReceiptHTML(){var cashOutTillRollHTML="<div class='cash_out_till_roll'>";cashOutTillRollHTML+=fetchBusinessInfoHeaderHTML()+clearHTML;cashOutTillRollHTML+="<div class='cash_out_till_roll_heading'>Paid Expense</div>"+clearHTML;cashOutTillRollHTML+="<div class='cash_out_till_roll_header'>";cashOutTillRollHTML+="<div class='nickname'>Entered By: "+current_user_nickname+"</div>";var timestamp=utilFormatDate(new Date(clueyTimestamp()));cashOutTillRollHTML+="<div class='timestamp'>"+timestamp+"</div>"+clearHTML;cashOutTillRollHTML+="<div class='description_header'>Description</div>";cashOutTillRollHTML+="<div class='amount_header'>Amount</div>"+clearHTML;cashOutTillRollHTML+="<div class='data_table'>";cashOutTillRollHTML+="<div class='label'>"+currentCashOutDescription+"</div><div class='data'>"+currency(currentCashOutAmount/100)+"</div>"+clearHTML;cashOutTillRollHTML+="</div>"+clearHTML;cashOutTillRollHTML+="<div id='cash_out_footer_message'>Please Attatch To Receipt</div>"+clearHTML;cashOutTillRollHTML+="</div>"+clearHTML;return cashOutTillRollHTML;}
var inPriceChangeMode=false;var inStockTakeMode=false;function menuScreenDropdownItemSelected(index,name){if(inPriceChangeMode){finishPriceChangeMode();}else if(inStockTakeMode){finishStockTakeMode();}
if(index.startsWith("1-")){var displayID=index.substring(2);showLoadingDiv("Loading Menu...");$.ajax({type:'POST',url:'/admin/terminals/link_display',success:function(){window.location.reload();},data:{terminal_id:terminalID,display_id:displayID}});return;}else if(index.startsWith("2-")){var priceLevel=index.substring(2);setGlobalPriceLevel(priceLevel);setShortcutDropdownDefaultText();return;}else if(index==3){if(typeof(display_button_passcode_permissions[parseInt(priceChangeButtonID)])!='undefined'){startPriceChangeMode();}else{niceAlert("You do not have permission to change prices!");}
return;}else if(index==4){startStockTakeMode();return;}else if(index==5){goToSpecials();return;}else if(index==6){goToAddProduct();return;}else if(index==7){goToCurrentOrders();return;}else if(index==8){goToAddCustomer();return;}else if(index==9){if(typeof(display_button_passcode_permissions[parseInt(deliveryButtonID)])!='undefined'){startDeliveryMode();}else{niceAlert("You do not have permission to take a delivery!");}
return;}else if(index==10){if(typeof(display_button_passcode_permissions[parseInt(cashOutButtonID)])!='undefined'){showCashOutSubscreen();}else{niceAlert("You do not have permission to pay expenses!");}
return;}
setShortcutDropdownDefaultText();}
function setShortcutDropdownDefaultText(){$('#menu_screen_shortcut_dropdown_container .mcdropdown>div:first').html(defaultShortcutDropdownText);}
function startPriceChangeMode(){if(!appOnline){niceAlert("Server cannot be contacted. Changing prices is disabled until connection re-established.");return;}
if(inStockTakeMode){niceAlert("Please finish checking stock first!");return;}
inPriceChangeMode=true;$('#table_screen_button').add('#table_select_container').hide();$('#price_change_header').show();$('#receipt_container').hide();$('#price_change_receipt').show();loadPriceDivs(currentMenuPage,currentMenuSubPageId);if(currentStockTakeProductId){loadStockTakeReceiptArea(currentStockTakeProductId,currentStockMenuItemId);}}
function finishPriceChangeMode(){showLoadingDiv("Loading new prices...");doReloadSalesResources(priceChangeModeComplete);}
function priceChangeModeComplete(){hideLoadingDiv();inPriceChangeMode=false;$('#table_screen_button').add('#table_select_container').show();$('#price_change_header').hide();$('#receipt_container').show();$('#price_change_receipt').hide();$('#menu_items_container .price_change').hide();setShortcutDropdownDefaultText();requestReload();}
var currentPriceChangeProductId=null;var currentPriceMenuItemId=null;var oldPriceValue=null;function loadPriceChangeReceiptArea(productId,menuItemId){currentPriceMenuItemId=menuItemId;$('#price_change_new_price_input').attr("disabled",false);currentPriceChangeProductId=productId;$('#price_change_receipt #receipt_area').html("Loading...");$.ajax({url:'/load_price_receipt_for_product',data:{product_id:productId}});}
function startStockTakeMode(){if(!appOnline){niceAlert("Server cannot be contacted. Stock mode is disabled until connection re-established.");return;}
if(inPriceChangeMode){niceAlert("Please finish changing prices first!");return;}
inStockTakeMode=true;$('#table_screen_button').add('#table_select_container').hide();$('#stock_take_header').show();$('#receipt_container').hide();$('#stock_take_receipt').show();loadStockDivs(currentMenuPage,currentMenuSubPageId);if(currentStockTakeProductId){loadStockTakeReceiptArea(currentStockTakeProductId,currentStockMenuItemId);}}
function finishStockTakeMode(){inStockTakeMode=false;$('#table_screen_button').add('#table_select_container').show();$('#stock_take_header').hide();$('#receipt_container').show();$('#stock_take_receipt').hide();$('#menu_items_container .stock_count').hide();$('#stock_take_new_amount_input').attr("disabled",true);setShortcutDropdownDefaultText();requestReload();}
function loadPriceDivs(pageNum,subPageId){$.ajax({url:'/load_price_for_menu_page',data:{page_num:pageNum,sub_page_id:subPageId}});}
function updatePrice(){if(currentPriceChangeProductId==null){setStatusMessage("Please select a product!",true,true);return;}
new_price_string=$('#price_change_new_price_input').val();if(isNaN(new_price_string)){setStatusMessage("Please enter a number!",true,true);return;}
new_price=parseFloat(new_price_string);if(oldPriceValue==new_price){setStatusMessage("Please enter a new amount!",true,true);return;}else{$.ajax({url:'/update_price',type:"POST",data:{menu_item_id:currentPriceMenuItemId,product_id:currentPriceChangeProductId,new_price:new_price}});}}
var currentStockTakeProductId=null;var currentStockMenuItemId=null;var oldStockValue=null;function loadStockTakeReceiptArea(productId,menuItemId){if(!products[productId].is_stock_item){setStatusMessage("This is not a stock item.");return;}
currentStockMenuItemId=menuItemId;$('#stock_take_new_amount_input').attr("disabled",false);$('#stock_take_new_amount_input').val("");currentStockTakeProductId=productId;$('#stock_take_receipt #receipt_area').html("Loading...");$.ajax({url:'/load_stock_receipt_for_product',data:{product_id:productId}});}
function loadStockDivs(pageNum,subPageId){$.ajax({url:'/load_stock_for_menu_page',data:{page_num:pageNum,sub_page_id:subPageId}});}
function updateStock(type){if(currentStockTakeProductId==null){setStatusMessage("Please select a product!",true,true);return;}
new_amount_string=$('#stock_take_new_amount_input').val();if(isNaN(new_amount_string)){setStatusMessage("Please enter a number!",true,true);return;}
new_amount=parseFloat(new_amount_string);if(oldStockValue==new_amount){setStatusMessage("Please enter a new amount!",true,true);return;}else{$.ajax({url:'/update_stock',type:"POST",data:{menu_item_id:currentStockMenuItemId,product_id:currentStockTakeProductId,t_type:type,new_amount:new_amount}});}}
function goToSpecials(){goTo("/admin/products?show_specials_only=true");}
function goToAddProduct(){goTo("/admin/products/new");}
function goToCurrentOrders(){goTo("/admin/orders?section=open_orders");}
function goToAddCustomer(){goTo("/admin/customers/new");}
function havePreviousOrder(current_user_id){var key="user_"+current_user_id+"_table_"+previousOrderTableNum+"_current_order";var data=retrieveStorageValue(key);return data!=null;}
function haveSplitBillOrder(current_user_id){var key="user_"+current_user_id+"_table_"+tempSplitBillTableNum+"_current_order";var data=retrieveStorageValue(key);return data!=null;}
function showScreenFromHashParams(){hashParams=getURLHashParams();if(hashParams){if(hashParams.screen){if(hashParams.screen=='login'||current_user_id==null){showLoginScreen();}else if(hashParams.screen=='menu'){showMenuScreen();}else if(hashParams.screen=='totals'){}else if(hashParams.screen=='tables'){showTablesScreen();}else if(hashParams.screen=='more_options'){showMoreOptionsScreen();}
window.location.hash="";}}}
var utliKeypadClickFunction;var utilKeypadCancelFunction;function setUtilKeypad(position,clickFunction,cancelFunction){$(position).html($('#util_keypad_container').html());utliKeypadClickFunction=clickFunction;utilKeypadCancelFunction=cancelFunction;}
function utilKeypadClick(val){utliKeypadClickFunction(val);}
function doCancelUtilKeypad(){utilKeypadCancelFunction();}
var utilCounterTotalFunction;var utilCounterParent;function setUtilCoinCounter(position,totalFunction){utilCounterParent=$(position);$(position).html($('#coin_counter_widget_container').html());utilCounterParent.find('.total_amount_input').focus();utilCounterTotalFunction=totalFunction;}
function utilCounterTotalCalculated(total){utilCounterTotalFunction(total);}
function showMenuScreenDefaultPopup(popupHTML){popupAnchor=$('#menu_screen_default_popup_anchor');return showDefaultPopup(popupAnchor,popupHTML);}
function showTotalsScreenDefaultPopup(popupHTML){popupAnchor=$('#totals_screen_default_popup_anchor');return showDefaultPopup(popupAnchor,popupHTML);}
function showDefaultPopup(popupAnchor,popupHTML){if(popupAnchor.HasBubblePopup()){popupAnchor.RemoveBubblePopup();}
popupAnchor.CreateBubblePopup();popupAnchor.ShowBubblePopup({align:'center',innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme'},false);popupAnchor.FreezeBubblePopup();return popupAnchor;}
function hideMenuScreenDefaultPopup(){popupAnchor=$('#menu_screen_default_popup_anchor');hideScreenDefaultPopup(popupAnchor);}
function hideTotalsScreenDefaultPopup(){popupAnchor=$('#totals_screen_default_popup_anchor');hideScreenDefaultPopup(popupAnchor);}
function hideScreenDefaultPopup(popupAnchor){if(popupAnchor.HasBubblePopup()){popupAnchor.RemoveBubblePopup();popupAnchor.HideBubblePopup();popupAnchor.FreezeBubblePopup();}}
function displayError(message){setStatusMessage("Error: "+message);}
function displayNotice(message){setStatusMessage("Notice: "+message);}
function setStatusMessage(message,hide,shake){if(typeof hide=="undefined"){hide=true;}
if(typeof shake=="undefined"){shake=false;}
statusEl=null;if(currentScreenIsLogin()){statusEl=$('#login_screen_status_message')}else if(currentScreenIsMenu()){statusEl=$('#menu_screen_status_message');}else if(currentScreenIsTables()){statusEl=$('#tables_screen_status_message');}else if(currentScreenIsDelivery()){statusEl=$('#delivery_screen_status_message');}else if(currentScreenIsTotals()){statusEl=$('#totals_screen_status_message');}else if(inKitchenContext()){statusEl=$('#kitchen_screen_status_message');}else{niceAlert(message);return;}
afterFunction=null;if(hide){afterFunction=function(){setTimeout(function(){hideStatusMessage();},3000);};}
if(statusEl&&shake){shakeFunction=function(){statusEl.effect("shake",{times:3,distance:3},80);};setTimeout(shakeFunction,500);}
if(statusEl){statusEl.fadeIn('fast',afterFunction);statusEl.html(message);}else{afterFunction();}}
function hideStatusMessage(){if(currentScreenIsLogin()){statusEl=$('#login_screen_status_message')}else if(currentScreenIsMenu()){statusEl=$('#menu_screen_status_message');}else if(currentScreenIsTables()){statusEl=$('#tables_screen_status_message');}else if(currentScreenIsDelivery()){statusEl=$('#delivery_screen_status_message');}else if(currentScreenIsTotals()){statusEl=$('#totals_screen_status_message');}else if(inKitchenContext()){statusEl=$('#kitchen_screen_status_message');}else{hideNiceAlert();return;}
if(statusEl){statusEl.fadeOut();}}
function showLoginScreen(){clearNavTitle();hideAllScreens();$('#landing').show();var userIDS=getClockedInUsersIDS();for(var i=0;i<userIDS.length;i++){var nextUserID=userIDS[i];var nextTable0Order=getOrderFromStorage(nextUserID);if(nextTable0Order&&nextTable0Order.items&&nextTable0Order.items.length>0){$('#employee_box_'+nextUserID).addClass("has_active_t0_items");}else{$('#employee_box_'+nextUserID).removeClass("has_active_t0_items");}}
loginRecptScroll();}
function showMenuScreen(){clearNavTitle();hideNavBackLinkMenuScreen();hideAllScreens();showMenuItemsSubscreen();$('#menu_screen').show();if(menuScreenType==RESTAURANT_MENU_SCREEN){initMenuScreenNavItems();}else if(menuScreenType==RETAIL_MENU_SCREEN){$('#menu_screen_shortcut_dropdown_container').show();$('#scan_upc').focus();}
hideStatusMessage();}
function showTablesScreen(){setNavTitle("Table Selection");$('#nav_back_link').unbind();showNavBackLinkMenuScreen();$('#nav_back_link').click(function(){inTransferOrderMode=false;inTransferOrderItemMode=false;$('#tables_screen_status_message').hide();});hideAllScreens();$('#menu_screen_shortcut_dropdown_container').hide();$('#table_select_screen').show();initTableSelectScreen();}
function showUtilPaymentScreen(){setNavTitle("Make Payment");$('#nav_back_link').unbind();showNavBackLinkMenuScreen();$('#nav_back_link').click(function(){cancelUtilPayment();});hideAllScreens();$('#menu_screen_shortcut_dropdown_container').hide();$('#util_payment_screen').show();}
function showSplitBillScreen(){setNavTitle("Split Bill");$('#nav_back_link').unbind();showNavBackLinkMenuScreen();$('#nav_back_link').click(function(){inSplitBillMode=true;cancelSplitBillMode();});hideAllScreens();$('#menu_screen_shortcut_dropdown_container').hide();$('#split_bill_screen').show();}
function showTotalsScreen(){setNavTitle("Sub Total");hideAllScreens();$('#total_screen').show();}
function showDeliveryScreen(){setNavTitle("Receive Delivery");hideAllScreens();$('#delivery_screen').show();}
function showMoreOptionsScreen(){hideAllScreens();hideUtilKeyboard();$('#more_options').show();$('#menu_screen_shortcut_dropdown_container').hide();window.location.hash="#screen=more_options";}
function showCashReportsScreen(){hideAllScreens();$('#cash_reports_screen').show();}
function showFloatScreen(){hideAllScreens();$('#float_screen').show();}
function showMobileScreen(){hideAllScreens();$('#mobile_screen').show();}
function hideAllScreens(){resetKeyboard();menuScreenShortcutSelectMenu.closeMenu();tableSelectMenu.closeMenu();$('#landing').hide();$('#menu_screen').hide();$('#table_select_screen').hide();$('#total_screen').hide();$('#delivery_screen').hide();$('#util_payment_screen').hide();$('#more_options').hide();$('#cash_reports_screen').hide();$('#float_screen').hide();$('#mobile_screen').hide();$('#previous_cash_reports_screen').hide();$('#split_bill_screen').hide();}
function currentScreenIsMenu(){return $('#menu_screen').is(":visible");}
function currentScreenIsLogin(){return $('#landing').is(":visible");}
function currentScreenIsTotals(){return $('#total_screen').is(":visible");}
function currentScreenIsDelivery(){return $('#delivery_screen').is(":visible");}
function currentScreenIsUtilPayment(){return $('#util_payment_screen').is(":visible");}
function currentScreenIsCashReports(){return $('#cash_reports_screen').is(":visible");}
function currentScreenIsFloat(){return $('#float_screen').is(":visible");}
function currentScreenIsTables(){return $('#table_select_screen').is(":visible");}
function currentScreenIsSplitBill(){return $('#split_bill_screen').is(":visible");}
function showNavBackLinkMenuScreen(){$('#nav_back_link').show();$('#nav_back_link').click(function(){showMenuScreen();});}
function hideNavBackLinkMenuScreen(){$('#nav_back_link').hide();}
function doCoinCounterTotal(){totalAmountInputAmount=utilCounterParent.find('.total_amount_input').val();if(totalAmountInputAmount>0){utilCounterTotalCalculated(totalAmountInputAmount);return;}
valArray=new Array('10000','5000','2000','1000','500','200','100','50','20','10','5');var sum=0;for(var i=0;i<valArray.length;i++){amount=utilCounterParent.find('.coin_quantity_'+valArray[i]).val();if(amount==""||isNaN(amount)){amount=0;}
utilCounterParent.find('#coin_amount_'+valArray[i]).html(currency((parseFloat(amount)*parseFloat(valArray[i]))/100));sum+=((parseFloat(amount)*parseFloat(valArray[i]))/100);}
utilCounterParent.find('#coin_counter_total_amount').html(currency(sum));utilCounterTotalCalculated(sum);}
var toggleKeyboardEnable=true;function toggleUtilKeyboard(){if(!toggleKeyboardEnable){setStatusMessage("Toggling Keyboard disabled for this screen!");return;}
if($('#util_keyboard_container').is(":visible")){hideUtilKeyboard();}else{showUtilKeyboard();}}
function hideUtilKeyboard(){$('#util_keyboard_container').slideUp(300);}
function showUtilKeyboard(){$('#util_keyboard_container').slideDown(300);}
var lastActiveElementInputCallback=null;function setUtilKeyboardCallback(callbackFunction){lastActiveElementInputCallback=callbackFunction;}
function doWriteToLastActiveInput(val){if(lastActiveElement){doKeyboardInput(lastActiveElement,val);if(lastActiveElementInputCallback){lastActiveElementInputCallback.call();}}}
function doTabLastActiveInput(){if(lastActiveElement){lastActiveElement.focusNextInputField();}}
function doDeleteCharLastActiveInput(){if(lastActiveElement){doKeyboardInputCancel(lastActiveElement);if(lastActiveElementInputCallback){lastActiveElementInputCallback.call();}}}
$.fn.focusNextInputField=function(){return this.each(function(){var fields=$(this).parents('form:eq(0),body').find('button,input,textarea,select');var index=fields.index(this);if(index>-1&&(index+1)<fields.length){fields.eq(index+1).focus();}
return false;});};function initNavTitle(navTitle){if(navTitle.length>0){setNavTitle(navTitle);}else{clearNavTitle();}}
function setNavTitle(navTitle){$('#nav_title').html(navTitle);$('#nav_title').show();}
function clearNavTitle(){$('#nav_title').html("");$('#nav_title').hide();}
function inAdminContext(){return $('body div.admin').length>0;}
function inMenuContext(){return $('body div.menu').length>0;}
var activePopupElSet=null;function registerPopupClickHandler(popupEl,outsideClickHandler){activePopupElSet=$(popupEl);setTimeout(function(){$("body").click(function(eventObj){if(activePopupElSet&&(activePopupElSet.has(eventObj.target).length==0)){outsideClickHandler();}});},500);}
function hideBubblePopup(popupEl){if(typeof(popupEl)!='undefined'){popupEl.HideBubblePopup();popupEl.FreezeBubblePopup();$("body").unbind('click');activePopupElSet=null;}}
function initMcDropDowns(){$("#table_select_input").mcDropdown("#table_select",{maxRows:15,minRows:15});tableSelectMenu=$("#table_select_input").mcDropdown();$("#menu_screen_shortcut_dropdown_input").mcDropdown("#menu_screen_shortcut_dropdown",{maxRows:15,minRows:15,select:menuScreenDropdownItemSelected});menuScreenShortcutSelectMenu=$("#menu_screen_shortcut_dropdown_input").mcDropdown();setShortcutDropdownDefaultText();}
function getSelectedOrLastReceiptItem(){if(!currentSelectedReceiptItemEl){currentSelectedReceiptItemEl=$('#till_roll > div.order_line:last');if(currentSelectedReceiptItemEl.length==0){setStatusMessage("There are no receipt items!");return null;}}
return currentSelectedReceiptItemEl;}
function getLastReceiptItem(){lastReceiptItemEl=$('#till_roll > div.order_line:last');if(lastReceiptItemEl.length==0){setStatusMessage("There are no receipt items!");return null;}
return lastReceiptItemEl;}
function hideAllMenuSubScreens(){$('#menu_container').hide();$('.button[id=sales_button_'+modifyOrderItemButtonID+'], .button[id=admin_screen_button_'+modifyOrderItemButtonID+']').removeClass("selected");$('#order_item_additions').hide();$('#cash_out_subscreen').hide();}
function currentMenuSubscreenIsMenu(){return $('#menu_container').is(":visible");}
function currentMenuSubscreenIsModifyOrderItem(){return $('#order_item_additions').is(":visible");}
function currentMenuSubscreenIsCashOutSubscreen(){return $('#cash_out_subscreen').is(":visible");}
function initNoteScreenKeyboard(){toggleKeyboardEnable=false;var keyboardPlaceHolderEl=$('#add_note #keyboard')
var pos=keyboardPlaceHolderEl.offset();$("#util_keyboard_container").css({"position":"absolute","width":"688px","left":(pos.left)+"px","top":pos.top+"px"});hideUtilKeyboardCloseButton();$("#util_keyboard_container").show();}
function resetKeyboard(){toggleKeyboardEnable=true;$("#util_keyboard_container").css({"position":"fixed","width":"100%","top":"inherit","bottom":"0px","left":"0px"});showUtilKeyboardCloseButton();$("#util_keyboard_container").hide();}
function placeUtilKeyboard(keyboardPlaceHolderEl){toggleKeyboardEnable=false;var pos=keyboardPlaceHolderEl.offset();$("#util_keyboard_container").css({"position":"absolute","width":"688px","left":(pos.left)+"px","top":pos.top+"px"});hideUtilKeyboardCloseButton();$("#util_keyboard_container").show();}
function clickIE6(){if(event.button==2){return false;}}
function clickNS4(e){if(document.layers||document.getElementById&&!document.all){if(e.which==2||e.which==3){return false;}}}
function registerDisallowRightClick(){if(document.layers){document.captureEvents(Event.MOUSEDOWN);document.onmousedown=clickNS4;}else if(document.all&&!document.getElementById){document.onmousedown=clickIE6;}
document.oncontextmenu=new Function("return false");}
function postSetConnectionStatus(connected){var color="#00FF33";if(!connected){color="#FF0000";if(!callHomePollInitSequenceComplete){callHomePollInitSequenceComplete=true;$('#loading_orders_spinner').hide();$('#table_select_container_loading_message').hide();$('#table_select_container').show();$('#table_screen_button').show();}}
$('#connection_status').css("background-color",color);}
function initModifierGrid(){var rowWidth=$('div#order_item_additions .grid_row:first').css("width");var newWidth=roundNumberDown(parseFloat(rowWidth)/modifierGridXSize,0)-5;$('div#order_item_additions .grid_row .grid_item').css("width",newWidth+"px");var panelHeight=$('div#order_item_additions').css("height");panelHeight=parseFloat(panelHeight)-parseFloat($('#oia_tabs .tab').css("height"));var newHeight=roundNumberDown(parseFloat(panelHeight)/modifierGridYSize,0)-6;$('div#order_item_additions .grid_row .grid_item').css("height",newHeight+"px");}
function rollDate(){var dateFormat="dd MMM";var formattedDate=formatDate(new Date(clueyTimestamp()),dateFormat);$('#date').html(formattedDate);}
var licenceExpiredScreenShownLastTime=0;var fifteenMinsMillis=15*60*1000;function testShowLicenceExpiredScreen(){if(showLicenceExpiredScreen){var now=clueyTimestamp();if((now-licenceExpiredScreenShownLastTime)>=fifteenMinsMillis){licenceExpiredScreenShownLastTime=now;doShowLicenceExpiredScreen();}}}
function doShowLicenceExpiredScreen(){hideLicenceExpiredScreen();var title="Licence Expired!";var headerMessage="Your system licence has expired or is not active. Please contact Cluey Systems as below to activate:";var numbersMessage="<div id='numbers_message'><div>Cluey UK Tel:</br> +4420 8588 0600</div><div>Cluey Ireland Tel:</br> +353 1 489 3600</div></div>"+clearHTML;var ceaseMessage="Your system will cease to function unless you contact us!";ModalPopups.Alert('licenceExpiredMessageContainer',title,"<div id='nice_alert' class='licence_expired_header'>"+headerMessage+"</div>"+"<div id='numbers'>"+numbersMessage+"</div>"+"<div id='cease_message'>"+ceaseMessage+"</div>",{width:760,height:560,okButtonText:'Ok',onOk:"hideLicenceExpiredScreen()"});}
function hideLicenceExpiredScreen(){try{ModalPopups.Close('licenceExpiredMessageContainer');}catch(e){}}
function initTrainingModeFromCookie(){if(getRawCookie(inTrainingModeCookieName)==null){var exdays=365*100;setRawCookie(inTrainingModeCookieName,false,exdays);}
var turnOn=getRawCookie(inTrainingModeCookieName)==="true";setTrainingMode(turnOn);}
function hideUtilKeyboardCloseButton(){$('#close_keyboard_link').hide();$('#util_keyboard_inner_container').height("230px");}
function showUtilKeyboardCloseButton(){$('#close_keyboard_link').show();$('#util_keyboard_inner_container').height("260px");}
function checkForFirefox(){var ua=$.browser;if(typeof(ua.mozilla)=='undefined'){niceAlert("You must use the firefox web browser in order to print receipts and operate cash drawers within the Cluey software!");return false;}
return true;}
function checkForClueyPlugin(){if(!checkForFirefox()){return false;}
if(typeof(cluey_ff_ext)=='undefined'){var clueyExtensionDownloadPopup=function(){var title="Cluey Addon Not Found";hideNiceAlert();ModalPopups.Alert('niceAlertContainer',title,"<div id='nice_alert' class='licence_expired_header'>Cluey Firefox Extension Not Found. You can download it by clicking OK. You must then install it via firefox.</div>",{width:360,height:310,okButtonText:'Download',onOk:"goToNewWindow(\"/firefox_extensions/cluey_ff_extension.xpi\");hideNiceAlert();"});};indicateActionRequired(clueyExtensionDownloadPopup);return false;}else{console.log("Setting cluey prefs in plugin");cluey_ff_ext.setClueyPrefs();return true;}}
function checkForJSPrintSetupPlugin(){if(typeof(jsPrintSetup)=='undefined'){var jsPrintExtensionDownloadPopup=function(){var title="jsPrintSetup Firefox Addon Not Found";hideNiceAlert();ModalPopups.Alert('niceAlertContainer',title,"<div id='nice_alert' class='licence_expired_header'>jsPrintSetup Firefox Addon Not Found. You can download it by clicking OK. You must then install it via firefox.</div>",{width:360,height:310,okButtonText:'Download',onOk:"goToNewWindow(\"/firefox_extensions/jsprintsetup-0.9.2.xpi\");hideNiceAlert();"});};indicateActionRequired(jsPrintExtensionDownloadPopup);return false;}else{return true;}}
var localPrinters;var newLocalPrinters=new Array();var notFoundPrinterIDs=new Array();function checkForUninstalledPrinters(){var printersString=jsPrintSetup.getPrintersList();if(printersString!=null){localPrinters=printersString.split(",");}else{localPrinters=new Array();}
console.log("Found "+localPrinters.length+" local printers");for(i=0;i<localPrinters.length;i++){var nextLocalPrinterNetworkPath=localPrinters[i].toLowerCase();localPrinters[i]=nextLocalPrinterNetworkPath;console.log("Local Printer "+(i+1)+": "+nextLocalPrinterNetworkPath);if($.inArray(nextLocalPrinterNetworkPath,printerNetworkPaths)==-1){newLocalPrinters.push(nextLocalPrinterNetworkPath);}}
console.log("Got "+printers.length+" system printers");for(i=0;i<printers.length;i++){var nextSystemPrinterNetworkPath=printers[i].network_path.toLowerCase();console.log("System Printer "+(i+1)+": "+printers[i].network_path.toLowerCase());for(j=0;j<localPrinters.length;j++){console.log("LP "+(j+1)+": "+localPrinters[j]);}
if($.inArray(nextSystemPrinterNetworkPath,localPrinters)==-1){notFoundPrinterIDs.push(printers[i].id);}}
console.log("There are "+newLocalPrinters.length+" new local printers on your system");for(i=0;i<newLocalPrinters.length;i++){var nextNewLocalPrinterNetworkPath=newLocalPrinters[i].toLowerCase();console.log("New Local Printer "+(i+1)+": "+nextNewLocalPrinterNetworkPath);}
console.log("There are "+notFoundPrinterIDs.length+" printers not found on your system");var notFoundPrintersNetworkPaths=new Array();for(i=0;i<notFoundPrinterIDs.length;i++){var nextNotFoudnPrinter=printersByID[notFoundPrinterIDs[i]];var nextNotFoudnPrinterNetworkPath=nextNotFoudnPrinter.network_path.toLowerCase();console.log("Not Found Printer "+(i+1)+": "+nextNotFoudnPrinterNetworkPath);notFoundPrintersNetworkPaths.push(nextNotFoudnPrinterNetworkPath);}
var localPrinter=printersByID[localPrinterID];if(localPrinter){if($.inArray(localPrinter.network_path.toLowerCase(),localPrinters)==-1){notFoundPrinterIDs.push(localPrinter.id);}}
notFoundPrintersNetworkPaths=["a"];if(notFoundPrintersNetworkPaths.length>0){var title="Printers Not Installed";indicateActionRequired(function(){niceAlert("Warning... The following printers are not installed on this terminal: "+notFoundPrintersNetworkPaths.join(","),title);});return false;}else{return true;}}
function generateBrowserSessionId(){generatedBrowserSessionId=Math.uuid();storeKeyValue(browserSessionIdStorageKey,generatedBrowserSessionId);console.log("Set browser session id to: "+generatedBrowserSessionId);}
function checkForDuplicateBrowserSession(){var storedBrowserSessionId=retrieveStorageValue(browserSessionIdStorageKey);if(generatedBrowserSessionId!=storedBrowserSessionId){niceAlert("Another browser tab is open for the cluey app. This tab will now close.");window.close();}}
var actionFunction=null;function indicateActionRequired(functionToPerform){actionFunction=functionToPerform;$('.sales_resources_reload_indicator').show();}
function actionRequiredClicked(){$('.sales_resources_reload_indicator').hide();actionFunction.call();}
function fetchOrderReceiptHTML(order){totalOrder=currentOrder=order;orderReceiptHTML=fetchFinalReceiptHeaderHTML();allOrderItemsRecptHTML=getAllOrderItemsReceiptHTML(currentOrder,false,false,true);orderReceiptHTML+=clearHTML+allOrderItemsRecptHTML;var subTotal=currentOrder.total;if(currentOrder.discount_percent){preDiscountAmount=currentOrder.pre_discount_price;orderReceiptHTML+=clearHTML+"<div class='whole_order_discount'>";orderReceiptHTML+="Discounted "+currentOrder.discount_percent+"% from "+currency(preDiscountAmount)+"</div>";}
orderReceiptHTML+="<div class='data_table'>";subTotal=currentOrder.total;orderReceiptHTML+="<div class='label'>Sub-Total:</div><div class='data'>"+currency(subTotal)+"</div>"+clearHTML;orderReceiptHTML+="</div>"+clearHTML;return orderReceiptHTML;}
function printItemsFromOrder(printerID,serverNickname,order,items){var allOrderItemsReceiptHTML="<div class='order_receipt'>";allOrderItemsReceiptHTML+=getPrintedOrderReceiptHeader(serverNickname,order);for(var i=0;i<items.length;i++){var item=items[i];allOrderItemsReceiptHTML+=getLineItemHTMLForPrintedOrderReceipt(item);}
allOrderItemsReceiptHTML+="</div>";printReceipt(allOrderItemsReceiptHTML,false,printerID);}
function getLineItemHTMLForPrintedOrderReceipt(orderItem){var courseLineClass=orderItem.is_course?"course":"";var lineItemHTMLForOrder="<div class='order_line "+courseLineClass+"'>";if(!orderItem.product.hide_on_printed_receipt){lineItemHTMLForOrder+="<div class='amount'>"+orderItem.amount+"</div>";}
lineItemHTMLForOrder+="<div class='name'>";if(orderItem.is_double){lineItemHTMLForOrder+="Double ";}else if(orderItem.is_half){lineItemHTMLForOrder+=halfMeasureLabel+" ";}
lineItemHTMLForOrder+=orderItem.product.name+"</div>";lineItemHTMLForOrder+="<div class='total'>&nbsp;</div>";if(orderItem.show_course_label){lineItemHTMLForOrder+="<div class='clear'>&nbsp;</div>";lineItemHTMLForOrder+="<div class='course_label'>Serve As: "+courseLabels[parseInt(orderItem.product.course_num)]+"</div>";}
if(orderItem.modifier){lineItemHTMLForOrder+="<div class='clear'>&nbsp;</div>";lineItemHTMLForOrder+="<div class='modifier_name'>"+orderItem.modifier.name+"</div>"+clearHTML;}
if(orderItem.oia_items){for(var j=0;j<orderItem.oia_items.length;j++){oia_is_add=orderItem.oia_items[j].is_add;lineItemHTMLForOrder+="<div class='oia_name "+(orderItem.oia_items[j].is_note?"note":"")+"'>";if(!orderItem.oia_items[j].is_note){if(orderItem.oia_items[j].is_addable){lineItemHTMLForOrder+=oia_is_add?"Add ":"No ";}}
lineItemHTMLForOrder+=orderItem.oia_items[j].description+"</div>"+clearHTML;}}
lineItemHTMLForOrder+="</div>"+clearHTML;return lineItemHTMLForOrder;}
function getPrintedOrderReceiptHeader(serverNickname,order){var headerHTML="<div id='order_receipt_header'>";var orderNum=order.order_num;if(typeof(orderNum)!='undefined'){headerHTML+="<div class='order_num'>ORDER NO: "+orderNum+"</div>"+clearHTML;}
headerHTML+="<div class='data_table'>";var tableLabel=order.table;headerHTML+="<div class='label'>Table:</div><div class='data'>"+tableLabel+"</div>"+clearHTML;headerHTML+="<div class='label'>Order By:</div><div class='data'>"+serverNickname+"</div>"+clearHTML;headerHTML+="</div>"+clearHTML;var timestamp=utilFormatDate(new Date(clueyTimestamp()));headerHTML+="<div class='time data'>"+timestamp+"</div>";headerHTML+="<div class='terminal'>"+terminalID+"</div>"+clearHTML;headerHTML+="</div>"+clear10BottomBorderHTML+clear10HTML;return headerHTML;}
function fetchCashScreenReceiptTotalsDataTable(){var cashScreenReceiptTotalsDataTableHTML="<div class='data_table'>";if(totalOrder.discount_percent){subTotal=parseFloat(totalOrder.pre_discount_price);cashScreenReceiptTotalsDataTableHTML+="<div class='label'>Sub-Total:</div><div class='data'>"+currency(subTotal)+"</div>"+clearHTML;discountAmount=(totalOrder.pre_discount_price*totalOrder.discount_percent)/100;cashScreenReceiptTotalsDataTableHTML+="<div class='label'>Discount "+totalOrder.discount_percent+"%:</div><div class='data'>"+currency(discountAmount)+"</div>"+clearHTML;}else{subTotal=parseFloat(totalOrder.total);cashScreenReceiptTotalsDataTableHTML+="<div class='label'>Sub-Total:</div><div class='data'>"+currency(subTotal)+"</div>"+clearHTML;discountAmount=0;}
cashScreenReceiptTotalsDataTableHTML+=taxChargable?fetchTotalsHTMLWithTaxChargable():fetchTotalsWithoutTaxChargableHTML();cashScreenReceiptTotalsDataTableHTML+=clearHTML;cashScreenReceiptTotalsDataTableHTML+="</div>"+clearHTML;return cashScreenReceiptTotalsDataTableHTML;}
function fetchCashScreenReceiptHTML(){var cashScreenReceiptHTML=fetchCashScreenReceiptHeaderHTML()+clearHTML;cashScreenReceiptHTML+=getAllOrderItemsReceiptHTML(totalOrder,false,false,true)+clearHTML;return cashScreenReceiptHTML;}
function fetchCashScreenReceiptHeaderHTML(){var headerHTML="<div class='data_table'>";headerHTML+="<div class='label'>Server:</div><div class='data'>"+current_user_nickname+"</div>"+clearHTML;timestamp=utilFormatDate(new Date(parseInt(orderStartTime(totalOrder))));headerHTML+="<div class='time label'>Time Started:</div><div class='time data'>"+timestamp+"</div>"+clearHTML;if(selectedTable!=0){selectedTableLabel=tables[selectedTable].label;headerHTML+="<div class='label'>Table:</div><div class='data'>"+selectedTableLabel+"</div>"+clearHTML;}
var orderNum=totalOrder.order_num;if(typeof(orderNum)!='undefined'){headerHTML+="<div class='label'>Order Number:</div><div class='data'>"+orderNum+"</div>"+clearHTML;}
headerHTML+="</div>";return headerHTML;}
function getTillRollServiceChargeHTML(order){if(order.service_charge&&parseFloat(order.service_charge)>0){serviceChargeAmountFormatted=currency(parseFloat(order.service_charge));tillRollServiceChargeHTML=clearHTML+"<div class='data_table'><div class='label'>Service Charge</div>";tillRollServiceChargeHTML+="<div class='data'>"+serviceChargeAmountFormatted+"</div>"+clearHTML+"</div>";}else{tillRollServiceChargeHTML="";}
return tillRollServiceChargeHTML;}
function getTillRollDiscountHTML(order){if(order.discount_percent&&parseFloat(order.discount_percent)>0){preDiscountPrice=order.pre_discount_price;preDiscountFormatted=currency(preDiscountPrice);discountAmountFormatted=currency(order.pre_discount_price-order.total);tillRollDiscountHTML=clearHTML+"<div class='data_table'><div class='label'>Pre-Discount Price</div>";tillRollDiscountHTML+="<div class='data'>"+preDiscountFormatted+"</div>";tillRollDiscountHTML+="<div class='label'>Discount - "+order.discount_percent+"%</div>";tillRollDiscountHTML+="<div class='data'>"+discountAmountFormatted+"</div>"+clearHTML+"</div>";}else{tillRollDiscountHTML="";}
return tillRollDiscountHTML;}
function clearReceipt(){$('#till_roll').html('');$('#total_value').html(currency(0));$('#till_roll_service_charge').html('');$('#till_roll_discount').html('');}
function setLoginReceipt(title,contentHTML){$('#login_receipt_header').html(title);$('#login_till_roll').html(contentHTML);receiptData=JSON.stringify({'title':title,'contentHTML':contentHTML});storeKeyValue("last_sale",receiptData);}
function clearLoginReceipt(){$('#login_receipt_header').html("Receipt");$('#login_till_roll').html("");}
function getLastSaleInfo(){saleData=retrieveStorageValue("last_sale");if(saleData!=null){return JSON.parse(saleData);}else{return null;}}
function displayLastReceipt(){var lastReceiptID=fetchLastReceiptID(current_user_id);if(!tables[lastReceiptID]){lastReceiptID=0;}
tableSelectMenu.setValue(lastReceiptID);doSelectTable(lastReceiptID);}
function getCurrentRecptHTML(){return fetchOrderReceiptHTML(getCurrentOrder());}
var breakUserIDS=null;var clockedInUserIDS=null;var loginActionInProcess=false;function initUsers(){initClockedInUsers();initBreakUsers();}
function initClockedInUsers(){clockedInUserIDS=getClockedInUsersIDS();for(var i=0;i<employees.length;i++){var currentEmployee=employees[i];if(($.inArray(currentEmployee.id.toString(),clockedInUserIDS)!=-1)){currentEmployee.clocked_in=true;$('#employee_box_'+currentEmployee.id).show();}}}
function initBreakUsers(){breakUserIDS=getBreakUsersIDS();for(var i=0;i<employees.length;i++){var currentEmployee=employees[i]
if(($.inArray(currentEmployee.id.toString(),breakUserIDS)!=-1)){$('#employee_box_'+currentEmployee.id).addClass("on_break");}}}
function doQuickLogin(user_id){for(var i=0;i<employees.length;i++){id=employees[i].id;if(id==user_id){user_index=i;break;}}
var allowedQuickLogin=null;if(bypassPin){rolePinRequired=employees[user_index].pin_required;allowedQuickLogin=!rolePinRequired;}else{allowedQuickLogin=false;}
if(allowedQuickLogin){login_code=employees[user_index].passcode;$('#num').val(login_code);doLogin();}else{setStatusMessage("Enter PIN!",false,true);}
$('#num').focus();}
function loginScreenKeypadClick(val){var newVal=$('#num').val().toString()+val;$('#clockincode_show').html($('#clockincode_show').html()+"*");$('#num').val(newVal);}
function doCancelLoginKeypad(){$('#clockincode_show').html("");$('#num').val("");}
function doDallasLogin(){entered_code=$('#num').val();if(current_user_id!=null){displayError("You are already logged in. Please log out!");return;}
for(var i=0;i<employees.length;i++){passcode=employees[i].dallas_code;if(entered_code==passcode){nickname=employees[i].nickname;if(employees[i]['clocked_in']){id=employees[i].id;if(userOnBreak(id)){setStatusMessage("User is on break!");clearClockinCode();return;}
if(!employeeForID(id).login_allowed){setStatusMessage("User not allowed login!");clearClockinCode();return;}
is_admin=employees[i].is_admin;loginSuccess(id,nickname,is_admin,passcode);return;}else{setStatusMessage("User "+nickname+" is not clocked in!",true,true);clearClockinCode();return;}}}
loginFailure();}
function doLogin(){entered_code=$('#num').val();if(current_user_id!=null){displayError("You are already logged in. Please log out!");return;}
for(var i=0;i<employees.length;i++){passcode=employees[i].passcode;if(entered_code==passcode){nickname=employees[i].nickname;if(employees[i]['clocked_in']){if(employees[i].dallas_code==""){id=employees[i].id;if(userOnBreak(id)){setStatusMessage("User is on break!");clearClockinCode();return;}
if(!employeeForID(id).login_allowed){setStatusMessage("User not allowed login!");clearClockinCode();return;}
is_admin=employees[i].is_admin;loginSuccess(id,nickname,is_admin,passcode);}else{setStatusMessage("Not Allowed! Please use iButton",true,true);clearClockinCode();}
return;}else{setStatusMessage("User "+nickname+" is not clocked in!",true,true);clearClockinCode();return;}}}
loginFailure();}
function doLogout(){if(current_user_id==null){return;}
var id_for_logout=current_user_id;current_user_id=null;storeActiveUserID(null);showLoginScreen();clearClockinCode();clearMenuScreenInput();$('#nav_save_button').hide();$('#menu_screen_shortcut_dropdown_container').hide();$('#nav_util_button_clear_reload').hide();$('#nav_util_button_reset_timestamp').hide();$('#e_name').hide();$('#num').blur();$.ajax({type:'POST',url:'/logout',data:{employee_id:id_for_logout}});}
function doClockin(){entered_code=$('#num').val();if(employees.length==0){setStatusMessage("Please try again... system initializing...");return;}
for(var i=0;i<employees.length;i++){id=employees[i].id
nickname=employees[i].nickname
clockinCode=employees[i].clockin_code;is_admin=employees[i].is_admin;if(entered_code==clockinCode){if(employees[i]['clocked_in']){setStatusMessage(nickname+" is already clocked in!");clearClockinCode();return;}
employees[i]['clocked_in']=true;clockinSuccess(id,nickname);return;}}
clockinFailure();}
function doClockout(){entered_code=$('#num').val();for(var i=0;i<employees.length;i++){id=employees[i].id
nickname=employees[i].nickname
clockinCode=employees[i].clockin_code;is_admin=employees[i].is_admin;if(entered_code==clockinCode){if(employees[i]['clocked_in']==false){clockoutFailure();return;}
if(userOnBreak(id)){setStatusMessage("User is on break!");clearClockinCode();return;}
employees[i]['clocked_in']=false;clockoutSuccess(id,nickname);return;}}
clockoutFailure();}
function clockinSuccess(id,nickname){clearClockinCode();addClockedInUser(id);if(employeeForID(id).login_allowed){$('#employee_box_'+id).show();}
setStatusMessage(nickname+" clocked in successfully!");$.ajax({type:'POST',url:'/clockin',data:{employee_id:id}});}
function clockoutSuccess(id,nickname){clearClockinCode();removeClockedInUser(id);$('#employee_box_'+id).hide();setStatusMessage(nickname+" clocked out successfully!");$.ajax({type:'POST',url:'/clockout',data:{employee_id:id}});}
function loginSuccess(id,nickname,is_admin,passcode){current_user_id=id;last_user_id=current_user_id;current_user_nickname=nickname;current_user_is_admin=is_admin;current_user_passcode=passcode;storeActiveUserID(current_user_id);$.ajax({type:'POST',url:'/login',data:{employee_id:id}});showingPassCodeDialog=false;$('#e_name').html(nickname);hideStatusMessage();showMenuScreen();initMenuScreenNavItems();loadCurrentOrder();tableSelectMenu.setValue(0);doSelectTable(0);loadFirstMenuPage();initOptionButtons();if(defaultPostLoginScreen==TABLES_SCREEN){showTablesScreen();}
clearClockinCode();if(havePreviousOrder(current_user_id)){$('#previous_order_select_item').show();}else{$('#previous_order_select_item').hide();}
if(haveSplitBillOrder(current_user_id)){$('#split_bill_select_item').show();}else{$('#split_bill_select_item').hide();}}
function clockinFailure(){setStatusMessage("Wrong clock in code!",true,true);clearClockinCode();}
function clockoutFailure(){setStatusMessage("You are either not clocked in, or entered the wrong code!",true,true);clearClockinCode();}
function loginFailure(){setStatusMessage("Wrong pass code!",true,true);clearClockinCode();}
function clearClockinCode(){$('#num').val("");$('#clockincode_show').html("");}
function doBreak(){entered_code=$('#num').val();if(current_user_id!=null){displayError("You are already logged in. Please log out!");return;}
for(var i=0;i<employees.length;i++){passcode=employees[i].passcode;if(entered_code==passcode){nickname=employees[i].nickname;if(employees[i]['clocked_in']){id=employees[i].id;if(userOnBreak(id)){breakOutSuccess(id,nickname);}else{breakInSuccess(id,nickname);}
return;}else{setStatusMessage("User "+nickname+" is not clocked in!",true,true);clearClockinCode();return;}}}
doBreakFailure();}
function breakInSuccess(id,nickname){clearClockinCode();setStatusMessage(nickname+" started break!");$.ajax({type:'POST',url:'/break_in',data:{id:id}});addBreakUser(id);$('#employee_box_'+id).addClass("on_break");}
function breakOutSuccess(id,nickname){clearClockinCode();setStatusMessage(nickname+" finished break!");$.ajax({type:'POST',url:'/break_out',data:{id:id}});removeBreakUser(id);$('#employee_box_'+id).removeClass("on_break");}
function doBreakFailure(){setStatusMessage("Wrong pass code!",true,true);clearClockinCode();}
function userOnBreak(userId){var breakUserIDS=getBreakUsersIDS();return $.inArray(userId.toString(),breakUserIDS)!=-1;}
function getWorkReportDataTable(work_report_data){var work_report_data_html="<div class='data_table'>";for(var i=0;i<work_report_data.length;i++){var show_currency=work_report_data[i][2];var wider_date_column=work_report_data[i][3];var widerDateColumnClass=wider_date_column?" date":""
work_report_data_html+="<div class='label"+widerDateColumnClass+"'>"+work_report_data[i][0]+"</div>";work_report_data_html+="<div class='data"+widerDateColumnClass+"'>"+(show_currency&&(!isNaN(parseFloat(work_report_data[i][1])))?currency(work_report_data[i][1]):work_report_data[i][1])+"</div>"+clearHTML;}
work_report_data_html+="</div>";return work_report_data_html;}
var dallasKeyCode="";var dallasKeyLoginPrefix='a"';var dallasKeyLogoutPrefix='u"';var dallasKeyLoginListener=function(){dallasKeyCode="";$('#num').val("");$(window).bind('keypress',dallasKeyLoginCodeReader);};var dallasKeyLogoutListener=function(){if(inMenuContext()){console.log("Dallas Logout");doLogout();}};var dallasKeyLoginCodeReader=function(event){if(getEventKeyCode(event)==13){$(window).unbind('keypress',dallasKeyLoginCodeReader);dallasKeyCode=dallasKeyCode.substring(0,12);console.log("Dallas Key Login for code: "+dallasKeyCode);$('#num').val(dallasKeyCode);doDallasLogin();dallasKeyCode="";}
dallasKeyCode+=String.fromCharCode(getEventKeyCode(event));};function initDallasKeyListeners(){$(window).keySequenceDetector(dallasKeyLoginPrefix,dallasKeyLoginListener);$(window).keySequenceDetector(dallasKeyLogoutPrefix,dallasKeyLogoutListener);}
var cashTotalInOperation=false;function getCashTotalDataTable(cash_total_data,show_currency){if(typeof(show_currency)=="undefined"){show_currency=true}
cash_total_data_html="<div class='data_table'>";for(var i=0;i<cash_total_data.length;i++){var timeClass="";if(cash_total_data[i][0]=="Date"){timeClass="time";}
cash_total_data_html+="<div class='label "+timeClass+"'>"+cash_total_data[i][0]+"</div>";cash_total_data_html+="<div class='data "+timeClass+"'>"+(show_currency&&(!isNaN(parseFloat(cash_total_data[i][1])))?currency(cash_total_data[i][1]):cash_total_data[i][1])+"</div>"+clearHTML;}
cash_total_data_html+="</div>";return cash_total_data_html;}
function getCashTotalSalesByProductDataTable(products_data){cash_total_data_html="<div class='products_data_table'>";cash_total_data_html+="<div class='products_data_table_label_header'>Product</div>";cash_total_data_html+="<div class='products_data_table_header quantity'>Qty</div>";cash_total_data_html+="<div class='products_data_table_header'>Total</div>"+clear10HTML;for(var i=0;i<products_data.length;i++){cash_total_data_html+="<div class='products_label'>"+products_data[i][0]+"</div>";cash_total_data_html+="<div class='products_data quantity'>"+products_data[i][1]+"</div>";cash_total_data_html+="<div class='products_data'>"+currency(products_data[i][2])+"</div>"+clearHTML;}
cash_total_data_html+="</div>";return cash_total_data_html;}
function getCashTotalVoidsByEmployeeDataTable(employee_data){cash_total_data_html="<div class='products_data_table'>";cash_total_data_html+="<div class='products_data_table_label_header'>Employee</div>";cash_total_data_html+="<div class='products_data_table_header quantity'>Qty</div>";cash_total_data_html+="<div class='products_data_table_header'>Total</div>"+clear10HTML;for(var i=0;i<employee_data.length;i++){cash_total_data_html+="<div class='products_label'>"+employee_data[i][0]+"</div>";cash_total_data_html+="<div class='products_data quantity'>"+employee_data[i][1]+"</div>";cash_total_data_html+="<div class='products_data'>"+currency(employee_data[i][2])+"</div>"+clearHTML;}
cash_total_data_html+="</div>";return cash_total_data_html;}
function getCashTotalCashOutDataTable(cash_out_data){var cash_out_data_html="<div class='cash_out_data_table data_table'>";cash_out_data_html+="<div class='cash_out_data_table_description_header'>Description</div>";cash_out_data_html+="<div class='cash_out_data_table_amount_header quantity'>Amount</div>"+clear10HTML;for(var i=0;i<cash_out_data.length;i++){cash_out_data_html+="<div class='cash_out_description label'>"+cash_out_data[i][0]+"</div>";cash_out_data_html+="<div class='cash_out_amount data'>"+currency(cash_out_data[i][1])+"</div>"+clearHTML;}
cash_out_data_html+="</div>";return cash_out_data_html;}
function getCashTotalAccountPaymentsDataTable(account_payments_data){var account_payments_data_html="<div class='account_payments_data_table data_table'>";account_payments_data_html+="<div class='account_payments_data_table_customer_name_header'>Customer</div>";account_payments_data_html+="<div class='account_payments_data_table_amount_header quantity'>Amount</div>"+clear10HTML;for(var i=0;i<account_payments_data.length;i++){account_payments_data_html+="<div class='cash_out_customer_name label'>"+account_payments_data[i][0]+"</div>";account_payments_data_html+="<div class='cash_out_amount data'>"+currency(account_payments_data[i][1])+"</div>"+clearHTML;}
account_payments_data_html+="</div>";return account_payments_data_html;}
function getCashTotalTaxesDataTable(taxes_data){cash_total_data_html="<div class='taxes_data_table'>";cash_total_data_html+="<div class='taxes_data_table_label_header'>Rate</div>";cash_total_data_html+="<div class='taxes_data_table_header'>Net</div>";cash_total_data_html+="<div class='taxes_data_table_header'>"+taxLabel+"</div>";cash_total_data_html+="<div class='taxes_data_table_header'>Gross</div>"+clear10HTML;for(var i=0;i<taxes_data.length;i++){cash_total_data_html+="<div class='taxes_label'>"+taxes_data[i][0]+"%</div>";cash_total_data_html+="<div class='taxes_data'>"+currency(taxes_data[i][1])+"</div>";cash_total_data_html+="<div class='taxes_data'>"+currency(taxes_data[i][2])+"</div>";cash_total_data_html+="<div class='taxes_data'>"+currency(taxes_data[i][3])+"</div>"+clearHTML;}
cash_total_data_html+="</div>";return cash_total_data_html;}
function getCashTotalDataTableTotals(label,data){totals_html="<div class='totals_data_table'>";totals_html+="<div class='totals_label'>"+label+"</div>";total=0;for(var i=0;i<data.length;i++){total+=parseFloat(data[i][1]);}
totals_html+="<div class='totals_data'>"+currency(total)+"</div></div>"+clearHTML;return totals_html;}
function getCashTotalTotal(data){var total=0;for(var i=0;i<data.length;i++){total+=parseFloat(data[i][1]);}
return total;}
function getCashTotalTaxesDataTableTotals(label,data){taxes_totals_html="<div class='taxes_totals_data_table'>";taxes_totals_html+="<div class='taxes_totals_label'>"+label+"</div>";netTotal=0;taxTotal=0;grossTotal=0;for(var i=0;i<data.length;i++){netTotal+=parseFloat(data[i][1]);taxTotal+=parseFloat(data[i][2]);grossTotal+=parseFloat(data[i][3]);}
taxes_totals_html+="<div class='taxes_totals_data'>"+currency(netTotal)+"</div>";taxes_totals_html+="<div class='taxes_totals_data'>"+currency(taxTotal)+"</div>";taxes_totals_html+="<div class='taxes_totals_data'>"+currency(grossTotal)+"</div>";taxes_totals_html+="</div>"+clearHTML;return taxes_totals_html;}
var reportsCashCount=0;var currentTotalType=null;function doCashTotalReport(total_type,commit){if(cashTotalInOperation){niceAlert("Cash Total is in operation, please wait!");return;}
cashTotalInOperation=true;setNavTitle(total_type+" Total");showNavBackLinkMenuScreen();$('#reports_left_till_roll').html("Please Wait...");$('#cash_total_data_table_container').html("Please Wait...");currentTotalType=total_type;if(!commit){show_currency=false;}
coinCounterPosition=$('#reports_coin_counter_widget_container');totalFunction=function(total){reportsCashCount=total;};setUtilCoinCounter(coinCounterPosition,totalFunction);$('#menu_screen_shortcut_dropdown_container').hide();showCashReportsScreen();if(reportsCashCount==0){doCoinCounterTotal();}
$.ajax({type:'POST',url:'/cash_total.js',data:{total_type:total_type,cash_count:reportsCashCount,open_orders_total:getOpenOrdersTotal(),commit:commit},error:function(){niceAlert("An error has occured!");$('#cash_total_data_table_container').html("Error!");},complete:function(){cashTotalInOperation=false;}});$.ajax({type:'GET',url:'/cash_total_history.js'});}
function saveCashReportCoinCount(){if(cashTotalInOperation){niceAlert("Cash Total is in operation, please wait!");return;}
doCoinCounterTotal();doCashTotalReport(currentTotalType,false);}
function cancelCashReportCoinCount(){reportsCashCount=0;currentTotalType=null;showMenuScreen();}
function cashReportsScreenKeypadClick(val){lastActiveElement.val(lastActiveElement.val()+val);}
function cashReportsScreenKeypadClickCancel(){oldVal=lastActiveElement.val();newVal=oldVal.substring(0,oldVal.length-1);lastActiveElement.val(newVal);}
function cashReportsScreenKeypadClickTab(){lastActiveElement.focusNextInputField();}
function finishCashTotal(){if(cashTotalInOperation){niceAlert("Cash Total is in operation, please wait!");return;}
$('#cash_totals_header_section').show();content=$('#reports_center_till_roll').html()+clear10HTML;doCashTotalReport(currentTotalType,true);showMenuScreen();printReceipt(content,false);cash_totals_data_html_header_info=null;reportsCashCount=0;currentTotalType=null;}
function saveFloatCoinCount(){doCoinCounterTotal();if(floatTotal>0){$.ajax({type:'POST',url:'/add_float.js',data:{float_total:floatTotal}});}
floatTotal=0;showMenuScreen();setStatusMessage("Float Added!");}
function cancelFloatCoinCount(){floatTotal=0;showMenuScreen();}
function floatScreenKeypadClick(val){lastActiveElement.val(lastActiveElement.val()+val);}
function floatScreenKeypadClickCancel(){oldVal=lastActiveElement.val();newVal=oldVal.substring(0,oldVal.length-1);lastActiveElement.val(newVal);}
function floatScreenKeypadClickTab(){lastActiveElement.focusNextInputField();}
function getOpenOrdersTotal(){var savedTableID=selectedTable;var tableIDS=getActiveTableIDS();var total=0;for(var i=0;i<tableIDS.length;i++){getTableOrderFromStorage(current_user_id,tableIDS[i]);}
for(var u=0;u<tableIDS.length;u++){var thisOrderTotal=roundNumber(parseFloat(tableOrders[parseInt(tableIDS[u])].total),2);total+=thisOrderTotal;}
if(savedTableID!=-1){getTableOrderFromStorage(current_user_id,savedTableID);}
return total;}
var currentCCReferenceNumber;var splitPayments;var disallowCancelSaleCC=false;function updateTotalTendered(){var totalCashTendered=getTotalTendered();if(isNaN(parseFloat(totalCashTendered))){totalCashTendered=0;}
var formattedVal=currency(totalCashTendered,false);$('#totals_tendered_value').html(formattedVal);if(totalCashTendered>0){$('#totals_tendered_box').css("font-size","15px");$('#totals_tendered_box').css("font-weight","bold");}else{$('#totals_tendered_box').css("font-size","12px");$('#totals_tendered_box').css("font-weight","normal");}
totalAmountInclCashback=currentTotalFinal+cashback;change=totalCashTendered-totalAmountInclCashback;if(change<0){$('#totals_change_container').hide();$('#totals_balance_container').show();$('#totals_balance_value').html(currency(Math.abs(change),false));}else{$('#totals_balance_container').hide();$('#totals_change_container').show();$('#totals_change_value').html(currency(change,false));}}
var cashTendered;function getTotalTendered(){var totalTendered=0;for(pm in splitPayments){totalTendered+=splitPayments[pm];}
return roundNumber(totalTendered,2);}
function finishSale(){updateTotalTendered();if(paymentIntegrationId!=0){if(paymentIntegrationId==zalionPaymentIntegrationId){if(!selectedRoomNumber||!selectedFolioNumber||!selectedFolioName){niceAlert("You must select a guest to charge this bill to");return;}}}
cashTendered=getTotalTendered();totalAmountInclCashback=roundNumber(currentTotalFinal+cashback,2);if(cashTendered<totalAmountInclCashback){if(loyaltyPaymentMethodSelected){niceAlert("Not enough loyalty points to cover the whole sale! Other payment methods must be used to cover the difference.");return;}
moneySelected(-1);finishSale();return;}
if(cashTendered>totalAmountInclCashback){var positiveCashAmount=false;var totalCashAmount=0;for(pm in splitPayments){if(pm.toLowerCase()==cashPaymentMethodName&&parseFloat(splitPayments[pm])>0){positiveCashAmount=true;totalCashAmount=parseFloat(splitPayments[pm]);break;}}
if(!positiveCashAmount){niceAlert("You cannot enter an amount ("+currency(cashTendered)+") above the total ("+currency(totalAmountInclCashback)+"), if you are not taking a cash payment, as you cannot issue change without cash.");return;}
change=roundNumber(parseFloat(cashTendered-totalAmountInclCashback),2);if(change>=totalCashAmount){niceAlert("Change cannot be greater than or equal the cash amount!");return;}}
doTotalFinal();}
function resetTendered(){cashTendered=0;cashTenderedKeypadString="";}
function cashOutCancel(){if(disallowCancelSaleCC){niceAlert("You cannot cancel this sale, as the card transaction has already been processed!");return;}
resetLoyaltyCustomer();resetTendered();showMenuScreen();}
var paymentIntegrationId=0;var currentZalionPaymentMethodName=null;var loyaltyPaymentMethodSelected=false;var accountPaymentMethodSelected=false;var cashPaymentMethodSelected=false;function paymentMethodSelected(pm_id){var pm_info=paymentMethods[pm_id];var method=pm_info.name;var integration_id=pm_info.payment_integration_id
var custom_footer_id=pm_info.receipt_footer_id;if(paymentIntegrationId!=0&&splitPayments[paymentMethod]>0){if(!allowedZalionSplitPayments){splitPayments={};}else{var warningMessage=paymentMethod+" must be the last payment method used if splitting a payment (Enter zero to cancel).";niceAlert(warningMessage);return;}}else if(accountPaymentMethodSelected&&splitPayments[paymentMethod]>0){if(disallowCancelSaleCC){niceAlert("You cannot charge to an account, as a card transaction has already been processed!");return;}
splitPayments={};resetCustomerSelect();}
loyaltyPaymentMethodSelected=(method==loyaltyPaymentMethodName);accountPaymentMethodSelected=(method==accountPaymentMethodName);cashPaymentMethodSelected=(method==cashPaymentMethodName);if(loyaltyPaymentMethodSelected){if(!totalOrder.loyalty){niceAlert("Please swipe the customers loyalty card first!");loyaltyPaymentMethodSelected=false;return;}
totalAmountInclCashback=currentTotalFinal+cashback;var totalCashTendered=getTotalTendered();if(splitPayments[loyaltyPaymentMethodName]){totalCashTendered-=splitPayments[loyaltyPaymentMethodName];}
var amountOutstanding=totalAmountInclCashback-totalCashTendered;var availablePoints=totalOrder.loyalty.points_available;var amountOutstandingInPoints=roundNumber(amountOutstanding*loyaltyPointsPerCurrencyUnit,2);var pointsUsedInCurrencyPennies=0;if(availablePoints<=0){niceAlert("This customer has no available loyalty points!");loyaltyPaymentMethodSelected=false;return;}else if(availablePoints<amountOutstandingInPoints){niceAlert("Not have enough loyalty points to cover the whole sale!"+" "+amountOutstandingInPoints+" points needed. Other payment methods must be used to cover the difference");var pointsUsed=availablePoints;pointsUsedInCurrencyPennies=(pointsUsed/loyaltyPointsPerCurrencyUnit)*100;}else{niceAlert(amountOutstandingInPoints+" of this customers loyalty points will be used to cover this sale!");pointsUsedInCurrencyPennies=(amountOutstandingInPoints/loyaltyPointsPerCurrencyUnit)*100;}
cashTenderedKeypadString=pointsUsedInCurrencyPennies;cashTendered=parseFloat(cashTenderedKeypadString/100.0);splitPayments[loyaltyPaymentMethodName]=cashTendered;$('#tendered_value').html(currency(cashTenderedKeypadString/100.0));}else if(accountPaymentMethodSelected){splitPayments={};resetLoyaltyCustomer();totalAmountInclCashback=currentTotalFinal+cashback;cashTendered=totalAmountInclCashback;splitPayments[accountPaymentMethodName]=cashTendered;amountToChargeCustomer=totalAmountInclCashback;showCustomerSearchScreen();}
updateTotalTendered();clearSelectedFolio();$('#charge_room_section').hide();setTenderedBoxFocus(true);paymentMethod=method;$('#selected_payment_method_holder').html(paymentMethod);$('.payment_method_button').each(function(){$(this).removeClass('selected');});$(".button[id='"+method.replace(/ /g,"_")+"_payment_method_button']").addClass('selected');paymentIntegrationId=integration_id;if(paymentIntegrationId!=0){totalAmountInclCashback=currentTotalFinal+cashback;if(paymentIntegrationId==zalionPaymentIntegrationId){if(!allowedZalionSplitPayments){splitPayments={};splitPayments[paymentMethod]=0;moneySelected(-1);updateTotalTendered();}
currentZalionPaymentMethodName=paymentMethod;showLoadingDiv("Loading Zalion Data...");var zalion_roomfile_request_url='http://'+zalionChargeRoomServiceIP+':8080/ClueyWebSocketServices/zalion_roomfile';$.ajax({type:'GET',url:'/forward_zalion_roomfile_request',error:function(){hideLoadingDiv();niceAlert("Error Getting Zalion Data.",false,false);paymentMethodSelected(getPaymentMethodId(defaultPaymentMethod));splitPayments={};},data:{zalion_roomfile_request_url:zalion_roomfile_request_url}});}}
resetTendered();if(!splitPayments[paymentMethod]){splitPayments[paymentMethod]=0;}
cashTendered=splitPayments[paymentMethod];$('#tendered_value').html(currency(cashTendered));customFooterId=custom_footer_id;}
var selectedRoomNumber=null;var selectedFolioNumber=null;var selectedFolioName=null;var zalionChargedAmount=null;function doRoomNumberLookup(){clearSelectedFolio();var roomNumber=$('#room_number_input').val();roomNumber=parseInt(roomNumber);if(isNaN(roomNumber)){niceAlert("Please enter a valid room number.");return;}
var roomInfo=clientRooms[roomNumber.toString()];if(roomInfo){var folioTableHTML="<div class='name_header'>Guests in Room "+roomNumber+"</div>"+clearHTML;folioTableHTML+="<div class='folio_entries'>";for(var folioNumber in roomInfo){var folioName=roomInfo[folioNumber]["NAME"];var folioBalance=roomInfo[folioNumber]["BALANCE"];var folioCreditLimit=roomInfo[folioNumber]["CREDITLIMIT"];folioTableHTML+="<div id='folio_"+folioNumber+"' onclick=\"selectFolio("+roomNumber+", "+folioNumber+", '"+folioName+"', "+folioBalance+", "+folioCreditLimit+");\" class='entry'>";folioTableHTML+="<div class='number'>"+folioNumber+"</div>";folioTableHTML+="<div class='name'>"+folioName+"</div>";folioTableHTML+="<div class='balance'>Bal: "+currency(folioBalance)+"</div>";folioTableHTML+="</div>"+clearHTML;}
folioTableHTML+="</div>"+clearHTML;$('#name_list').html(folioTableHTML);}else{niceAlert("Room "+roomNumber+" not found.");totalsScreenKeypadClickCancel();return;}}
function selectFolio(roomNumber,folioNumber,folioName,folioBalance,folioCreditLimit){clearSelectedFolio();$('#name_list .entry').removeClass("selected");folioBalance=parseFloat(folioBalance);folioCreditLimit=parseFloat(folioCreditLimit);if(folioBalance>=folioCreditLimit){niceAlert("This guests credit limit of "+currency(folioCreditLimit)+" has been exceeded");return;}
$('#folio_'+folioNumber).addClass("selected");setTenderedBoxFocus(true);selectedRoomNumber=roomNumber;selectedFolioNumber=folioNumber;selectedFolioName=folioName;}
function clearSelectedFolio(){selectedRoomNumber=null;selectedFolioNumber=null;selectedFolioName=null;}
function setTenderedBoxFocus(focus){if(focus){roomNumberInputFocus=false;$('#tendered_box').addClass("selected");}else{roomNumberInputFocus=true;$('#tendered_box').removeClass("selected");}}
var cashTenderedKeypadString="";var roomNumberInputFocus=false;function totalsScreenKeypadClick(val){if(loyaltyPaymentMethodSelected||accountPaymentMethodSelected){return;}
if(roomNumberInputFocus){$('#room_number_input').val($('#room_number_input').val()+val);return;}
cashTenderedKeypadString+=val;cashTendered=parseFloat(cashTenderedKeypadString/100.0);splitPayments[paymentMethod]=cashTendered;$('#tendered_value').html(currency(cashTenderedKeypadString/100.0));}
function totalsScreenKeypadClickCancel(){if(loyaltyPaymentMethodSelected||accountPaymentMethodSelected){return;}
if(roomNumberInputFocus){$('#room_number_input').val("");return;}
$('#tendered_value').html(currency(0));splitPayments[paymentMethod]=0;resetTendered();}
function moneySelected(amount){if(loyaltyPaymentMethodSelected||accountPaymentMethodSelected){return;}
if(amount==-1){totalAmountInclCashback=currentTotalFinal+cashback;var totalCashTendered=getTotalTendered();totalCashTendered-=splitPayments[paymentMethod];newAmount=totalAmountInclCashback-totalCashTendered;}else{currentAmount=cashTendered;if(currentAmount.length==0){currentAmount=0;}
currentAmount=parseFloat(currentAmount);newAmount=parseInt(amount)+currentAmount;}
if(newAmount<0){newAmount=0;}
newAmount=roundNumber(newAmount,2);cashTendered=parseFloat(newAmount);splitPayments[paymentMethod]=cashTendered;$('#tendered_value').html(currency(newAmount));}
function doChargeRoom(orderData){if(inTrainingMode){niceAlert("Room will not be charged in training mode");return;}
orderData.datetime=formatDate(new Date(clueyTimestamp()),"dd/MM/yyyy HH:mm:ss");orderData.location=business_name;if(paymentIntegrationId!=0){if(paymentIntegrationId==zalionPaymentIntegrationId){var zalion_charge_request_url='http://'+zalionChargeRoomServiceIP+':8080/ClueyWebSocketServices/zalion_charge';orderData.total=parseFloat(splitPayments[currentZalionPaymentMethodName]);var orderDataString=JSON.stringify(orderData);$.ajax({type:'POST',url:'/forward_zalion_charge_request',error:function(){setStatusMessage("Error Charging to Zalion",false,false);},success:function(){setStatusMessage("Room successfully charged.",false,false);},data:{zalion_charge_request_url:zalion_charge_request_url,order_data_json_string:orderDataString,order_data:orderData}});}}}
var togglePrintReceiptInProgress=false;function togglePrintReceipt(){if(togglePrintReceiptInProgress){niceAlert("Please wait, request pending");return;}
togglePrintReceiptInProgress=true;$.ajax({type:'POST',url:'/admin/toggle_print_receipt.js'});}
var cardChargeInProgress=false;var cc_txn_xhr=null;var currentCardChargeAmount=0;function cashScreenChargeCreditCard(amount){if(cashPaymentMethodSelected||accountPaymentMethodSelected||loyaltyPaymentMethodSelected){niceAlert("You must select an appropriate payment method first, in order to perform a transaction");return;}
creditCardChargeCallback=cashScreenCreditCardChargeCallback;if(cardChargeInProgress){niceAlert("There is already a card charge in progress, please wait");return;}
if(totalOrder.card_charge){niceAlert("You have already processed a card transaction for this sale!");return;}
if(typeof(amount)=='undefined'){amount=cashTendered;}
if(amount==0){moneySelected(-1);amount=cashTendered;if(amount==0){niceAlert("You cannot send a zero amount to card terminal");return;}}
cardChargeInProgress=true;chargeCreditCard(amount);}
function chargeCreditCard(amount){currentCardChargeAmount=amount;currentCCReferenceNumber=clueyTimestamp();var referenceMessage="TXN#: "+currentCCReferenceNumber;var creditCardChargeRequestURL='http://'+creditCardChargeServiceIP+':8080/ClueyWebSocketServices/cc_txn';var message="Sending "+currency(amount)+" to card terminal.";hideNiceAlert();ModalPopups.Alert('niceAlertContainer',"Card Terminal Request In Progress...","<div id='nice_alert' class='nice_alert'>"+message+"</div>",{width:360,height:280,okButtonText:'Cancel',onOk:"cancelChargeCreditCard();"});cc_txn_xhr=$.ajax({type:'POST',url:'/forward_credit_card_charge_request',error:function(){if(!userAbortedXHR(cc_txn_xhr)){hideNiceAlert();niceAlert("Error charging card! Make sure card service is running and settings are correct.",false,false);}},complete:function(){cardChargeInProgress=false;},data:{credit_card_charge_request_url:creditCardChargeRequestURL,credit_card_terminal_ip:creditCardTerminalIP,credit_card_terminal_port:creditCardTerminalPort,transaction_type:"C",transaction_amount:amount,cashback_amount:"0",reference_message:referenceMessage,gratuity_amount:"0"}});}
function cashScreenCreditCardChargeCallback(creditCardChargeResponseCode,errorMessage){var message="";if(creditCardChargeResponseCode==1){message="Card successfully charged for "+currency(currentCardChargeAmount);niceAlert(message);totalOrder.card_charge={paymentMethod:paymentMethod,amount:currentCardChargeAmount,reference_number:currentCCReferenceNumber}
disallowCancelSaleCC=true;paymentMethodSelected(getPaymentMethodId(defaultPaymentMethod));}else if(creditCardChargeResponseCode==2){message="Charge has been declined.";niceAlert(message);}else if(creditCardChargeResponseCode==3){message="Card charge canceled.";niceAlert(message);}else if(creditCardChargeResponseCode==4){message="Request timed out. Please try again.";niceAlert(message);}else if(creditCardChargeResponseCode==5){message="Unknown response from card terminal.";niceAlert(message);}else if(creditCardChargeResponseCode==6){message="Communication Error, please make sure the credit card terminal is not in use and all settings are set correctly.";niceAlert(message);}else{if(errorMessage!=null){message="Error: "+errorMessage;}else{message="An unknown error occured.";}
niceAlert(message);}
creditCardChargeCallback=null;}
function cancelChargeCreditCard(){cardChargeInProgress=false;cc_txn_xhr.abort();hideNiceAlert();niceAlert("Card charge canceled. Make sure to cancel the transaction on the terminal also.");}
var loyaltyCardListenerHandler=function(event){if(event.keyCode==13){$(window).unbind('keypress',loyaltyCardListenerHandler);if(current_user_id==null){setStatusMessage("You are not logged in!",true,true);return;}
if(currentOrderEmpty()){setStatusMessage("No order present!",true,true);return;}
loyaltyCardCode=loyaltyCardCode.substring(0,8);var fullLoyaltyCardCode=loyaltyCardPrefix+loyaltyCardCode;console.log("Looking up loyalty card code: "+fullLoyaltyCardCode);if(loyaltyCustomersByCode[fullLoyaltyCardCode]){if(!currentScreenIsTotals()){doTotal();}
addLoyaltyCustomerToTotalOrder(loyaltyCustomersByCode[fullLoyaltyCardCode]);}else{niceAlert("Customer Not Found!");}
loyaltyCardCode="";return;}
loyaltyCardCode+=String.fromCharCode(getEventKeyCode(event));}
function addLoyaltyCustomerToTotalOrder(customer){$('#loyalty_customer_name').html(customer.name);$('#loyalty_customer_number').html(customer.customer_number);var loyaltyLevelPercent=loyaltyLevels[customer.loyalty_level_id].percent;$('#loyalty_level_percent').html(loyaltyLevelPercent+"%");var pointsEarned=roundNumber(((loyaltyLevelPercent/100)*(totalOrder.total*100)),0);$('#loyalty_points_earned').html(pointsEarned);var loyaltyPointsAvailable=customer.available_points;$('#loyalty_points_available').html(loyaltyPointsAvailable);$('#loyalty_customer_section').show();totalOrder.loyalty={customer_id:customer.id,customer_name:customer.name,customer_number:customer.number,points_earned:pointsEarned,points_available:loyaltyPointsAvailable};}
function resetLoyaltyCustomer(){$('#loyalty_customer_section').hide();delete totalOrder[loyaltyPaymentMethodName];delete splitPayments[loyaltyPaymentMethodName];if(loyaltyPaymentMethodSelected){paymentMethodSelected(getPaymentMethodId(defaultPaymentMethod));}}
function initCustomerSearchKeyboard(){toggleKeyboardEnable=false;var keyboardPlaceHolderEl=$('#totals_screen_select_customer_container #customer_search_results_keyboard_container')
var pos=keyboardPlaceHolderEl.offset();$("#util_keyboard_container").css({"position":"absolute","width":"688px","left":(pos.left)+"px","top":pos.top+"px"});hideUtilKeyboardCloseButton();$("#util_keyboard_container").show();setUtilKeyboardCallback(function(){selectedCustomerSearchLetter=null;updateCustomerSearchResults();});}
function showCustomerSearchScreen(){$('#payment_options_money_info_container').hide();$('#totals_screen_select_customer_container').show();initCustomerSearchKeyboard();clearCustomerSearchInput();$('#customer_search_input').focus();updateCustomerSearchResults();}
function clearCustomerSearchInput(){$('#customer_search_input').val("");updateCustomerSearchResults();}
function resetCustomerSelect(){delete totalOrder['customer'];$('#client_customer_section').hide();$('#totals_screen_select_customer_container').hide();$('#payment_options_money_info_container').show();paymentMethodSelected(getPaymentMethodId(defaultPaymentMethod));setUtilKeyboardCallback(null);resetKeyboard();}
var selectedCustomerSearchLetter=null;var amountToChargeCustomer=null;function searchBoxFocused(){selectedCustomerSearchLetter=null;$('#selection_letters .letter').removeClass("selected");updateCustomerSearchResults();}
function loadAllCustomers(){selectedCustomerSearchLetter=null;$('#selection_letters .letter').removeClass("selected");$('#selection_letters #cs_button_all').addClass("selected");clearCustomerSearchInput();}
function loadSearchCustomersForLetter(letter){console.log("Get customers for letter: "+letter);clearCustomerSearchInput();$('#selection_letters .letter').removeClass("selected");$('#selection_letters #cs_button_'+letter).addClass("selected");selectedCustomerSearchLetter=letter;updateCustomerSearchResults();}
function updateCustomerSearchResults(){var searchString=$('#customer_search_input').val().toLowerCase();var results=new Array();var nextCustomer=null;if(selectedCustomerSearchLetter!=null){for(customerId in creditCustomers){nextCustomer=creditCustomers[customerId];if(nextCustomer.name.toLowerCase().startsWith(selectedCustomerSearchLetter)){results.push(nextCustomer);}}}else{for(customerId in creditCustomers){nextCustomer=creditCustomers[customerId];if(nextCustomer.name.toLowerCase().contains(searchString)){results.push(nextCustomer);}}}
$('#search_results_scroller').html("");var resultHTML="<div id='customer_list'>";if(results.length>0){var alphaSort=function(a,b){return a.name.localeCompare(b.name);};results=results.sort(alphaSort);for(var i=0;i<results.length;i++){var c=results[i];var startIndex=c.name.toLowerCase().indexOf(searchString);var endIndex=startIndex+searchString.length+3;var customerName=c.name;if(searchString.length>0){customerName=customerName.toLowerCase().splice(startIndex,0,"<b>");customerName=customerName.toLowerCase().splice(endIndex,0,"</b>");}
resultHTML+="<div onclick='addCustomerToOrder("+c.id+")' class='customer'>"+customerName+"</div>";}}else{resultHTML+="<div id='no_results'>No Customers Found!</div>";}
resultHTML+="</div>"+clearHTML;$('#search_results_scroller').html(resultHTML);}
function addCustomerToOrder(c_id){var customer=creditCustomers[c_id];var customerName=customer.name;var creditAvailable=customer.credit_available;var customerCreditLimit=customer.credit_limit;var customerCreditAvailable=customer.credit_available;var customerCurrentBalance=customer.current_balance;if(amountToChargeCustomer>creditAvailable){niceAlert("This customers credit limit ("+currency(customerCreditLimit)+") will not allow for this sale to finish. Credit Available: "+currency(customerCreditAvailable));return;}
console.log("Adding customer "+customerName+" to order!");$('#totals_screen_select_customer_container').hide();$('#payment_options_money_info_container').show();setUtilKeyboardCallback(null);resetKeyboard();totalOrder.customer={customer_id:customer.id};$('#client_customer_name').html(customerName);$('#client_customer_credit_limit').html(currency(customerCreditLimit));$('#client_customer_current_balance').html(currencyBalance(customerCurrentBalance));$('#client_customer_section').show();if(customer.is_loyalty_customer){addLoyaltyCustomerToTotalOrder(customer);$('#client_customer_points_earned').html($('#loyalty_points_earned').html());$('#client_customer_points_earned_container').show();$('#loyalty_customer_section').hide();}else{$('#client_customer_points_earned_container').hide();}}
var utilPaymentInProgress=false;var currentPaymentCustomerId=null;var currentPaymentReceiptHTML=null;function makeCustomerPayment(customerId){if(!appOnline){niceAlert("Cannot contact server to make payment");return;}
if(cacheDownloading){cacheDownloadingPopup();return;}
var customer=creditCustomers[customerId];if(!customer){niceAlert("This customer is not registered for accounts!");return;}
var currentBalance=customer.current_balance;currentPaymentCustomerId=customerId;var callback=function(){var amountTendered=utilPaymentResponse.amount_tendered;var cardCharged=utilPaymentResponse.card_charged;var allowCreditCustomer=$('#util_payment_set_allow_credit_customer').is(':checked');var paymentAmount;if(allowCreditCustomer){paymentAmount=amountTendered;}else{if(utilPaymentResponse.amount_tendered>=utilPaymentResponse.amount)
paymentAmount=utilPaymentResponse.amount;else{paymentAmount=utilPaymentResponse.amount_tendered;}}
console.log("Processed payment for "+currency(paymentAmount));currentPaymentReceiptHTML="";currentPaymentReceiptHTML+=fetchBusinessInfoHeaderHTML()+clear10HTML;currentPaymentReceiptHTML+="<div class='data_table_header'>ACCOUNT PAYMENT</div>"+clear10HTML;currentPaymentReceiptHTML+="<div class='data_table'>";var timestamp=utilFormatDate(new Date(clueyTimestamp()));currentPaymentReceiptHTML+="<div class='label'>Date:</div><div class='data'>"+timestamp+"</div>"+clearHTML;currentPaymentReceiptHTML+="<div class='label'>Terminal:</div><div class='data'>"+terminalID+"</div>"+clearHTML;currentPaymentReceiptHTML+="<div class='label'>Served By:</div><div class='data'>"+current_user_nickname+"</div>"+clearHTML;var accountNo=creditCustomers[currentPaymentCustomerId].account_number;currentPaymentReceiptHTML+="<div class='label'>Account No:</div><div class='data'>"+accountNo+"</div>"+clearHTML;currentPaymentReceiptHTML+="</div>"+clearHTML;currentPaymentReceiptHTML+="<div class='data_table'>";var previousBalance=currentBalance;var newBalance=previousBalance-paymentAmount;currentPaymentReceiptHTML+="<div class='label'>Previous Balance:</div><div class='data'>"+currencyBalance(previousBalance)+"</div>"+clearHTML;currentPaymentReceiptHTML+="<div class='label bold'>Paid "+utilScreenPaymentMethod+":</div><div class='data bold'>"+currency(paymentAmount)+"</div>"+clearHTML;currentPaymentReceiptHTML+="<div class='label'>Outstanding:</div><div class='data'>"+currencyBalance(newBalance)+"</div>"+clearHTML;currentPaymentReceiptHTML+="</div>"+clearHTML;$.ajax({type:'POST',url:'/customer_payment',error:function(){setStatusMessage("Error Sending Payment To Server",false,false);},success:function(){setStatusMessage("Payment successfully recorded.",false,false);showMenuScreen();printReceipt(currentPaymentReceiptHTML,true);currentPaymentReceiptHTML="";doReloadSalesResources();},complete:function(){utilPaymentInProgress=false;},data:{customer_id:currentPaymentCustomerId,amount:paymentAmount,amount_tendered:amountTendered,payment_method:utilScreenPaymentMethod,card_charged:cardCharged,reference_number:currentCCReferenceNumber}});utilPaymentResponse=null;};var amount=currentBalance;if(amount<0){amount=0;}
var minAmount=0;var maxAmount=-1;$('#util_payment_header').html("Customer Payment");var customerName=customer.name;var customerHTMLContent="<div id='cutomer_payment_info_table'><div class='data_table'>";customerHTMLContent+="<div class='label bold'>Customer:</div>";customerHTMLContent+="<div class='data'>"+customerName+"</div>"+clearHTML;customerHTMLContent+="<div class='label bold'>Balance:</div>";customerHTMLContent+="<div class='data'>"+currencyBalance(currentBalance)+"</div>"+clearHTML;customerHTMLContent+="<div class='label bold credit_account_label'>Allow Credit:</div>";customerHTMLContent+="<input type='checkbox' id='util_payment_set_allow_credit_customer'/>"+clearHTML;customerHTMLContent+="</div></div>"+clearHTML;startUtilPayment(amount,minAmount,maxAmount,callback,customerHTMLContent);$("#util_payment_set_allow_credit_customer").attr("disabled",false);if(amount<=0){$("#util_payment_set_allow_credit_customer ").attr("checked",true);$("#util_payment_set_allow_credit_customer").attr("disabled",true);}else{$("#util_payment_set_allow_credit_customer").attr("checked",false);}
$('#util_payment_set_allow_credit_customer').iphoneStyle({resizeContainer:false,resizeHandle:false,checkedLabel:'Yes',uncheckedLabel:'No'});}
var utilPaymentProcessedCallback=null;var utilPaymentAmount=0;var utilPaymentMinAmount=0;var utilPaymentMaxAmount=0;var utilPaymentResponse=null;var utilScreenPaymentMethod=null;var utilPaymentCardCharged=false;function startUtilPayment(amount,minAmount,maxAmount,callback,htmlContent){utilPaymentAmount=amount;utilPaymentMinAmount=minAmount;utilPaymentMaxAmount=maxAmount;utilPaymentProcessedCallback=callback;utilPaymentResponse={};utilPaymentCardCharged=false;currentCCReferenceNumber=null;utilScreenPaymentMethod=defaultPaymentMethod;utilPaymentScreenPaymentMethodSelected(getPaymentMethodId(defaultPaymentMethod));utilPaymentCashTenderedKeypadString="";utilPaymentCashTendered=0;$('#util_payment_total_value').html(currency(utilPaymentAmount));$('#util_payment_tendered_value').html(currency(0));$('#util_payment_balance_value').html(currency(utilPaymentAmount));$('#util_payment_content_container').html(htmlContent);showUtilPaymentScreen();}
function cancelUtilPayment(){utilPaymentAmount=utilPaymentMinAmount=utilPaymentMaxAmount=utilPaymentProcessedCallback=null;showMenuScreen();}
function finishUtilPayment(){if(utilPaymentInProgress){niceAlert("There is a payment in progress, please wait!");return;}
if(utilPaymentCashTendered==0){utilPaymentExactAmountSelected();if(utilPaymentCashTendered<=0){niceAlert("You must make a payment for more than "+currency(0));return;}}
utilPaymentInProgress=true;showLoadingDiv("Processing... Please Wait!");utilPaymentResponse.card_charged=utilPaymentCardCharged;utilPaymentResponse.amount_tendered=utilPaymentCashTendered;utilPaymentResponse.amount=utilPaymentAmount;var doOpenCashDrawer=paymentMethods[getPaymentMethodId(utilScreenPaymentMethod)].open_cash_drawer;if(doOpenCashDrawer){openCashDrawer();}
if(utilPaymentProcessedCallback){utilPaymentProcessedCallback.call();}}
var utilPaymentCashTenderedKeypadString="";var utilPaymentCashTendered=0;function utilPaymentScreenKeypadClick(val){utilPaymentCashTenderedKeypadString+=val;utilPaymentCashTendered=parseFloat(utilPaymentCashTenderedKeypadString/100.0);if((utilPaymentCashTendered>utilPaymentMaxAmount)&&utilPaymentMaxAmount!=-1){niceAlert("The maximum amount allowed for this payment is "+currency(utilPaymentMaxAmount));utilPaymentCashTendered=utilPaymentMaxAmount;}
var balanceOutstanding=utilPaymentAmount-utilPaymentCashTendered;if(balanceOutstanding<0){balanceOutstanding=0;}
$('#util_payment_tendered_value').html(currency(utilPaymentCashTenderedKeypadString/100.0));$('#util_payment_balance_value').html(currency(balanceOutstanding));}
function utilPaymentScreenKeypadClickCancel(){$('#util_payment_tendered_value').html(currency(0));$('#util_payment_balance_value').html(currency(utilPaymentAmount));utilPaymentCashTendered=0;utilPaymentCashTenderedKeypadString="";}
function utilPaymentExactAmountSelected(){utilPaymentCashTendered=utilPaymentAmount;$('#util_payment_tendered_value').html(currency(utilPaymentCashTendered));$('#util_payment_balance_value').html(currency(0));}
function utilPaymentScreenPaymentMethodSelected(pm_id){var pm_info=paymentMethods[pm_id];var method=pm_info.name;var custom_footer_id=pm_info.receipt_footer_id;utilScreenPaymentMethod=method;$('.util_payment_method_button').each(function(){$(this).removeClass('selected');});$(".button[id='"+method.replace(/ /g,"_")+"_util_payment_method_button']").addClass('selected');customFooterId=custom_footer_id;}
function utilPaymentScreenChargeCreditCard(){creditCardChargeCallback=utilPaymentScreenCreditCardChargeCallback;if(cardChargeInProgress){niceAlert("There is already a card charge in progress, please wait");return;}
var amount=utilPaymentCashTendered;if(amount==0){utilPaymentExactAmountSelected()
amount=utilPaymentCashTendered;if(amount==0){niceAlert("You cannot send a zero amount to card terminal");return;}}
cardChargeInProgress=true;chargeCreditCard(amount);}
function utilPaymentScreenCreditCardChargeCallback(creditCardChargeResponseCode,errorMessage){var message="";if(creditCardChargeResponseCode==1){message="Card successfully charged for "+currency(utilPaymentCashTendered);niceAlert(message);utilPaymentCardCharged=true;finishUtilPayment();}else if(creditCardChargeResponseCode==2){message="Charge has been declined.";niceAlert(message);}else if(creditCardChargeResponseCode==3){message="Card charge canceled.";niceAlert(message);}else if(creditCardChargeResponseCode==4){message="Request timed out. Please try again.";niceAlert(message);}else if(creditCardChargeResponseCode==5){message="Unknown response from card terminal.";niceAlert(message);}else if(creditCardChargeResponseCode==6){message="Communication Error, please make sure the credit card terminal is not in use and all settings are set correctly.";niceAlert(message);}else{if(errorMessage!=null){message="Error: "+errorMessage;}else{message="An unknown error occured.";}
niceAlert(message);}
creditCardChargeCallback=null;}
function initTouch(){new NoClickDelay(document.body);$('#wrapper').swipe({minSwipeLength:250,swipeRight:function(){swipeRightHandler();},swipeUp:function(){swipeUpHandler();},swipeLeft:function(){swipeLeftHandler();},swipeDown:function(){swipeDownHandler();}});}
var thisClickTarget=null;var lastClickTarget=null;var thisClickTimestamp=0;var lastClickTimestamp=0;var cancelFollowClick=false;function NoClickDelay(el){this.element=el;this.element.addEventListener('touchstart',this,false);$('.key').each(function(){var el=$(this);var clickhandler=el.attr("onclick");el.attr("onclick","return false;");el.click(function(e){cancelFollowClick=false;thisClickTarget=el;thisClickTimestamp=Date.now();if(thisClickTarget==lastClickTarget&&thisClickTimestamp-lastClickTimestamp<500){e.preventDefault();e.stopPropagation();cancelFollowClick=true;return false;}else{lastClickTarget=thisClickTarget;lastClickTimestamp=thisClickTimestamp;}});if(clickhandler){el.click(function(e){if(!cancelFollowClick){clickhandler();}});}});}
NoClickDelay.prototype={handleEvent:function(e){switch(e.type){case'touchstart':this.onTouchStart(e);break;case'touchmove':this.onTouchMove(e);break;case'touchend':this.onTouchEnd(e);break;}},onTouchStart:function(e){this.theTarget=document.elementFromPoint(e.targetTouches[0].clientX,e.targetTouches[0].clientY);targetIsSelectElement=this.theTarget.tagName=="SELECT";targetIsInputElement=this.theTarget.tagName=="INPUT";if(!targetIsSelectElement&&!targetIsInputElement){e.preventDefault();if(this.theTarget.nodeType==3){this.theTarget=theTarget.parentNode;}
this.checkTarget=this.theTarget;this.element.addEventListener('touchmove',this,false);this.element.addEventListener('touchend',this,false);this.element.addEventListener('touchcancel',this,false);}},onTouchCancel:function(e){console.log("Touch cancel");},onTouchMove:function(e){this.checkTarget=document.elementFromPoint(e.targetTouches[0].clientX,e.targetTouches[0].clientY);if(this.checkTarget.nodeType==3)this.checkTarget=this.checkTarget.parentNode;},onTouchEnd:function(e){e.preventDefault();e.stopPropagation();this.element.removeEventListener('touchmove',this,false);this.element.removeEventListener('touchend',this,false);if(this.checkTarget==this.theTarget){var theEvent=document.createEvent('MouseEvents');theEvent.initEvent('click',true,true);this.theTarget.dispatchEvent(theEvent);}
this.theTarget=undefined;}};function prepareXTotal(){doCashTotalReport("X",false);}
function prepareZTotal(){var doIt=checkAllOrdersClosedForCashTotal();if(doIt||bypassOpenOrdersForCashTotal){doCashTotalReport("Z",false);}}
function checkAllOrdersClosedForCashTotal(){var allOrdersClosed=(!currentOrder||currentOrder.items.length==0)&&getActiveTableIDS().length==0;if(!allOrdersClosed){setStatusMessage("All Orders Must Be Closed!",true,true);return false;}
return true;}
function printCurrentReceipt(){if(currentOrderEmpty()){setStatusMessage("No order present to print!");return;}
content=fetchOrderReceiptHTML(getCurrentOrder());printReceipt(content,false);}
function printLastReceipt(){doPrintLastReceipt(false);}
function printLastReceiptWithVat(){doPrintLastReceipt(true);}
function doPrintLastReceipt(withVat){if(lastSaleObj!=null){totalOrder=lastSaleObj;var includeBusinessInfo=true;var includeServerAddedText=false;var content=fetchFinalReceiptHTML(includeBusinessInfo,includeServerAddedText,withVat);printReceipt(content,true);}else{niceAlert("No Last Sale Found.");}}
function promptForServiceCharge(){if(currentOrderEmpty()){setStatusMessage("No order present!",true,true);return;}
popupHTML=$("#service_charge_popup_markup").html();if(currentScreenIsMenu()){popupEl=showMenuScreenDefaultPopup(popupHTML);}else if(currentScreenIsTotals()){popupEl=showTotalsScreenDefaultPopup(popupHTML);}
popupId=popupEl.GetBubblePopupID();keypadPosition=$('#'+popupId).find('.service_charge_popup_keypad_container');clickFunction=function(val){if(serviceCharge==0)serviceCharge="";serviceCharge=serviceCharge.toString()+val;$('#'+popupId).find('.service_charge_popup_amount').html(serviceCharge);};cancelFunction=function(){oldVal=$('#'+popupId).find('.service_charge_popup_amount').html();newVal=oldVal.substring(0,oldVal.length-1);$('#'+popupId).find('.service_charge_popup_amount').html(newVal);if(newVal=="")newVal=0;serviceCharge=parseFloat(newVal);};var popupEl=$('#'+popupId);setDefaultServiceChargeButtonSelected(popupEl,defaultServiceChargePercent);serviceCharge=number_to_currency(serviceCharge);popupEl.find('.service_charge_popup_amount').html(serviceCharge);setUtilKeypad(keypadPosition,clickFunction,cancelFunction);}
function saveServiceCharge(performTotal){serviceCharge=parseFloat(serviceCharge);if(isNaN(serviceCharge)){serviceCharge=0;}
order=getCurrentOrder();order.service_charge=serviceCharge;if(selectedTable!=0){storeTableOrderInStorage(current_user_id,selectedTable,order);}else{storeOrderInStorage(current_user_id,order);}
hideServiceChargePopup();if(performTotal){doTotal(false);}}
function setServiceCharge(){popupEl=$('#totals_screen_default_popup_anchor');popupId=popupEl.GetBubblePopupID();var popupEl=$('#'+popupId);serviceCharge=parseFloat(popupEl.find('.service_charge_popup_amount').html());if(isNaN(serviceCharge)){serviceCharge=0;}
saveServiceCharge(true);}
function cancelServiceCharge(){if(selectedTable==0||typeof tableOrders[selectedTable].service_charge=="undefined"){serviceCharge=0;}else{serviceCharge=tableOrders[selectedTable].service_charge;}
hideServiceChargePopup();}
function hideServiceChargePopup(){hideTotalsScreenDefaultPopup();}
function presetServiceChargePercentageClicked(percentage){defaultServiceChargePercent=percentage;if(currentOrderEmpty()){serviceCharge=0;}else{serviceCharge=currency((percentage*parseFloat(getCurrentOrder().total))/100,false);}
popupEl=$('#totals_screen_default_popup_anchor');popupId=popupEl.GetBubblePopupID();var popupEl=$('#'+popupId);popupEl.find('.service_charge_popup_amount').html(serviceCharge);setDefaultServiceChargeButtonSelected(popupEl,percentage);}
function setDefaultServiceChargeButtonSelected(popupEl,percentage){popupEl.find('.service_charge_button_percent').removeClass("selected");percentage=parseFloat(percentage);var percentage_without_decimal=percentage.toString().replace(".","");popupEl.find('#service_charge_button_percent_'+percentage_without_decimal).addClass("selected");}
function promptForCashback(){if(currentOrderEmpty()){setStatusMessage("No order present!",true,true);return;}
popupHTML=$("#cashback_popup_markup").html();popupEl=showTotalsScreenDefaultPopup(popupHTML);popupId=popupEl.GetBubblePopupID();keypadPosition=$('#'+popupId).find('.cashback_popup_keypad_container');clickFunction=function(val){if(cashback==0)cashback="";cashback=cashback.toString()+val;$('#'+popupId).find('.cashback_popup_amount').html(cashback);};cancelFunction=function(){oldVal=$('#'+popupId).find('.cashback_popup_amount').html();newVal=oldVal.substring(0,oldVal.length-1);$('#'+popupId).find('.cashback_popup_amount').html(newVal);if(newVal=="")newVal=0;cashback=parseFloat(newVal);};$('#'+popupId).find('.cashback_popup_amount').html(cashback);setUtilKeypad(keypadPosition,clickFunction,cancelFunction);}
function saveCashback(){cashback=parseFloat(cashback);if(isNaN(cashback)){cashback=0;}
order=getCurrentOrder();order.cashback=cashback;if(selectedTable!=0){storeTableOrderInStorage(current_user_id,selectedTable,order);}else{storeOrderInStorage(current_user_id,order);}
hideCashbackPopup();if(currentScreenIsTotals()){doTotal(false);}}
function cancelCashback(){if(selectedTable==0||typeof tableOrders[selectedTable].cashback=="undefined"){cashback=0;}else{cashback=tableOrders[selectedTable].cashback;}
hideServiceChargePopup();}
function hideCashbackPopup(){hideTotalsScreenDefaultPopup();}
function presetCashbackAmountClicked(amount){cashback=amount;popupEl=$('#totals_screen_default_popup_anchor');popupId=popupEl.GetBubblePopupID();$('#'+popupId).find('.cashback_popup_amount').html(cashback);}
var floatTotal=0;function initFloatScreen(){setNavTitle("Add Float");showNavBackLinkMenuScreen();coinCounterPosition=$('#float_coin_counter_widget_container');totalFunction=function(total){floatTotal=total;};setUtilCoinCounter(coinCounterPosition,totalFunction);doCoinCounterTotal();$('#float_till_roll').html("Loading...");showFloatScreen();$.ajax({type:'GET',url:'/float_history.js'});}
function markFreeLastOrderItem(){order=getCurrentOrder();currentSelectedReceiptItemEl=getSelectedOrLastReceiptItem();if(currentSelectedReceiptItemEl){itemNumber=currentSelectedReceiptItemEl.data("item_number");applyDiscountToOrderItem(order,itemNumber,100);if(selectedTable!=0){storeTableOrderInStorage(current_user_id,selectedTable,order);}else{storeOrderInStorage(current_user_id,order);}
loadReceipt(order,true);}
currentSelectedReceiptItemEl=null;}
function changePriceLastOrderItem(){order=getCurrentOrder();currentSelectedReceiptItemEl=getSelectedOrLastReceiptItem();if(currentSelectedReceiptItemEl){var popup=doSelectReceiptItem(currentSelectedReceiptItemEl);popup.find('.price').focus().select();}}
function showAddNoteToOrderItemScreen(){order=getCurrentOrder();currentSelectedReceiptItemEl=getSelectedOrLastReceiptItem();if(currentSelectedReceiptItemEl){if(currentScreenIsMenu()){if(currentMenuSubscreenIsModifyOrderItem()){if(doSaveNote()){$('.button[id=sales_button_'+addNoteButtonID+'], .button[id=admin_screen_button_'+addNoteButtonID+']').removeClass("selected");resetKeyboard();switchToMenuItemsSubscreen();}}else{hideAllMenuSubScreens();$('#order_item_additions').show();doOpenOIANoteScreen();}}}}
function showGlobalSettingsPage(){goTo('/admin/global_settings');}
function openCashDrawer(){if(!checkForClueyPlugin()){return;}
try{cluey_ff_ext.openCashDrawer(cashDrawerComPort,cashDrawerCode);}catch(ex){setStatusMessage("Error opening cash drawer!");}}
var addTableNamePopupEl;var addTableNamePopupAnchor;function promptAddNameToTable(){if(!callHomePollInitSequenceComplete){niceAlert("Downloading data from server, please wait.");return;}
if(selectedTable==0||selectedTable==-1){setStatusMessage("Only valid for table orders!");return;}
var popupHTML=$("#name_table_popup_markup").html();addTableNamePopupAnchor=$('#receipt');if(addTableNamePopupAnchor.HasBubblePopup()){addTableNamePopupAnchor.RemoveBubblePopup();}
addTableNamePopupAnchor.CreateBubblePopup();addTableNamePopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);addTableNamePopupAnchor.FreezeBubblePopup();var popupId=addTableNamePopupAnchor.GetBubblePopupID();addTableNamePopupEl=$('#'+popupId);var tableOrder=getCurrentOrder();if(tableOrder.client_name){addTableNamePopupEl.find('input').val(tableOrder.client_name);}
addTableNamePopupEl.find('input').focus().select();$('#util_keyboard_container').slideDown(300);}
function closePromptAddNameToTable(){if(addTableNamePopupEl){hideBubblePopup(addTableNamePopupAnchor);}
$('#util_keyboard_container').slideUp(300);}
function saveAddNameToTable(){if(selectedTable==0||selectedTable==-1){closePromptAddNameToTable();return;}
var tableOrder=getCurrentOrder();tableOrder.client_name=addTableNamePopupEl.find("#table_name_input").val().toUpperCase();closePromptAddNameToTable();storeTableOrderInStorage(current_user_id,selectedTable,tableOrder);if(!currentOrderEmpty()){doAutoLoginAfterSync=true;doSyncTableOrder();}else{if(tableOrder.client_name.length>0){$('#table_label_'+selectedTable).html(tables[selectedTable].label+" ("+tableOrder.client_name+")");}}
setStatusMessage("Name added to table");}
function startSplitBillMode(){if(!appOnline){niceAlert("Server cannot be contacted. Split bill is disabled until connection re-established.");return;}
if(haveSplitBillOrder(current_user_id)){niceAlert("You must deal with the split order that is currently open. Please select it from the menu and either transfer it to a table or cash it out.");tableSelectMenu.setValue(tempSplitBillTableNum);doSelectTable(tempSplitBillTableNum);return;}
if(selectedTable==0||selectedTable==previousOrderTableNum){setStatusMessage("Only valid for table orders!");return;}
afterSplitBillSyncCallback=null;var order=getCurrentOrder();var orderSynced=true;for(var i=0;i<order.items.length;i++){if(!order.items[i].synced){orderSynced=false;break;}}
if(!orderSynced){niceAlert("All items in the order must be ordered before you can split bill. You can also delete un-ordered items.");return;}
inSplitBillMode=true;splitBillTableNumber=selectedTable;var copiedOrder={};var theCopiedOrder=$.extend(true,copiedOrder,order);splitBillOrderFrom=theCopiedOrder;splitBillOrderTo=buildInitialOrder();splitBillOrderTo.split_bill_table_num=splitBillTableNumber;showSplitBillScreen();$('#split_bill_from_receipt_header').html("Table "+selectedTable);loadSplitBillReceipts();}
function changeCourseNum(){var receiptItem=getSelectedOrLastReceiptItem();if(receiptItem){showCoursePopupFromEditDialog();}}
function exitApp(){var doIt=confirm("Are you sure?");if(doIt){window.open('','_self','');window.close();}}
function tablesButtonPressed(){if(!callHomePollInitSequenceComplete){niceAlert("Downloading data from server, please wait.");return;}
unorderedItemsPopup('doTablesButtonPressed();',true);}
function doTablesButtonPressed(){if(currentMenuItemQuantity.length>0){var tableLabelToSwitchTo=parseInt(Math.round(currentMenuItemQuantity));var tableID;if(tableLabelToSwitchTo==0){tableID=0;}else{var table=getTableForLabel(tableLabelToSwitchTo);if(table==null){setStatusMessage("Table "+tableLabelToSwitchTo+" does not exist.");currentMenuItemQuantity="";$('#menu_screen_input_show').html("");return;}
tableID=table.id;}
tableSelectMenu.setValue(tableID);doSelectTable(tableID);currentMenuItemQuantity="";$('#menu_screen_input_show').html("");}else{showTablesScreen();}}
function saveButton(){unorderedItemsPopup('doLogout();',false);}
function unorderedItemsPopup(evalCode,doAutoLogin){if(currentOrderEmpty()){eval(evalCode);return;}
var orderSynced=true;var order=getCurrentOrder();for(var i=0;i<order.items.length;i++){if(!order.items[i].synced){orderSynced=false;break;}}
if(!orderSynced&&selectedTable!=0&&selectedTable!=previousOrderTableNum&&selectedTable!=tempSplitBillTableNum){var yesCode="hideNiceAlert();doSyncTableOrder();";if(doAutoLogin){yesCode+="doAutoLoginAfterSync = true;";}
var noCode="hideNiceAlert();"+evalCode;ModalPopups.Confirm('niceAlertContainer','Items Not Ordered!',"<div id='nice_alert'>These items are not ordered. Would you like to order them?</div>",{yesButtonText:'Yes',noButtonText:'No',onYes:yesCode,onNo:noCode,width:400,height:250});}else{eval(evalCode);}}
function voidOrderItem(){var receiptItem=getSelectedOrLastReceiptItem();if(receiptItem){voidOrderItemFromEditDialog();}}
function promptVoidAllOrderItems(){if(selectedTable==0){niceAlert("You cannot void items that are not on a table");return;}
if(currentOrderEmpty()){setStatusMessage("No order present!",true,true);return;}
var order=getCurrentOrder();var allItemsSynced=true;for(var i=0;i<order.items.length;i++){var item=order.items[i];if(!item.synced){allItemsSynced=false;break;}}
if(!allItemsSynced){niceAlert("You can only void all items after they have been order. You can delete unordered items.");return;}
ModalPopups.Confirm('niceAlertContainer','Void All?',"<div id='nice_alert'>Are you sure you want to void all items and cash this order out?</div>",{yesButtonText:'Yes',noButtonText:'No',onYes:"voidAllOrderItems()",onNo:"hideNiceAlert();",width:400,height:250});}
var addCoversPopupEl;var addCoversPopupAnchor;function promptAddCovers(){if(!callHomePollInitSequenceComplete){niceAlert("Downloading data from server, please wait.");return;}
if(selectedTable==-1){setStatusMessage("Only valid for table orders!");return;}
if(currentOrder==null){currentOrder=buildInitialOrder();}
var popupHTML=$("#add_covers_popup_markup").html();addCoversPopupAnchor=$('#receipt');if(addCoversPopupAnchor.HasBubblePopup()){addCoversPopupAnchor.RemoveBubblePopup();}
addCoversPopupAnchor.CreateBubblePopup();addCoversPopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);addCoversPopupAnchor.FreezeBubblePopup();var popupId=addCoversPopupAnchor.GetBubblePopupID();addCoversPopupEl=$('#'+popupId);var tableOrder=getCurrentOrder();var covers=parseInt(tableOrder.covers);if(covers==-1){addCoversPopupEl.find('input').val("");}else{addCoversPopupEl.find('input').val(tableOrder.covers);}
addCoversPopupEl.find('input').focus().select();keypadPosition=$('#'+popupId).find('.add_covers_popup_keypad_container');clickFunction=function(val){var input=addCoversPopupEl.find('input');doKeyboardInput(input,val);};cancelFunction=function(){var input=addCoversPopupEl.find('input');doKeyboardInputCancel(input);};setUtilKeypad(keypadPosition,clickFunction,cancelFunction);registerPopupClickHandler($('#'+popupId),closePromptAddCovers);}
function closePromptAddCovers(){if(addCoversPopupEl){hideBubblePopup(addCoversPopupAnchor);}}
function saveAddCovers(){if(selectedTable==-1){closePromptAddCovers();return;}
var tableOrder=getCurrentOrder();var covers=addCoversPopupEl.find("#add_covers_input").val();covers=parseInt(covers);if(isNaN(covers)||covers<0){covers=0;}
tableOrder.covers=covers;closePromptAddCovers();if(selectedTable==0){storeTableOrderInStorage(current_user_id,selectedTable,tableOrder);}
if(!currentOrderEmpty()){if(manualCoversPrompt){doAutoLoginAfterSync=true;}
manualCoversPrompt=true;doSyncTableOrder();}}
function pmShortcut(shortcutNum){var shortcutPaymentMethod=paymentMethods[pmShortcutMap[shortcutNum]];applyDefaultServiceChargePercent();cashTendered=0;splitPayments={};paymentMethod=shortcutPaymentMethod.name;doTotalFinal();}
function toggleTrainingMode(){setTrainingMode(!inTrainingMode);}
function setTrainingMode(turnOn){inTrainingMode=turnOn;var exdays=365*100;setRawCookie(inTrainingModeCookieName,inTrainingMode,exdays);if(inTrainingMode){$('.button[id=sales_button_'+toggleTrainingModeButtonID+'], .button[id=admin_screen_button_'+toggleTrainingModeButtonID+']').addClass("selected");$('nav#main_nav').addClass("training_mode");}else{$('.button[id=sales_button_'+toggleTrainingModeButtonID+'], .button[id=admin_screen_button_'+toggleTrainingModeButtonID+']').removeClass("selected");$('nav#main_nav').removeClass("training_mode");}}
function startDeliveryMode(){initDeliveryScreen();}
function showCashOutSubscreen(){if(currentScreenIsMenu()){hideAllMenuSubScreens();$('#cash_out_subscreen').show();var cashOutPresetsHTML="<div id='presets'>";for(var i=0;i<cashOutPresets.length;i++){var nextPreset=cashOutPresets[i];cashOutPresetsHTML+="<div id='preset_"+nextPreset.id+"' class='preset' onclick='setCashOutDescription("+nextPreset.id+");'>"+nextPreset.label+"</div>";}
cashOutPresetsHTML+=clearHTML;$('#presets_container').html(cashOutPresetsHTML);toggleKeyboardEnable=false;var keyboardPlaceHolderEl=$('#cash_out_subscreen #keyboard')
var pos=keyboardPlaceHolderEl.offset();$("#util_keyboard_container").css({"position":"absolute","width":"688px","left":(pos.left)+"px","top":pos.top+"px"});hideUtilKeyboardCloseButton();$("#util_keyboard_container").show();$('#cash_out_description').focus().select();cashOutKeypadString="";inCashOutMode=true;$('#cash_out_amount').html(currency(0));}}
function swipeRightHandler(){console.log("Swipe Right");}
function swipeUpHandler(){console.log("Swipe Up");}
function swipeLeftHandler(){console.log("Swipe Left");}
function swipeDownHandler(){console.log("Swipe Down");}
var currentDeliveryItemQuantity="";var currentDelivery=null;var currentDeliveryStorageKey="current_delivery";var deliveryItemReturnMode=false;var receiveDeliveryInProcess=false;var currentSelectedDeliveryItemEl=null;var editDeliveryItemPopupAnchor=null;var sendDeliveryToServerTimeoutSeconds=120;function initDeliveryScreen(){currentDelivery=retrieveStorageJSONValue(currentDeliveryStorageKey);if(!currentDelivery){currentDelivery={'items':new Array(),'total':0,'received_date':utilFormatDate(new Date(clueyTimestamp()))};}
showDeliveryScreen();currentDeliveryItemQuantity="";$('#delivery_screen_input_show').html("");initDeliveryProductSearchKeyboard();clearDeliveryProductsSearchInput();$('#product_search_input').focus();updateDeliveryProductsSearchResults();setReturnDeliveryItem(false);redrawDeliveryReceipt();if(typeof(display_button_passcode_permissions[changeCostPriceButtonID])!='undefined'){$('#delivery_screen_change_cost_price_button').show();}else{$('#delivery_screen_change_cost_price_button').hide();}}
function resetDeliveryProductSelect(){setShortcutDropdownDefaultText();resetKeyboard();showMenuScreen();}
function initDeliveryProductSearchKeyboard(){toggleKeyboardEnable=false;var keyboardPlaceHolderEl=$('#delivery_screen_select_product_container #product_search_results_keyboard_container')
var pos=keyboardPlaceHolderEl.offset();$("#util_keyboard_container").css({"position":"absolute","width":"688px","left":(pos.left)+"px","top":pos.top+"px"});hideUtilKeyboardCloseButton();$("#util_keyboard_container").show();setUtilKeyboardCallback(function(){selectedProductSearchLetter=null;updateDeliveryProductsSearchResults();});}
function deliveryScreenKeypadClick(val){if(val=='0'){if(currentDeliveryItemQuantity.length>0)
currentDeliveryItemQuantity+=val}else{if(currentDeliveryItemQuantity.indexOf(".")!=-1){if(currentDeliveryItemQuantity.length-currentDeliveryItemQuantity.indexOf(".")>1){return;}}
currentDeliveryItemQuantity+=val;}
$('#delivery_screen_input_show').html(currentDeliveryItemQuantity);}
function deliveryScreenKeypadClickDecimal(){if(currentDeliveryItemQuantity.indexOf(".")==-1){currentDeliveryItemQuantity+=".";}
$('#delivery_screen_input_show').html(currentDeliveryItemQuantity);}
function deliveryScreenKeypadClickCancel(){currentDeliveryItemQuantity="";$('#delivery_screen_input_show').html(currentDeliveryItemQuantity);}
function clearDeliveryProductsSearchInput(){$('#product_search_input').val("");$('#product_search_input_upc').val("");$('#product_search_category_id').val(-1);selectedProductSearchLetter=null;updateDeliveryProductsSearchResults();}
function resetDeliveryProductsSelect(){setUtilKeyboardCallback(null);resetKeyboard();}
function searchCategorySelected(){$('#product_search_input_upc').val("");updateDeliveryProductsSearchResults();}
var selectedProductSearchLetter=null;function deliveryProductsSearchBoxFocused(){$('#product_search_input_upc').val("");selectedProductSearchLetter=null;updateDeliveryProductsSearchResults();updateCustomerSearchResults();$('#selection_letters .letter').removeClass("selected");}
function deliveryProductsUPCBoxFocused(){$('#product_search_input').val("");$('#product_search_category_id').val(-1);selectedProductSearchLetter=null;updateDeliveryProductsSearchResults();$('#selection_letters .letter').removeClass("selected");}
function loadAllDeliveryProducts(){selectedProductSearchLetter=null;$('#delivery_screen_select_product_container #selection_letters .letter').removeClass("selected");$('#delivery_screen_select_product_container #selection_letters #cs_button_all').addClass("selected");clearDeliveryProductsSearchInput();}
function loadSearchProductsForLetter(letter){clearDeliveryProductsSearchInput();$('#delivery_screen_select_product_container #selection_letters .letter').removeClass("selected");$('#delivery_screen_select_product_container #selection_letters #cs_button_'+letter).addClass("selected");selectedProductSearchLetter=letter;updateDeliveryProductsSearchResults();}
function updateDeliveryProductsSearchResults(){var searchStringUPC=$('#product_search_input_upc').val();var searchString=$('#product_search_input').val().toLowerCase();var productSearchCategoryId=parseInt($('#product_search_category_id').val());var results=new Array();var nextProduct=null;if(searchStringUPC.length>0){for(productId in stock_products){nextProduct=stock_products[productId];if(nextProduct.upc.toLowerCase().contains(searchStringUPC)){results.push(nextProduct);}}}else{if(selectedProductSearchLetter!=null){for(productId in stock_products){nextProduct=stock_products[productId];if(nextProduct.name.toLowerCase().startsWith(selectedProductSearchLetter)){results.push(nextProduct);}}}else{for(productId in stock_products){nextProduct=stock_products[productId];if(nextProduct.name.toLowerCase().contains(searchString)){if(productSearchCategoryId!=-1&&(nextProduct.category_id!=productSearchCategoryId)){continue;}
results.push(nextProduct);}}}}
$('#product_search_results_scroller').html("");var resultHTML="<div id='product_list'>";if(results.length>0){var alphaSort=function(a,b){return a.name.localeCompare(b.name);};results=results.sort(alphaSort);for(var i=0;i<results.length;i++){var p=results[i];var startIndex=p.name.toLowerCase().indexOf(searchString);var endIndex=startIndex+searchString.length+3;var productName=p.name;if(searchString.length>0){productName=productName.toLowerCase().splice(startIndex,0,"<b>");productName=productName.toLowerCase().splice(endIndex,0,"</b>");}
var unitString="";if(p.unit.length>0){unitString=" ("+p.unit+")";}
resultHTML+="<div onclick='addProductToDelivery("+p.id+")' class='product'>"+productName+unitString+"</div>";}}else{resultHTML+="<div id='no_results'>No Products Found!</div>";}
resultHTML+="</div>"+clearHTML;$('#product_search_results_scroller').html(resultHTML);}
function addProductToDelivery(productId){var productToCopy=products[productId];var copiedProduct={};var product=$.extend(true,copiedProduct,productToCopy);if(currentDeliveryItemQuantity==""||currentDeliveryItemQuantity=="0")
currentDeliveryItemQuantity="1";if(currentDeliveryItemQuantity.indexOf(".")!=-1){if(currentDeliveryItemQuantity.length-currentDeliveryItemQuantity.indexOf(".")==1){currentDeliveryItemQuantity="1";}}
var isReturn=false;var deliveryItemQuantity=parseFloat(currentDeliveryItemQuantity);if(deliveryItemReturnMode){deliveryItemQuantity*=-1;isReturn=true;setReturnDeliveryItem(false);}
var deliveryItem={'product':product,'amount':deliveryItemQuantity,'is_return':isReturn,'note':""}
currentDeliveryItemQuantity="";$('#delivery_screen_input_show').html("");currentDelivery.items.push(deliveryItem);calculateDeliveryTotal();storeDelivery();redrawDeliveryReceipt();}
function redrawDeliveryReceipt(){var deliveryTillRollHTML=getDeliveryTillRollHTML(false);$('#delivery_till_roll').html(deliveryTillRollHTML);deliveryRecptScroll();$('#delivery_screen_sub_total_value').html(currency(currentDelivery.total));}
function getDeliveryTillRollHTML(includeHeading,includeTotal){if(typeof includeHeading=="undefined"){includeHeading=false;}
if(typeof includeTotal=="undefined"){includeTotal=false;}
var deliveryTillRollHTML="<div class='delivery_till_roll'>";if(includeHeading){deliveryTillRollHTML+=fetchBusinessInfoHeaderHTML()+clearHTML;deliveryTillRollHTML+="<div class='delivery_till_roll_heading'>Delivery Received</div>"+clearHTML;}
deliveryTillRollHTML+="<div class='delivery_till_roll_header'>";if(currentDelivery.reference_number&&currentDelivery.reference_number.length>0){deliveryTillRollHTML+="<div class='reference_number'>REF#: "+currentDelivery.reference_number+"</div>"+clearHTML;}
deliveryTillRollHTML+="<div class='nickname'>"+current_user_nickname+"</div>";var timestamp=currentDelivery.received_date;deliveryTillRollHTML+="<div class='timestamp'>"+timestamp+"</div>"+clearHTML;deliveryTillRollHTML+="<div class='amount_header'>Qty</div>";deliveryTillRollHTML+="<div class='product_header'>Product</div>";deliveryTillRollHTML+="<div class='cost_header'>Cost</div>";deliveryTillRollHTML+="</div>"+clearHTML;deliveryTillRollHTML+=getAllDeliveryItemsReceiptHTML();if(includeTotal){deliveryTillRollHTML+="<div class='total_label'>Total</div><div class='total_value'>"+currency(currentDelivery.total)+"</div>"+clearHTML;}
deliveryTillRollHTML+="</div>"+clearHTML;return deliveryTillRollHTML;}
function getAllDeliveryItemsReceiptHTML(){var allDeliveryItemsReceiptHTML="";var deliveryItemNumber;for(var i=0;i<currentDelivery.items.length;i++){var item=currentDelivery.items[i];deliveryItemNumber=i+1;allDeliveryItemsReceiptHTML+=getDeliveryItemReceiptHTML(item,deliveryItemNumber);}
return allDeliveryItemsReceiptHTML;}
function getDeliveryItemReceiptHTML(deliveryItem,deliveryItemNumber){var returnItemClass="";var returnItemHTML="";if(deliveryItem.is_return){returnItemClass="return";returnItemHTML="<div class='return_word'>Return</div>"+clearHTML;}
deliveryItemHTML="<div class='delivery_line "+returnItemClass+"' data-delivery_item_number='"+deliveryItemNumber+"' onclick='deliveryReceiptItemSelected(this)'>"+returnItemHTML;deliveryItemHTML+="<div class='amount'>"+deliveryItem.amount+"</div>";var unitString="";if(deliveryItem.product.unit.length>0){unitString=" ("+deliveryItem.product.unit+")";}
deliveryItemHTML+="<div class='product_name'>"+deliveryItem.product.name+unitString+"</div>";var costPrice="";if(deliveryItem.product.cost_price>0){costPrice=currency(deliveryItem.product.cost_price*deliveryItem.amount,false);}
deliveryItemHTML+="<div class='cost_price'>"+costPrice+"</div>"+clearHTML;deliveryItemHTML+="</div>"+clearHTML;if(deliveryItem.note.length>0){deliveryItemHTML+="<div class='note'>"+deliveryItem.note+"</div>"+clearHTML;}
return deliveryItemHTML;}
function storeDelivery(){storeKeyJSONValue(currentDeliveryStorageKey,currentDelivery);}
function showFinishDeliverySubScreen(){if(currentDelivery.items.length==0){niceAlert("No Delivery Items Present!");return;}
$('#delivery_screen_select_product_container').hide();$('#finish_delivery_subscreen').show();$('#delivery_date_cal').datetimepicker({dateFormat:'dd-mm-yy',defaultDate:'01/01/01',timeFormat:'hh:mm',addSliderAccess:true,maxDate:0,sliderAccessArgs:{touchonly:false}});$('#delivery_date_cal').datetimepicker("setDate",new Date());$('#delivery_reference_number_input').focus();}
function cancelFinishDeliverySubScreen(){$('#delivery_reference_number_input').val("");$('#delivery_date_cal').val("");$('#delivery_screen_select_product_container').show();$('#finish_delivery_subscreen').hide();}
function promptFinishDelivery(){ModalPopups.Confirm('niceAlertContainer','Cancel Delivery',"<div id='nice_alert'>Are you sure you want to finish this delivery?</div>",{yesButtonText:'Yes',noButtonText:'No',onYes:"doFinishDelivery()",onNo:"hideNiceAlert();",width:400,height:250});}
function doFinishDelivery(){if(receiveDeliveryInProcess){niceAlert("Processing, please wait!");return;}
receiveDeliveryInProcess=true;showLoadingDiv("Processing...");var timeoutMillis=sendDeliveryToServerTimeoutSeconds*1000;currentDelivery.employee_id=current_user_id;currentDelivery.reference_number=$('#delivery_reference_number_input').val();currentDelivery.received_date=$('#delivery_date_cal').val();storeDelivery();$.ajax({type:'POST',url:'/delivery',timeout:timeoutMillis,error:function(x,t,m){hideLoadingDiv();if(t==="timeout"){niceAlert("Processing the delivery has timed out. Please check in Reports if the delivery was recorded before retrying.");}else{niceAlert("Error finishing delivery!");}},success:function(){deliverySentToServerCallback();},data:{delivery:currentDelivery}});}
function deliverySentToServerCallback(){var deliveryReceiptContent=getDeliveryTillRollHTML(true,true);if(printLocalDeliveryReceipts){printLocalReceipt(deliveryReceiptContent,false);}else{printReceipt(deliveryReceiptContent,false);}
$('#delivery_reference_number_input').val("");$('#delivery_date_cal').val("");$('#delivery_screen_select_product_container').show();$('#finish_delivery_subscreen').hide();currentDelivery=null;storeDelivery();$('#delivery_till_roll').html("");resetDeliveryProductSelect();niceAlert("Delivery Complete!");receiveDeliveryInProcess=false;requestReload();}
function promptCancelDelivery(){ModalPopups.Confirm('niceAlertContainer','Cancel Delivery',"<div id='nice_alert'>Are you sure you want to cancel and clear this delivery?</div>",{yesButtonText:'Yes',noButtonText:'No',onYes:"doCancelDelivery()",onNo:"hideNiceAlert();",width:400,height:250});}
function doCancelDelivery(){currentDelivery=null;storeDelivery();resetDeliveryProductSelect();niceAlert("Delivery Canceled!");}
function deleteLastDeliveryItem(){if(currentDelivery.items.length==0){niceAlert("No Delivery Items Present!");return;}
currentDelivery.items.pop();calculateDeliveryTotal()
storeDelivery();redrawDeliveryReceipt();}
function calculateDeliveryTotal(){var total=0;for(var i=0;i<currentDelivery.items.length;i++){item=currentDelivery.items[i];total+=(item.product.cost_price*item.amount);}
currentDelivery.total=total;}
function toggleReturnDeliveryItem(){setReturnDeliveryItem(!deliveryItemReturnMode);}
function setReturnDeliveryItem(turnOn){if(turnOn){deliveryItemReturnMode=true;$('.button[id=return_delivery_item_toggle_button]').addClass("selected");}else{deliveryItemReturnMode=false;$('.button[id=return_delivery_item_toggle_button]').removeClass("selected");}}
var changeDeliveryItemCostPricePopupEl;var changeDeliveryItemCostPricePopupAnchor;function promptChangeDeliveryItemCostPrice(){if(currentDelivery.items.length==0){niceAlert("No Delivery Items Present!");return;}
var popupHTML=$("#delivery_cost_price_popup_markup").html();changeDeliveryItemCostPricePopupAnchor=$('#delivery_receipt');if(changeDeliveryItemCostPricePopupAnchor.HasBubblePopup()){changeDeliveryItemCostPricePopupAnchor.RemoveBubblePopup();}
changeDeliveryItemCostPricePopupAnchor.CreateBubblePopup();changeDeliveryItemCostPricePopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);changeDeliveryItemCostPricePopupAnchor.FreezeBubblePopup();var popupId=changeDeliveryItemCostPricePopupAnchor.GetBubblePopupID();changeDeliveryItemCostPricePopupEl=$('#'+popupId);var lastItem=currentDelivery.items[currentDelivery.items.length-1];var product=lastItem.product;var costPrice=product.cost_price;changeDeliveryItemCostPricePopupEl.find('input').val(costPrice);changeDeliveryItemCostPricePopupEl.find('input').focus().select();keypadPosition=$('#'+popupId).find('.delivery_cost_price_popup_keypad_container');clickFunction=function(val){var input=changeDeliveryItemCostPricePopupEl.find('input');doKeyboardInput(input,val);};cancelFunction=function(){var input=changeDeliveryItemCostPricePopupEl.find('input');doKeyboardInputCancel(input);};setUtilKeypad(keypadPosition,clickFunction,cancelFunction);registerPopupClickHandler($('#'+popupId),closePromptChangeDeliveryItemCostPrice);}
function closePromptChangeDeliveryItemCostPrice(){if(changeDeliveryItemCostPricePopupEl){hideBubblePopup(changeDeliveryItemCostPricePopupAnchor);}}
function saveChangeDeliveryItemCostPrice(){closePromptChangeDeliveryItemCostPrice();var newCostPrice=changeDeliveryItemCostPricePopupEl.find("input").val();newCostPrice=parseFloat(newCostPrice);if(isNaN(newCostPrice)||newCostPrice<0){newCostPrice=0;}
var lastItem=currentDelivery.items[currentDelivery.items.length-1];lastItem.product.cost_price=newCostPrice;products[lastItem.product.id].cost_price=newCostPrice;for(var i=0;i<currentDelivery.items.length;i++){item=currentDelivery.items[i];if(item.product.id==lastItem.product.id){item.product.cost_price=newCostPrice;}}
$.ajax({url:'/update_cost_price',type:"POST",data:{product_id:lastItem.product.id,new_cost_price:newCostPrice}});calculateDeliveryTotal();storeDelivery();redrawDeliveryReceipt();}
var addDeliveryItemNotePopupEl;var addDeliveryItemNotePopupAnchor;function promptAddDeliveryItemNote(){if(currentDelivery.items.length==0){niceAlert("No Delivery Items Present!");return;}
var popupHTML=$("#delivery_note_popup_markup").html();addDeliveryItemNotePopupAnchor=$('#delivery_receipt');if(addDeliveryItemNotePopupAnchor.HasBubblePopup()){addDeliveryItemNotePopupAnchor.RemoveBubblePopup();}
addDeliveryItemNotePopupAnchor.CreateBubblePopup();addDeliveryItemNotePopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);addDeliveryItemNotePopupAnchor.FreezeBubblePopup();var popupId=addDeliveryItemNotePopupAnchor.GetBubblePopupID();addDeliveryItemNotePopupEl=$('#'+popupId);var lastItem=currentDelivery.items[currentDelivery.items.length-1];var itemNote=lastItem.note;addDeliveryItemNotePopupEl.find('textarea').val(itemNote);addDeliveryItemNotePopupEl.find('textarea').focus().select();registerPopupClickHandler($('#'+popupId).add('#util_keyboard_container'),closePromptAddDeliveryItemNote);}
function closePromptAddDeliveryItemNote(){if(addDeliveryItemNotePopupEl){hideBubblePopup(addDeliveryItemNotePopupAnchor);}}
function saveAddDeliveryItemNote(){closePromptAddDeliveryItemNote();var newNote=addDeliveryItemNotePopupEl.find("textarea").val();var lastItem=currentDelivery.items[currentDelivery.items.length-1];lastItem.note=newNote;storeDelivery();redrawDeliveryReceipt();}
function deliveryReceiptItemSelected(deliveryItemEl){closeEditDeliveryItem();currentSelectedDeliveryItemEl=$(deliveryItemEl);currentSelectedDeliveryItemEl.addClass("selected");editDeliveryItemPopupAnchor=$('#delivery_receipt');if(editDeliveryItemPopupAnchor.HasBubblePopup()){editDeliveryItemPopupAnchor.RemoveBubblePopup();}
editDeliveryItemPopupAnchor.CreateBubblePopup();var popupHTML=$("#edit_delivery_item_popup_markup").html();editDeliveryItemPopupAnchor.ShowBubblePopup({position:'right',align:'top',tail:{align:'middle'},innerHtml:popupHTML,innerHtmlStyle:{'text-align':'left'},themeName:'all-grey',themePath:'/images/jquerybubblepopup-theme',alwaysVisible:false},false);editDeliveryItemPopupAnchor.FreezeBubblePopup();var popupId=editDeliveryItemPopupAnchor.GetBubblePopupID();var currentQuantity=currentSelectedDeliveryItemEl.children('.amount').html();$('#'+popupId).find('.quantity').val(currentQuantity);$('#'+popupId).find('.quantity').focus().select();var keypadPosition=$('#'+popupId).find('.edit_delivery_item_popup_keypad_container');var clickFunction=function(val){doKeyboardInput(lastActiveElement,val);};var cancelFunction=function(){doKeyboardInputCancel(lastActiveElement);};setUtilKeypad(keypadPosition,clickFunction,cancelFunction);registerPopupClickHandler($('#'+popupId),closeEditDeliveryItem);return $('#'+popupId);}
function saveEditDeliveryItem(){var popupId=editDeliveryItemPopupAnchor.GetBubblePopupID();var targetInputQuantityEl=$('#'+popupId).find('.quantity');var newQuantity=parseFloat(targetInputQuantityEl.val());if(isNaN(newQuantity)||newQuantity==0){newQuantity=1;}
var deliveryItemNumber=currentSelectedDeliveryItemEl.data("delivery_item_number");var deliveryItem=currentDelivery.items[deliveryItemNumber-1];deliveryItem.amount=newQuantity;storeDelivery();redrawDeliveryReceipt();closeEditDeliveryItem();}
function closeEditDeliveryItem(){if(currentSelectedDeliveryItemEl){hideBubblePopup(editDeliveryItemPopupAnchor);currentSelectedDeliveryItemEl.removeClass("selected");currentSelectedDeliveryItemEl=null;}}
function removeSelectedDeliveryItem(){if(!currentSelectedDeliveryItemEl){return;}
var deliveryItemNumber=currentSelectedDeliveryItemEl.data("delivery_item_number");currentDelivery.items.splice(deliveryItemNumber-1,1);storeDelivery();currentSelectedDeliveryItemEl.hide();redrawDeliveryReceipt();closeEditDeliveryItem();}